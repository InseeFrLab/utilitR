# Configurer git sur son poste de travail

## Tâches concernées et recommandations

L'utilisateur souhaite versionner son code depuis son poste de travail, en ayant recours pour cela à un dépôt distant (l'utilisation du logiciel Git en local relève de l'usage habituel du logiciel), et de manière générale réaliser les manoeuvres décrites dans la fiche "Utiliser Git avec RStudio").

::: {.recommandation data-latex=""}
* Pour interagir avec un dépôt Git distant, l'utilisateur a le choix entre deux protocoles de connexion, `SSH` ou `https`
* Malgré de forts arguments en matière d'ergonomie une fois configuré, le protocole `SSH` est déconseillé en faveur du protocole `HTTPS` (qui ne requiert que de configurer un mot de passe sur le dépôt distant)
:::

## Les différents dépôts distants possibles

On en distingue principalement deux :
* Github (accessible sur le Web, à l'adresse [https://github.com]) ;
* Gitlab qui se décline pour l'utilisateur sous différentes formes
Gitlab étant la solution la plus déclinée, on prendra comme cas d'usage l'utilisation d'un dépôt distant sur une solution de type Gitlab. Néanmoins, la procédure pour configurer l'interaction avec un dépôt sur Github est très similaire.

## Installer Git sur son poste de travail

Pour installer Git, il suffit désormais d'installer le logiciel récupéré sur le [site web officiel](http://git-scm.com/download/win). Une fois le logiciel installé, il est possible de le retrouver dans le menu Démarrer, rubrique Git. L'utilisateur y trouvera plusieurs outils, dont un outil de ligne de commande (`Git Bash`) et une interface (`Git GUI`).

## Clôner et interagir avec un dépôt distant en `HTTPS`

Pour interagir avec un dépôt distant en utilisant le protocole `HTTPS`, il suffit de configurer le mot de passe dans Gitlab, en allant dans Preferences > Password, comme indiqué dans la capture d'écran ci-dessous :

```{r, echo = FALSE, out.width = '100%'}
utilitr::include_image("./pics/config_git/password_conf.png", compression = FALSE)
```

Une fois le mot de passe configuré, il ne reste plus qu'à clôner le dépôt distant sur lequel on veut travailler, par exemple depuis RStudio, suivant le protocole décrit dans la fiche "Utiliser Git avec RStudio", en ayant pris soin de sélectionner l'url correspondant au protocole `HTTPS`, comme ci-dessous :

```{r, echo = FALSE, out.width = '100%'}
utilitr::include_image("./pics/config_git/clone_https.png", compression = FALSE)
```

Au moment du clônage, l'utilisateur est invité à entrer son identifiant (celui de son profil Gitlab avec lequel il accède au dépôt distant), ainsi que son mot de passe (celui qu'il aura donc spécifié dans son compte Gitlab).

::: {.conseil data-latex=""}
Selon le niveau de visibilité fixé par le propriétaire du dépôt distant, il est possible qu'il ne soit pas nécessaire de s'identifier au moment du clônage (c'est le cas pour les dépôts publics). En revanche, si le niveau de visibilité du dépôt est plus élevé (niveau privé), il se peut qu'il soit impossible à l'utilisateur de clôner le dépôt ; dans ce cas, il ne lui sera pas non plus possible de visualiser ce dernier dans Gitlab. Il faut alors contacter le propriétaire du dépôt pour lui en demander l'accès.
:::

## Clôner et interagir avec un dépôt distant en `SSH`

Pour interagir avec un dépôt distant en utilisant le protocole `SSH`, il faut créer une clé SSH, plus exactement une paire de chaînes de caractères, qui va permettre une authentification automatique auprès du dépôt distant. La version publique de la paire de clés est connue du dépôt distant ; la version privée reste quant à elle la propriété seule et unique de l'utilisateur. C'est l'association par un logiciel de cryptographie de ces deux versions qui permet l'authentification de l'utilisateur.

### Générer une clé SSH

Un utilisateur peut générer autant de clés SSH que bon lui semble, selon qu'il utilise plusieurs systèmes par exemple.

Pour générer une clé SSH, le plus simple est d'utiliser Git Bash de la façon suivante :

```{r, echo = FALSE, out.width = '100%'}
utilitr::include_image("./pics/config_git/ssh_keygen.png", compression = FALSE)
```

La clé est générée sur le chemin spécifié et sera constituée de deux fichiers texte :
- un fichier en .pub, qui fournit la partie publique de la clé, et qui a vocation à être diffusée (donc c'est ce fichier qu'on chargera sur Gitlab pour permettre l'authentification) ;
- un fichier .ppk (comme Private Key) qui est la partie privée de la clé, et qui ne doit en aucun cas être diffusée.

La version privée de la clé doit être localisé dans un dossier caché que Git va automatiquement utiliser (en général un dossier `.ssh` localisé sur un dossier personnel).

### Ajout de la clé SSH sous Gitlab

Pour copier la partie publique de la clé sous Gitlab, il faut aller dans la partie Settings de l'espace personnel sous Gitlab, puis sélectionner "SSH Keys" sur le bandeau latéral gauche. On se trouve face à une fenêtre de texte comme ceci :

```{r, echo = FALSE, out.width = '100%'}
utilitr::include_image("./pics/config_git/ssh_key_record.png", compression = FALSE)
```

dans laquelle on doit copier-coller le texte que l'on trouve dans le fichier .pub de la clé SSH (en prenant soin d'éliminer l'éventuel texte en fin du type "imported-openssh-key").

Gitlab est désormais configuré, et il est alors possible de faire dialoguer Git et Gitlab. L'utilisateur pourra également consulter la [documentation de la plateforme Innovation](http://innovation.pages.innovation.insee.eu/documentation-plateforme-innovation/gitlab/clef-ssh/), qui détaille la procédure pour l'ajout de la clé SSH.

::: {.conseil data-latex=""}
L'option SSH ne fonctionne pas dans le Gitlab du SSP Cloud. Seul l'authentification en `HTTPS` est possible.
:::

