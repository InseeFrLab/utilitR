# Configurer git sur son poste de travail

## Tâches concernées et recommandations

L'utilisateur souhaite versionner son code depuis son poste de travail, en ayant recours pour cela à un dépôt distant (l'utilisation du logiciel Git en local relève de l'usage habituel du logiciel), et de manière générale réaliser les manoeuvres décrites dans la fiche "Utiliser Git avec RStudio").

::: {.recommandation data-latex=""}
* Pour interagir avec un dépôt Git distant, l'utilisateur a le choix entre deux protocoles de connexion, `SSH` ou `https`
* Malgré de forts arguments en matière d'ergonomie une fois configuré, le protocole `SSH` est déconseillé en faveur du protocole `HTTPS` (qui ne requiert que de configurer un mot de passe sur le dépôt distant)
:::

## Les différents dépôts distants possibles

On en distingue principalement deux :
* Github (accessible sur le Web, à l'adresse [https://github.com]) ;
* Gitlab qui se décline pour l'utilisateur sous différentes formes
Gitlab étant la solution la plus déclinée, on prendra comme cas d'usage l'utilisation d'un dépôt distant sur une solution de type Gitlab. Néanmoins, la procédure pour configurer l'interaction avec un dépôt sur Github est très similaire.

## Installer Git sur son poste de travail

Pour installer Git, il suffit désormais d'installer le logiciel récupéré sur le [site web officiel](http://git-scm.com/download/win). Une fois le logiciel installé, il est possible de le retrouver dans le menu Démarrer, rubrique Git. L'utilisateur y trouvera plusieurs outils, dont un outil de ligne de commande (`Git Bash`) et une interface (`Git GUI`).

## Clôner et interagir avec un dépôt distant en `HTTPS`

Pour interagir avec un dépôt distant en utilisant le protocole `HTTPS`, il suffit de configurer le mot de passe dans Gitlab, en allant dans Preferences > Password, comme indiqué dans la capture d'écran ci-dessous :

```{r, echo = FALSE, out.width = '100%'}
utilitr::include_image("./pics/config_git/password_conf.png", compression = FALSE)
```

Une fois le mot de passe configuré, il ne reste plus qu'à clôner le dépôt distant sur lequel on veut travailler, par exemple depuis RStudio, suivant le protocole décrit dans la fiche "Utiliser Git avec RStudio", en ayant pris soin de sélectionner l'url correspondant au protocole `HTTPS`, comme ci-dessous :

```{r, echo = FALSE, out.width = '100%'}
utilitr::include_image("./pics/config_git/clone_https.png", compression = FALSE)
```

Au moment du clônage, l'utilisateur est invité à entrer son identifiant (celui de son profil Gitlab avec lequel il accède au dépôt distant), ainsi que son mot de passe (celui qu'il aura donc spécifié dans son compte Gitlab).

::: {.conseil data-latex=""}
Selon le niveau de visibilité fixé par le propriétaire du dépôt distant, il est possible qu'il ne soit pas nécessaire de s'identifier au moment du clônage (c'est le cas pour les dépôts publics). En revanche, si le niveau de visibilité du dépôt est plus élevé (niveau privé), il se peut qu'il soit impossible à l'utilisateur de clôner le dépôt ; dans ce cas, il ne lui sera pas non plus possible de visualiser ce dernier dans Gitlab. Il faut alors contacter le propriétaire du dépôt pour lui en demander l'accès.
:::

## Clôner et interagir avec un dépôt distant en `SSH`

### Générer une clé SSH

Faire dialoguer Git et Gitlab suppose que l'outil Git effectue le même processus d'authentification que celui décrit précédemment. Ce processus est intégré dans l'outil grâce à l'utilisation d'un fichier propre à chaque utilisateur, qui constitue une sorte de signature numérique, la clé SSH. Un utilisateur peut générer autant de clés SSH que bon lui semble, selon qu'il utilise plusieurs systèmes par exemple.

Pour générer une clé SSH, il faut aller dans le menu Démarrer de Windows > Tous les programmes > INSEE atelier de développement V2 > installation utilisateur > Paramétrage SSH :
![ssh_keygen](uploads/2a0d24c7624aa77ecb535289df105419/ssh_keygen.png)

On sélectionne ensuite "Générer une nouvelle clé" si l'on veut créer une nouvelle clé ; cette clé sera créée et sauvegardée en général dans le chemin suivant : D:/idep/Données d'application/.ssh, et sera constituée de deux fichiers texte :
- un fichier en .pub, qui fournit la partie publique de la clé, et qui a vocation à être diffusée (donc c'est ce fichier qu'on chargera sur Gitlab pour permettre l'authentification) ;
- un fichier .ppk (comme Private Key) qui est la partie privée de la clé, et qui ne doit en aucun cas être diffusée.

L'outil propose ensuite de télécharger la partie publique de la clé sur un dépôt distant à spécifier ; cela ne fonctionne malheureusement pas avec Gitlab et il faudra le faire manuellement (on verra comment après).

Enfin, l'outil propose de configurer l'utilitaire putty (que Git utilise pour générer une connexion sécurisée entre le dépôt distant et le dépôt local) ; il faudra renseigner les éléments suivants :
- Identifiant : idep de l'utilisateur
- Hôte : gitlab.stable.innovation.insee.eu
- Port : 22222

Il faut ensuite charger la clé dans le cache de putty ; pour cela, il faut ouvrir putty (dans Menu Démarrer > Tous les programmes > INSEE atelier de développement V2 > utilitaire > putty), sélectionner "gitlab.stable.innvation.insee.eu", "Load", "Open". Le système renvoie une erreur, mais la clé est normalement chargée dans le cache, il reste à configurer Gitlab pour que ce dernier reconnaisse la clé SSH comme étant celle de l'utilisateur.

Ces éléments sont également décrits [ici](https://git.stable.innovation.insee.eu/animation-ateliers-r-dsds/formation-git#2-d%C3%A9p%C3%B4ts-distants). En particulier, pour tout problème lié à la clé SSH, il est possible de consulter [cette page](https://git.stable.innovation.insee.eu/outils-transverses/migration-svn-git#-ajouter-une-clef-ssh-dans-gitlab).

### Ajout de la clé SSH sous Gitlab

Pour copier la partie publique de la clé sous Gitlab, il faut aller dans la partie Réglages de l'espace personnel :
![setting_ssh](uploads/9207abfbdf80d5e3092c5d4f989b8ff6/setting_ssh.png)

puis sélectionner "SSH Keys" sur le bandeau latéral gauche. On se trouve face à une fenêtre de texte comme ceci :
![ssh_copy_key](uploads/9c3b7c9d85d81893faf6629bbfdb2ca8/ssh_copy_key.png)

dans laquelle on doit copier-coller le texte que l'on trouve dans le fichier .pub de la clé SSH (en prenant soin d'éliminer l'éventuel texte en fin du type "imported-openssh-key".

Gitlab est désormais configuré, et il est alors possible de faire dialoguer Git et Gitlab. L'utilisateur pourra également consulter la [documentation de la plateforme Innovation](http://innovation.pages.innovation.insee.eu/documentation-plateforme-innovation/gitlab/clef-ssh/), qui détaille la procédure pour l'ajout de la clé SSH.