# Configurer git sur son poste de travail {#git-config}

## Tâches concernées et recommandations

L'utilisateur souhaite versionner son projet depuis son poste de travail en ayant recours pour cela à un dépôt distant, disponible sur un espace type `Gitlab` ou `Github`. 

L'utilisation du logiciel `Git` en local, qui relève plutôt de l'usage habituel du logiciel, est reportée dans une fiche dédiée ([Utiliser Git avec RStudio](#git)). 

::: recommandation
* Pour interagir avec un dépôt `Git` distant, l'utilisateur a le choix
entre deux protocoles de connexion, `SSH` ou `HTTPS`: 
* Le
protocole `SSH` est déconseillé en faveur du protocole `HTTPS` (qui ne requiert
que de configurer un mot de passe sur le dépôt distant) ;
* Plutôt qu'utiliser un mot de passe pour s'authentifier en `HTTPS`, il est
recommandé de s'authentifier avec des jetons personnels d'accès
(*personnel access tokens*).
:::

## Les différents dépôts distants possibles

On en distingue principalement deux :

* Github (accessible sur le Web, à l'adresse [https://github.com]) ;
* Gitlab qui se décline sous différentes formes :
    + une version publique, disponible sur [https://gitlab.com], qui propose les fonctionalités principales de versionage du code mais également des fonctionalités supplémentaires (discussions, mise à disposition de machines (*runners*) pour tester des scripts...) ;
    + des versions internes, qui reprennent la majorité des fonctionalités de la 
version publique mais proposent des machines (appelées *runners*) internes. Celles-ci ne sont pas forcément ouvertes sur internet.   

Ces dépôts distants, également appelés `r with_def("forge")`, proposent des fonctionalités précieuses pour la gestion d'un projet impliquant du code ou de la documentation. La formation
[Travail collaboratif avec R](https://linogaliana.gitlab.io/collaboratif/git.html) évoque de manière plus extensive les fonctionalités.

::: specificite

Une instance interne `Gitlab` est disponible sous AUS. Son adresse, ainsi que des éléments complémentaires à cette fiche, sont disponibles dans la documentation AUS (`Y:/Documentation/AUSV3/`)

:::

::: remarque

Une instance `Gitlab` est disponible sur le SSP-cloud [https://git.lab.sspcloud.fr/] avec laquelle peut interagir un service `RStudio` [lien vers fiche quand elle sera là] . Cependant, cette plateforme étant connectée à Internet, elle a également accès aux dépôts sur  [https://gitlab.com] ou [https://github.com] dont la pérennité est mieux assurée. Il est ainsi conseillé de privilégier ces deux `r with_def("forge")` plutôt que <https://git.lab.sspcloud.fr/>

:::


On prendra ici comme cas
d'usage l'utilisation d'un dépôt distant sur une solution de type
`Gitlab`. Néanmoins, la procédure pour configurer l'interaction avec un
dépôt sur `Github` est très similaire, ce qui est illustré
dans la fiche [Utiliser Git avec RStudio](#git).

## Installer Git sur son poste de travail {#git-install}

Pour intéragir avec un dépôt distant sur `Gitlab` ou `Github`, il est nécessaire
d'utiliser un outil de contrôle de version. Le plus utilisé est le logiciel `Git`.

Avant d'essayer d'installer `Git`, le premier réflexe est de vérifier
qu'il n'est pas déjà disponible... 
Sur un serveur partagé comme AUS, ou sur une architecture comme le SSP-cloud,
il n'est pas nécessaire d'installer `Git` puisque celui-ci est déjà disponible
et configuré.

Si `Git` n'est pas disponible, pour l'installer, il suffit
d'installer le logiciel récupéré sur le
[site web officiel](http://git-scm.com/download/win). Une fois le logiciel
installé, il est possible de le retrouver dans le menu Démarrer, rubrique Git.
L'utilisateur y trouvera plusieurs outils, dont un outil de ligne
de commande (`Git Bash`) et une interface (`Git GUI`). 

## Interaction avec un dépôt distant: principe

`Git` est un système décentralisé de contrôle de version: les fichiers sont
modifiés sur les postes de travail et sont mis, à un moment voulu, en 
conformité avec la version collective disponible sur le dépôt distant. 

Il est ainsi nécessaire d'avoir une identité pour reconnaître l'auteur d'une 
modification à un moment donné. Pour que `Gitlab` reconnaisse un utilisateur
suggérant des modifications, il est nécessaire de s'authentifier 
(un dépôt, même public, ne peut pas être modifié par n'importe qui). 
L'authentification consiste ainsi à fournir un élément que seul vous et 
la forge sont censés connaître: un mot de passe, une clé compliquée, un jeton d'accès...

Plus précisément, il existe deux modalités pour faire connaître son identité à `Gitlab`:

* une authentification HTTPS ([décrite ici](git-connexion-https)): l'authentification se fait grâce au login et au mot de passe à chaque
interaction avec le dépôt. Les jetons d'accès sont à privilégier: ils permettent de s'authentifier, sont révocables et ne bénéficient pas des super-pouvoirs qu'octroie un mot de passe comme changer le nom d'un dépôt voire le supprimer. Plus d'éléments sont disponibles [ici](https://happygitwithr.com/credential-caching.html#get-a-pat)
* une authentification SSH: l'authentification se fait par une clé cryptée disponible sur le poste de travail et que `Github` ou `Gitlab` connaît. Une fois configurée, cette méthode ne nécessite plus de faire connaître son identité: l'empreinte digitale que constitue la clé suffit à reconnaître un utilisateur. 

::: remarque
Ne jamais stocker un token, et encore moins son mot de passe, dans un projet. Un token peut être stocké dans un système de gestion de mot de passe comme [keepass](https://keepass.fr/)
:::

La méthode SSH peut être laborieuse à mettre en place même si elle donne un 
confort supplémentaire (ne pas avoir à taper login et mot de passe à chaque interaction). Cependant, la méthode HTTPS est préférable car

* elle n'implique pas de configuration ;
* elle n'est pas bloquée par des pare-feux, contrairement à la méthode SSH. Par exemple, il est impossible sur un poste Insee d'interagir avec un dépôt sur <gitlab.com> ou <github.com> en SSH ;
* il est possible de conserver en mémoire ses identifiants un certain temps (grâce au `git credentials helper`) pour ne pas taper à chaque fois ses identifiants.


## Clôner et interagir avec un dépôt distant en `HTTPS` {#git-connexion-https}

### Démarche générale

Pour interagir avec un dépôt distant en utilisant le protocole `HTTPS`, il suffit de configurer le mot de passe dans `Gitlab`, en allant dans `Preferences > Password`, comme indiqué dans la capture d'écran ci-dessous :

```{r, echo = FALSE, out.width = '100%'}
utilitr::include_image("./pics/config_git/password_conf.png", compression = FALSE)
```

Une fois le mot de passe configuré, il ne reste plus
qu'à `r with_def("cloner")` le dépôt distant sur lequel on veut travailler,
par exemple depuis `RStudio`, suivant le protocole décrit dans la fiche [Utiliser Git avec RStudio](#git), en ayant pris soin de sélectionner l'URL correspondant
au protocole `HTTPS`, comme ci-dessous :

```{r, echo = FALSE, out.width = '100%'}
utilitr::include_image("./pics/config_git/clone_https.png", compression = FALSE)
```

Au moment du clônage, l'utilisateur est invité à entrer son identifiant
(celui de son profil Gitlab avec lequel il accède au dépôt distant), ainsi que
son mot de passe (celui qu'il aura donc spécifié dans son compte Gitlab).

::: conseil
Selon le niveau de visibilité fixé par le propriétaire du dépôt distant, il est possible qu'il ne soit pas nécessaire de s'identifier au moment du clônage (c'est le cas pour les dépôts publics). En revanche, si le niveau de visibilité du dépôt est plus élevé (niveau privé), il se peut qu'il soit impossible à l'utilisateur de clôner le dépôt ; dans ce cas, il ne lui sera pas non plus possible de visualiser ce dernier dans Gitlab. Il faut alors contacter le propriétaire du dépôt pour lui en demander l'accès.
:::

### Définir un jeton d'accès

TO DO

### Garder en mémoire (*cache*) ses identifiants

TO DO


## Clôner et interagir avec un dépôt distant en `SSH`

Pour interagir avec un dépôt distant en utilisant le protocole `SSH`,
il faut créer une clé SSH, plus exactement une paire de chaînes de caractères,
qui va permettre une authentification automatique auprès du dépôt distant.
La version publique de la paire de clés est connue du dépôt distant ; la
version privée reste quant à elle la propriété seule et unique de
l'utilisateur. C'est l'association par un logiciel de cryptographie
de ces deux versions qui permet l'authentification de l'utilisateur.

### Générer une clé SSH

Un utilisateur peut générer autant de clés SSH que bon lui semble, selon qu'il utilise plusieurs systèmes par exemple.

Pour générer une clé SSH, le plus simple est d'utiliser `Git Bash`. Après avoir
ouvert une invite de commande, taper :

```{r, echo = FALSE, out.width = '100%'}
utilitr::include_image("./pics/config_git/ssh_keygen.png", compression = FALSE)
```

La clé est générée sur le chemin spécifié et sera constituée de deux fichiers texte :
- un fichier en `.pub`, qui fournit la partie publique de la clé, et qui a vocation à être diffusée (donc c'est ce fichier qu'on chargera sur Gitlab pour permettre l'authentification) ;
- un fichier `.ppk` (comme Private Key) qui est la partie privée de la clé, et qui ne doit en aucun cas être diffusée.

La version privée de la clé doit être localisée dans un dossier caché que
Git va automatiquement utiliser
(en général un dossier `.ssh` localisé sur un dossier personnel).

### Ajout de la clé SSH sous Gitlab

Pour copier la partie publique de la clé sous Gitlab, il faut aller dans
la partie `Settings` de l'espace personnel sous Gitlab, puis sélectionner
*"SSH Keys"* sur le bandeau latéral gauche. On se trouve face à une fenêtre
de texte comme ceci :

```{r, echo = FALSE, out.width = '100%'}
utilitr::include_image("./pics/config_git/ssh_key_record.png", compression = FALSE)
```

dans laquelle on doit copier-coller le texte que l'on trouve dans le
fichier `.pub` de la clé SSH (en prenant soin d'éliminer l'éventuel texte
en fin du type *"imported-openssh-key"*).

Gitlab est désormais configuré, et il est alors possible de faire
dialoguer Git et Gitlab en suivant, par exemple, les routines proposées dans
la fiche [Utiliser R avec RStudio](#git).

::: conseil
L'option SSH ne fonctionne pas dans le Gitlab du SSP Cloud.
Seule l'authentification en `HTTPS` est possible.
:::

## Références

https://happygitwithr.com/
