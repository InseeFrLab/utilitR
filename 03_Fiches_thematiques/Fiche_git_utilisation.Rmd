# Utiliser `Git` avec RStudio

## Tâches concernées et recommandations

L'utilisateur souhaite se servir de `Git` pour suivre les modifications d'un projet RStudio. La lecture de cette fiche a deux prérequis :

- Cette fiche est une introduction à l'usage de `Git` avec `R` et RStudio, pas une introduction générale à `Git`. Il est donc préférable que l'utilisateur ait une connaissance basique de `Git` avant de lire cette fiche ; si ce n'est pas le cas, il est conseillé de consulter la formation [Travail collaboratif avec R](https://linogaliana.gitlab.io/collaboratif/git.html) ;
- Il est préférable d'avoir lu au préalable la fiche XXXX et d'avoir vérifié que les éléments de configuration de `Git` présentés dans cette fiche sont fonctionnels.

::: {.recommandation }

**Recommandations générales sur l'usge de `Git`** 

* Utiliser systématiquement `Git` pour suivre les modifications des codes d'un projet RStudio ;
* Ne jamais utiliser `Git` pour sauvegarder les données ;
* Utiliser l'interface graphique de `RStudio` pour les usages courants de `Git`, plutôt que la ligne de commande ;
* Vous pouvez utiliser `Git` _via_ la ligne de commande si vous le souhaitez. En revanche, il est _très fortement déconseillé_ d'exécuter une commande qui comprendrait les termes `force` ou `rebase`.

**Recommandations sur l'initialisation de `Git`**

* Il est recommandé d'utiliser `Git` dès le lancement de votre projet.
* Il est recommandé de commencer par créer un dépôt vide sur une forge (`Gitlab`, `Github`...), puis de cloner ce dépôt pour travailler sur votre poste local. Ceci est développé dans la
Section [Utiliser `Git` avec `R` dans un projet RStudio](clone-canonical).
* Il est également possible de commencer à suivre un projet déjà existant avec `Git`. Ceci est développé dans la Section
[Ajouter `Git` à un dépôt déjà existant](clone-alternative).
* Il est recommandé de renseigner immédiatement le fichier `.gitignore`. Ceci est développé dans la Section [Exclure certains fichiers du suivi de modifications](gitignore).

**Recommandations sur l'usage des branches**

* Il est recommandé d'utiliser RStudio pour créer une branche ou naviguer entre les branches ;
* Il est recommandé d'utiliser les interfaces `Github` ou `Gitlab` pour fusionner deux branches. Sur ce point, vous pouvez consulter la formation [Travail collaboratif avec R](https://linogaliana.gitlab.io/collaboratif/git.html).

:::


## Vocabulaire

forge
clone
commit
dépôt local
pull
push

## Pourquoi utiliser `Git`

Tous les statisticiens se sont déjà demandé (ou ont demandé à leurs collègues) :

- quelle était la bonne version d’un programme ;
- qui était l’auteur d’un bout de code en particulier ;
- si un changement était important ou juste un essai ;
- comment fusionner deux versions du même programme modifié par deux personnes différentes ;
- comment travailler à plusieurs sur les mêmes codes...

La réponse à toutes ces questions est : __utiliser `Git`__. `Git` est un outil qui permet de suivre en détail les évolutions d'un projet impliquant du code informatique, et qui facilite l'archivage des codes et la collaboration entre agents. Les avantages de `Git` sont multiples :

- `Git` contient l'historique de toutes les modifications apportées à un fichier ;
- `Git` permet de revenir facilement à une version antérieure d'un fichier ;
- `Git` permet de travailler à plusieurs en même temps sur les mêmes fichiers, de façon cohérente et sans risque de confusion ;
- `Git` permet de proposer des modifications sur des fichiers et les discuter, sans pour autant modifier la dernière version existante...
- `Git` fonctionne avec tous les langages informatiques (`R`, Python, SAS, LaTeX, C/C++, Java, etc.) et n'est pas spécifique à `R`. 

En un mot, **`Git` est le bon outil pour partager des codes et travailler à plusieurs sur un projet statistique (études ou production).** Si vous n'êtes pas encore convaincu,
une liste plus longue des raisons d'utiliser Git est
[disponible ici](https://linogaliana.gitlab.io/collaboratif/git.html#pourquoi-utiliser-la-gestion-de-version).

::: {.remarque}
Cette fiche décrit l'utilisation de `Git` au travers de l'interface graphique RStudio, car celle-ci facilite l'apprentissage de `Git` pour les débutants. Toutefois, utiliser cette interface n'est nullement obligatoire, et il est possible de réaliser l'ensemble des gestes présentés dans cette fiche avec des lignes de commande. Pour les utilisateurs intéressés par une telle approche, le nom de la commande `git` concerné sera systématiquement mentionné.
:::

## Initialiser l'usage de `Git` dans un projet RStudio {#clone}

Il est possible de commencer à suivre avec `Git` les modifications d'un projet `RStudio` à tout moment avec `Git`. **Il est nettement préférable de le faire dès la création du projet**, mais il est possible de le faire plus tard, à n'importe quelle étape du projet.

### Initialiser l'usage de `Git` à la création d'un projet {#clone-canonical}

[On mettra le lien vers la vidéo de travail collab quand elle existera]

::: {.remarque}

Les exemples de cette partie utilisent l'url du dépôt de la documentation `utilitR`. Il est tout à fait possible de s'exercer sur ce dépôt pour effectuer les manipulations de la Section XX et XX qui s'effectuent sur une copie locale (`clone`) du dépôt.

Néanmoins, il sera impossible d'effectuer une opération `push` car cela nécessite des droits d'écriture sur le dépôt qui est réservée aux mainteneurs de la documentation. Pour pratiquer ces opérations, il est recommandé de se créer un dépôt personnel sur `Github` ou `Gitlab`.
:::

#### Etape 1 : Créer le dépôt distant sur la forge

**La première étape consiste à créer un dépôt vide sur la forge.** C'est grâce à ce dépôt que vous allez pouvoir partager des codes avec vos collègues.

A ECRIRE

**Cette étape ne doit être réalisée qu'une seule fois par projet.** Il se peut que le dépôt distant existe déjà, par exemple si vous rejoignez à un projet déjà lancé, ou si un de vos collègues a déjà créé le dépôt. En ce cas vous pouvez passer directement à l'étape 2.

#### Etape 2 : Récupérer l'url du dépôt distant

**La deuxième étape consiste à récupérer l'adresse du dépôt distant.** Cette adresse se termine toujours par `.git`. Par exemple, l'adresse du dépôt de la documentation `utilitR` est `https://github.com/InseeFrLab/utilitR.git`.

Voici comment la récupérer. Vous devez d'abord vous rendre sur la page du projet sur la forge (comme `Gitlab` ou `Github`). Pour afficher l'adresse du dépôt, il faut cliquer sur un bouton déroulant à droite. 

Sur `Gitlab`, il s'agit du bouton `Clone` :

```{r, echo = FALSE}
include_image("./pics/git/create_project_0b.png")
```

Sur `Github`, il s'agit du bouton `Code` :

```{r, echo = FALSE}
include_image("./pics/git/create_project_0.png")
```

Choisir la méthode d'authentification désirée, `SSH` ou `HTTPS`
(cf. fiche XXXX). Par la suite, nous allons supposer qu'on utilise une authentification `HTTPS`.


**Etape 3 : Créer un projet RStudio en clonant le dépôt distant**

**La troisième étape consiste à créer un projet RStudio à partir du dépôt distant** (voir fiche XXXX pour plus de détails sur les projets RStudio). Cliquer sur `File > New Project...`, puis choisissez la troisième option (_Version Control_) :

```{r, echo = FALSE}
include_image("./pics/git/create_project_1.png")
```

Il faut alors renseigner trois champs dans la fenêtre suivante :

- `Repository URL` : coller l'adressse du dépôt distant récupérée à l'étape précédente ;
- `Project directory name` : choisir le nom du dossier local qui contiendra le projet RStudio ;
- `Create project as subdirectory of :` : définir l'emplacement de votre dépôt local dans l'aborescence de votre poste. Il est possible de modifier cet emplacement en cliquant sur le bouton `Browse`.

```{r, echo = FALSE}
include_image("./pics/git/create_project_2.png")
```

Après avoir validé, `RStudio` ouvre un projet `RStudio`. Si RStudio ne mentionne aucune erreur, un nouvel onglet portant le nom de `Git` doit normalement apparaître en haut à droite :

```{r, echo = FALSE}
include_image("./pics/git/create_project_3.png")
```

### Initialiser l'usage de `Git` dans un projet RStudio déjà existant {#clone-alternative}

Il est également possible d'ajouter `Git` à un projet RStudio déjà existant. Vous pouvez utiliser cette méthode lorsque vous avez commencé à travailler seul sur un projet `RStudio`, et que vous souhaitez le partager avec des collègues ou mieux suivre les modifications du projet.

**Etape 1 : Initialiser le suivi des modifications du projet RStudio**

La première étape consiste à initialiser l'utilisation de `Git` dans le projet RStudio en exécutant la fonction `usethis::use_git()` du _package_ `usethis`. 

```{r, eval = FALSE}
usethis::use_git()
```

Cette fonction réalise deux opérations : elle crée automatiquement tous les fichiers de configuration nécessaires au bon fonctionnement de `Git` dans le projet sur lequel vous travaillez, et effectue un premier `commit` (voir Section XX) pour valider la création de ces fichiers.


**Etape 2 : Mettre en place le _remote_**

A REDIGER (LINO: je suis à l'ouest là-dessus)

**Etape 3 : giter tous les codes existants et faire le premier _push_**

A REDIGER (LINO: je suis à l'ouest là-dessus)


### Exclure certains fichiers du suivi de modifications {#gitignore}

**Certains fichiers peuvent ou doivent être exclus du suivi des modifications.** En particulier, les fichiers suivants doivent **toujours** être exclus du suivi des modifications :

- les fichiers de données (csv, SAS, Excel, txt...) ;
- le fichier `.Renviron` (voir la fiche [Personnaliser la configuration de `R`]) ;
- les codes contenant des informations confidentielles (comme les mots de passe, les _tokens_ ou les clés d'API). 
Les fichiers exclus du suivi des modifications sont répertoriés dans un fichier nommé `.gitignore`. Si le projet a été créé selon l'une des deux méthodes décrites précédemment, `RStudio` crée automatiquement dans le dossier du projet un fichier `.gitignore` qui contient les lignes suivantes :

~~~r
.Rhistory
.RData
.Rproj.user
~~~

Ce fichier est modifiable et il est souvent nécessaire de lui ajouter des lignes pour exclure un certain nombre de fichiers. Par exemple, vous pouvez ajouter les lignes suivantes pour exclure tous les fichiers csv, SAS et Excel du suivi des modifications :

~~~r
*.csv
*.sas7bdat
*.xls
*.xlsx
~~~

Il est également conseillé d'exclure les fichiers pouvant être produits par des documents `R Markdown` (notamment les fichiers pdf et html). Par exemple, pour exclure les fichiers `PDF` et `HTML`, les lignes suivantes suffisent :

~~~r
*.html
*.pdf
~~~

::: {.remarque}
Le site [https://www.toptal.com/developers/gitignore](gitignore.io) fournit un certain nombre de modèles de fichiers `.gitignore` selon le type de projet associés à `Git`. 
:::

### Présentation de l'interface RStudio

RStudio permet d'utiliser `Git` _via_ une interface graphique, accessible dans l'onglet `Git` situé en haut à droite de la fenêtre RStudio. 

```{r, echo = FALSE}
include_image("./pics/git/create_project_3.png")
```

C'est grâce à cette interface que vous pourrez effectuer la plupart des opérations `Git` courantes, qui sont présentées ci-dessous. Les principales commandes de cette interface sont les suivantes :

- `Commit` : valider les modifications d'un ou plusieurs fichier(s) ;
- `Pull` : récupérer sur le dépôt distant les modifications apportées au projet par d'autres contributeurs ;
- `Push` : partager sur le dépôt distant les modifications que vous avez apportées au projet ;
- `History` : consulter l'historique des modifications du projet ; 
- `New Branch` : créer une nouvelle branche dans le dépôt `Git` ;
- le menu déroulant tout à droite permet de changer de branche.

::: {.remarque}
Si l'onglet `Git` n'apparaît pas dans la fenêtre RStudio, c'est que votre projet RStudio n'utilise pas `Git`. Reportez-vous à la section [Initialiser l'usage de `Git` dans un projet RStudio].
:::


## Suivre les modifications d'un projet RStudio avec `Git` {#git-local} 

### Repérer les modifications apportées au projet avec RStudio


METTRE UNE CAPTURE D'ECRAN AVEC LES STATUTS

Le statut du fichier n'est pas le même pour tous les fichiers :

* `M`: les modifications de ce fichier sont suivies par `Git`, et le fichier a été modifié depuis la dernière fois que ses modifications ont été validées ;
* `??`: les modifications de ce fichier ne sont pas suivies par `Git` ;
* `D`: le fichier a été supprimé (ou renommé).

### Suivre les modifications d'un fichier

#### Principe

Lorsqu'on souhaite enregistrer les modifications faites à un ou plusieurs fichiers, il est nécessaire d'effectuer deux opérations :

* `git add` : sélectionner les modifications qui vont être ajoutées à l'historique des modifications de `Git` (dont le nom technique est *index*) ;
* `git commit` : valider les modifications choisies à l'étape précédente et ajouter une entrée à l'*index* de `Git`.
  
Les modifications ne seront enregistrées qu'à l'issue de ces deux opérations, que vous pouvez réaliser soit avec la ligne de commande, soit avec l'interface RStudio. La suite de cette section détaille la marche à suivre avec l'interface RStudio.

#### Marche à suivre avec l'interface RStudio

Supposons qu'un fichier source a été modifié et qu'on souhaite valider ces modifications. Ci-dessous, le dépôt comporte plusieurs fichiers modifiés. On souhaite valider les modifications apportées au fichier `03_Fiches_thematiques/Fiche_git_utilisation.Rmd` et ajouter le fichier `pics/git/ibglet_git1.png`. 

```{r, echo = FALSE}
include_image("./pics/git/onglet_git1.png")
```

**Etape 1 : Cocher la case vide pour l'opération `add`**

La première étape (`git add`) consiste à sélectionner les fichiers dont on veut suivre les modifications, en cliquant sur la case vide à gauche du nom du fichier. Cela change le statut des fichiers :

```{r, echo = FALSE}
include_image("./pics/git/onglet_git3.png")
```

Les modifications à valider ont été sélectionnées, et sont maintenant dans la salle d'attente.

**Etape 2 : Cliquer sur `Commit` pour l'opération `commit`**

La seconde étape (`git commit`) consiste à valider les modifications choisies à l'étape précédente. Pour ce faire, il faut cliquer sur le bouton `Commit`, situé au-dessus de la liste des fichiers modifiés. En cliquant sur ce bouton, une nouvelle fenêtre s'ouvre :

```{r, echo = FALSE}
include_image("./pics/git/onglet_git4.png")
```

Les modifications apportées à chaque fichier sont résumées ligne à ligne dans la partie inférieure (suppressions en rouge, ajouts en vert). Pour valider ces modifications (`commit`), il faut décrire la nature des modifications validées (dans le cadre vert) et cliquer sur le bouton `Commit` (cadre rouge). La modification est validée :

```{r, echo = FALSE}
include_image("./pics/git/onglet_git5.png")
```

### Consulter l'historique d'un dépôt ou d'un fichier

Il est possible, depuis `RStudio`, de consulter la liste des modifications apportées à un dépôt en cliquant sur le bouton `History`. En ligne de commande, il faudrait taper `git log` pour obtenir une information équivalente.

```{r, echo = FALSE}
include_image("./pics/git/onglet_git6.png")
```

Cette action ouvre une fenêtre avec la liste des _commits_ réalisée sur la branche (voir plus bas pour la notion de branche), avec les modifications apportées par chaque _commit_.

```{r, echo = FALSE}
include_image("./pics/git/onglet_git7.png")
```

## Interagir avec le dépôt distant

Après avoir effectué des opérations sur son dépôt local, on peut effectuer deux opérations pour interagir avec le dépôt distant Les boutons dans `RStudio` illustrent bien l'opération en question :

* `pull` ![](./pics/git/pull.png): récupérer les modifications présentes
sur le dépôt distant ;
* `push` ![](./pics/git/push.png): envoyer les modifications faites en local
sur le dépôt distant.

Pour pouvoir soumettre sa version de travail grâce à un `push`, il est nécessaire que le dépôt local soit à jour
avec la version distante. Cela assure, à tout instant, la cohérence entre les différentes copies des contributeurs d'un projet. Il faut donc toujours récupérer la dernière version du projet sur le dépôt distant (en cliquant sur `pull`) avant d'envoyer de modifications (en cliquant sur `push`).

::: {.remarque}
Les icônes de l'onglet `Git` sont placées dans l'ordre des actions à réaliser afin de publier un code sur un dépôt distant : (add), commit, pull, push.

```{r, echo = FALSE}
include_image("./pics/git/onglet_git7.png")
```
:::

Il peut arriver que d'autres contributeurs aient envoyé sur le dépôt distant des modifications du projet en même temps que vous avez apporté des modifications à votre copie local du projet. Lorsque vous allez récupérer les modifications présentes sur le dépôt distant avec `Pull`, `Git` va essayer de fusionner automatiquement vos modifications avec celles des autres contributeurs. Il peut toutefois arriver que ces modifications soient incompatibles, par exemple si deux modifications portent sur la même ligne du même fichier : c'est un **conflit de version**. En cas de conflit, `Git` indiquera que la fusion automatique a échoué et vous demandera de vérifier manuellement les morceaux de fichiers concernés : vous devez alors **résoudre un conflit de version**. Plus de détails sont disponibles dans la [formation Travail collaboratif avec `R`](https://linogaliana.gitlab.io/collaboratif/).

## Créer des branches

C’est une des fonctionnalités les plus pratiques de la gestion de version.
La création de **branches** dans un projet
(qui devient ainsi un arbre) permet de développer en parallèle des correctifs
ou une nouvelle fonctionnalité sans modifier le dépôt commun. Cela permet de
séparer le nouveau développement et de faire cohabiter plusieurs versions,
pouvant évoluer séparément ou pouvant être facilement rassemblées.
`Git` est optimisé pour le travail sur les branches.

Dans un projet collaboratif, une branche dite `master`
joue le rôle du tronc. C’est autour d’elle que vont pousser ou se greffer
les branches comme le montre l’exemple ci-dessous:

<!---- image à insérer ------>

La partie droite de l'onglet `Git` est consacré aux branches:


```{r, echo = FALSE}
include_image("./pics/git/onglet_git8.png")
```

Cette partie permet de:

1. Créer une nouvelle branche. La branche source, à partir de laquelle la
nouvelle branche diverge, sera celle active au moment de la création. Il est
recommandé de se placer sur `master` avant chaque création de nouvelle branche.
De cette manière, les fusions ultérieures seront facilitées ;
2. Naviguer parmi les branches disponibles
en local - partie `(local branches)` - ou récupérer celles disponibles
sur le dépôt distant - `(remote: origin)`. 

En [ligne de commande](#terminal-git), on
utiliserait la commande `git checkout -b ma-branche` pour créer une nouvelle
branche nommée `ma-branche`. La commande `git checkout ma-branche`
permettrait, quant à elle, de se placer sur cette branche si 
celle-ci existe. 

Lorsqu'on se situe sur une branche, on peut faire les modifications qu'on
désire. Cela n'altère pas la version de référence, celle sur `master`, tant
qu'il n'y a pas de fusion (`merge`). 




## Utiliser le terminal {#terminal-git}


Pour ouvrir un terminal `Git`, cliquer sur l'écrou dans l'onglet `Git`: 

```{r, echo = FALSE}
include_image("./pics/git/onglet_git9.png")
```

Cette action ouvre un terminal `Git bash` permettant de taper :

* des commandes `Linux`, par exemple `ls` (lister les fichiers) ;
* des commandes `Git`, par exemple `git status` (lister l'état des fichiers dans `Git`).

```{r, echo = FALSE}
include_image("./pics/git/git-bash.png")
```


L'utilisation de la ligne de commande permet d'aller plus loin qu'avec l'interface `RStudio`. Grâce à elle, on peut par exemple corriger une maladresse. Si on s'interdit les commandes qui impliquent
le terme `force` (par exemple `git push force`) ou `rebase`, qui peuvent
créer des conflits de version insolubles avec les collaborateurs,
l'utilisation de la ligne de commande n'est pas plus risquée que l'utilisation
de l'interface `RStudio` (plus de détails 
[Formation *Travail collaboratif avec R*](https://linogaliana.gitlab.io/collaboratif/git.html)
)

## Pour aller plus loin

* [Formation *Travail collaboratif avec R*](https://linogaliana.gitlab.io/collaboratif/git.html)
* [*Happy Git with R*](https://happygitwithr.com/)
