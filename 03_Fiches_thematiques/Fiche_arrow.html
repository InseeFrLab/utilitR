<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.549">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>19&nbsp; Manipuler des données avec arrow</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../03_Fiches_thematiques/Fiche_duckdb.html" rel="next">
<link href="../03_Fiches_thematiques/Fiche_datatable.html" rel="prev">
<link href="../resources/logo-utilitr.png" rel="icon" type="image/png">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark"><script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script async="" src="https://hypothes.is/embed.js"></script><script>
  window.document.addEventListener("DOMContentLoaded", function (_event) {
    document.body.classList.add('hypothesis-enabled');
  });
</script>
</head>
<body class="nav-sidebar docked nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="navbar navbar-expand-lg " data-bs-theme="dark"><div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../resources/logo-utilitr.png" alt="Logo du projet utilitR" class="navbar-logo"></a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
<li class="nav-item">
    <a class="nav-link active" href="../01_R_Insee/presentation_utilitr.html" aria-current="page"> 
<span class="menu-text">Introduction</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../03_Fiches_thematiques/Fiche_rprojects.html"> 
<span class="menu-text">Mener un projet statistique</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../03_Fiches_thematiques/Fiche_import_fichiers_plats.html"> 
<span class="menu-text">Importer des données</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../03_Fiches_thematiques/Fiche_tidyverse.html"> 
<span class="menu-text">Choisir son paradigme</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../03_Fiches_thematiques/Fiche_joindre_donnees.html"> 
<span class="menu-text">Manipuler des données</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../03_Fiches_thematiques/Fiche_graphiques.html"> 
<span class="menu-text">Produire des sorties</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../02_Bonnes_pratiques/01-qualite-code.html"> 
<span class="menu-text">Bonnes pratiques</span></a>
  </li>  
</ul>
</div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools tools-wide">
    <a href="https://github.com/InseeFrLab/utilitR" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
    <div class="dropdown">
      <a href="" title="Share" id="quarto-navigation-tool-dropdown-0" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Share"><i class="bi bi-share"></i></a>
      <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="quarto-navigation-tool-dropdown-0">
<li>
            <a class="dropdown-item quarto-navbar-tools-item" href="https://twitter.com/intent/tweet?url=%7Curl%7C">
              <i class="bi bi-bi-twitter pe-1"></i>
            Twitter
            </a>
          </li>
          <li>
            <a class="dropdown-item quarto-navbar-tools-item" href="https://www.linkedin.com/sharing/share-offsite/?url=%7Curl%7C">
              <i class="bi bi-bi-linkedin pe-1"></i>
            LinkedIn
            </a>
          </li>
      </ul>
</div>
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
      </div> <!-- /container-fluid -->
    </nav><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../03_Fiches_thematiques/Fiche_tidyverse.html">Choisir son paradigme d’analyse des données avec R</a></li><li class="breadcrumb-item"><a href="../03_Fiches_thematiques/Fiche_arrow.html"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Manipuler des données avec <code>arrow</code></span></a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
      <a href="../index.html" class="sidebar-logo-link">
      <img src="../resources/logo-utilitr.png" alt="" class="sidebar-logo py-0 d-lg-inline d-none"></a>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Principales parties</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Introduction</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../01_R_Insee/presentation_utilitr.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Présentation du projet <code>utilitR</code></span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../01_R_Insee/Fiche_utiliser_utilitR.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Comment utiliser la documentation <code>utilitR</code></span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text">Mener un projet statistique avec R</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../03_Fiches_thematiques/Fiche_rprojects.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Utiliser les projets <code>RStudio</code></span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../03_Fiches_thematiques/Fiche_git_utilisation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Utiliser <code>Git</code> avec RStudio</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../01_R_Insee/Fiche_installer_packages.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Utiliser des <em>packages</em> <code>R</code></span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../03_Fiches_thematiques/Fiche_comment_choisir_un_package.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Comment choisir un <em>package</em> ?</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../03_Fiches_thematiques/Fiche_gerer_dependances.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Gérer les dépendances</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../03_Fiches_thematiques/Fiche_se_documenter.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Se documenter sur <code>R</code></span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../03_Fiches_thematiques/Fiche_resoudre_un_probleme.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Résoudre un problème avec <code>R</code></span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../03_Fiches_thematiques/Fiche_targets.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Construire une chaîne de traitement reproductible avec <code>targets</code></span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
 <span class="menu-text">Importer des données avec R</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../03_Fiches_thematiques/Fiche_import_fichiers_plats.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Importer des fichiers plats (<code>.csv</code>, <code>.tsv</code>, <code>.txt</code>)</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../03_Fiches_thematiques/Fiche_import_tables_sas.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Importer des tables SAS®</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../03_Fiches_thematiques/Fiche_import_tableurs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Importer des fichiers issus de tableurs (Excel, Calc)</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../03_Fiches_thematiques/Fiche_import_fichiers_parquet.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Lire et écrire des fichiers Parquet</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../03_Fiches_thematiques/Fiche_api.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Travailler avec des API</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../03_Fiches_thematiques/Fiche_connexion_bdd.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Se connecter à une base de données</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
 <span class="menu-text">Choisir son paradigme d’analyse des données avec R</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../03_Fiches_thematiques/Fiche_tidyverse.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Manipuler des données avec le <code>tidyverse</code></span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../03_Fiches_thematiques/Fiche_datatable.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Manipuler des données avec <code>data.table</code></span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../03_Fiches_thematiques/Fiche_arrow.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Manipuler des données avec <code>arrow</code></span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../03_Fiches_thematiques/Fiche_duckdb.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Manipuler des données avec <code>duckdb</code></span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true">
 <span class="menu-text">Manipuler des données avec R</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../03_Fiches_thematiques/Fiche_joindre_donnees.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">Joindre des tables de données</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../03_Fiches_thematiques/Fiche_donnees_textuelles.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">22</span>&nbsp; <span class="chapter-title">Manipuler des données textuelles</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../03_Fiches_thematiques/Fiche_survey.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">23</span>&nbsp; <span class="chapter-title">Utiliser des données d’enquêtes</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../03_Fiches_thematiques/Fiche_donnees_spatiales.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">24</span>&nbsp; <span class="chapter-title">Manipuler des données spatiales</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../03_Fiches_thematiques/Fiche_donnees_temporelles.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">25</span>&nbsp; <span class="chapter-title">Manipuler des données temporelles</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../03_Fiches_thematiques/Fiche_analyse_de_donnees.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">26</span>&nbsp; <span class="chapter-title">L’analyse de données (ACP, ACM, ACF…)</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true">
 <span class="menu-text">Produire des sorties avec R</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../03_Fiches_thematiques/Fiche_graphiques.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">27</span>&nbsp; <span class="chapter-title">Faire des graphiques avec <code>ggplot2</code></span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../03_Fiches_thematiques/Fiche_rmarkdown.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">28</span>&nbsp; <span class="chapter-title">Produire des documents avec <code>R Markdown</code></span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../03_Fiches_thematiques/Fiche_rmarkdown_param_report.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">29</span>&nbsp; <span class="chapter-title">Produire des rapports automatisés avec <code>R Markdown</code></span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" aria-expanded="true">
 <span class="menu-text">Bonnes pratiques</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../02_Bonnes_pratiques/01-qualite-code.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">30</span>&nbsp; <span class="chapter-title">Qualité du code</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../02_Bonnes_pratiques/02-structure-code.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">31</span>&nbsp; <span class="chapter-title">Structure des projets</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-8" aria-expanded="true">
 <span class="menu-text">Éléments de configuration</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-8" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-8" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../01_R_Insee/Fiche_utiliser_Rstudio_AUSv3.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">32</span>&nbsp; <span class="chapter-title">Utiliser RStudio sur l’environnement AUSv3</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../01_R_Insee/Fiche_utiliser_Rstudio_SSPCloud.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">33</span>&nbsp; <span class="chapter-title">Utiliser <code>RStudio</code> sur l’environnement SSP Cloud</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../03_Fiches_thematiques/Fiche_configurer_git.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">34</span>&nbsp; <span class="chapter-title">Configurer <code>Git</code> sur son poste de travail</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../01_R_Insee/Fiche-personnaliser-R.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">35</span>&nbsp; <span class="chapter-title">Personnaliser la configuration de <code>R</code></span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../01_R_Insee/Fiche_utiliser_ressources.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">36</span>&nbsp; <span class="chapter-title">Superviser sa session <code>R</code></span></span></a>
  </div>
</li>
      </ul>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li><a href="#t%C3%A2ches-concern%C3%A9es-et-recommandations" id="toc-tâches-concernées-et-recommandations" class="nav-link active" data-scroll-target="#t%C3%A2ches-concern%C3%A9es-et-recommandations"><span class="header-section-number">19.1</span> Tâches concernées et recommandations</a></li>
  <li>
<a href="#pr%C3%A9sentation-du-package-arrow-et-du-projet-associ%C3%A9" id="toc-présentation-du-package-arrow-et-du-projet-associé" class="nav-link" data-scroll-target="#pr%C3%A9sentation-du-package-arrow-et-du-projet-associ%C3%A9"><span class="header-section-number">19.2</span> Présentation du package <code>arrow</code> et du projet associé</a>
  <ul class="collapse">
<li><a href="#sec-presentation" id="toc-sec-presentation" class="nav-link" data-scroll-target="#sec-presentation"><span class="header-section-number">19.2.1</span> Qu’est-ce qu’<code>arrow</code>?</a></li>
  <li><a href="#sp%C3%A9cificit%C3%A9s-de-arrow" id="toc-spécificités-de-arrow" class="nav-link" data-scroll-target="#sp%C3%A9cificit%C3%A9s-de-arrow"><span class="header-section-number">19.2.2</span> Spécificités de <code>arrow</code></a></li>
  <li><a href="#a-quoi-sert-le-package-arrow" id="toc-a-quoi-sert-le-package-arrow" class="nav-link" data-scroll-target="#a-quoi-sert-le-package-arrow"><span class="header-section-number">19.2.3</span> A quoi sert le <em>package</em> <code>arrow</code>?</a></li>
  <li><a href="#quels-sont-les-avantages-darrow" id="toc-quels-sont-les-avantages-darrow" class="nav-link" data-scroll-target="#quels-sont-les-avantages-darrow"><span class="header-section-number">19.2.4</span> Quels sont les avantages d’<code>arrow</code>?</a></li>
  </ul>
</li>
  <li>
<a href="#que-faut-il-savoir-pour-utiliser-arrow" id="toc-que-faut-il-savoir-pour-utiliser-arrow" class="nav-link" data-scroll-target="#que-faut-il-savoir-pour-utiliser-arrow"><span class="header-section-number">19.3</span> Que faut-il savoir pour utiliser <code>arrow</code>?</a>
  <ul class="collapse">
<li><a href="#charger-et-param%C3%A9trer-le-package-arrow" id="toc-charger-et-paramétrer-le-package-arrow" class="nav-link" data-scroll-target="#charger-et-param%C3%A9trer-le-package-arrow"><span class="header-section-number">19.3.1</span> Charger et paramétrer le <em>package</em> <code>arrow</code></a></li>
  <li><a href="#le-data.frame-version-arrow-le-arrow-table" id="toc-le-data.frame-version-arrow-le-arrow-table" class="nav-link" data-scroll-target="#le-data.frame-version-arrow-le-arrow-table"><span class="header-section-number">19.3.2</span> Le <code>data.frame</code> version <code>arrow</code>: le <code>Arrow Table</code></a></li>
  <li><a href="#manipuler-des-arrow-table-avec-la-syntaxe-dplyr" id="toc-manipuler-des-arrow-table-avec-la-syntaxe-dplyr" class="nav-link" data-scroll-target="#manipuler-des-arrow-table-avec-la-syntaxe-dplyr"><span class="header-section-number">19.3.3</span> Manipuler des <code>Arrow Table</code> avec la syntaxe <code>dplyr</code></a></li>
  <li><a href="#le-moteur-dex%C3%A9cution-darrow-acero" id="toc-le-moteur-dexécution-darrow-acero" class="nav-link" data-scroll-target="#le-moteur-dex%C3%A9cution-darrow-acero"><span class="header-section-number">19.3.4</span> Le moteur d’exécution d’<code>arrow</code>: <code>acero</code></a></li>
  <li><a href="#sec-lazy" id="toc-sec-lazy" class="nav-link" data-scroll-target="#sec-lazy"><span class="header-section-number">19.3.5</span> L’évaluation différée avec <code>arrow</code> (<em>lazy evaluation</em>)</a></li>
  </ul>
</li>
  <li>
<a href="#comment-bien-utiliser-arrow" id="toc-comment-bien-utiliser-arrow" class="nav-link" data-scroll-target="#comment-bien-utiliser-arrow"><span class="header-section-number">19.4</span> Comment bien utiliser <code>arrow</code>?</a>
  <ul class="collapse">
<li><a href="#savoir-bien-utiliser-l%C3%A9valuation-diff%C3%A9r%C3%A9e" id="toc-savoir-bien-utiliser-lévaluation-différée" class="nav-link" data-scroll-target="#savoir-bien-utiliser-l%C3%A9valuation-diff%C3%A9r%C3%A9e"><span class="header-section-number">19.4.1</span> Savoir bien utiliser l’évaluation différée</a></li>
  <li><a href="#lire-des-fichiers-parquet-avec-open_dataset-plut%C3%B4t-que-read_parquet" id="toc-lire-des-fichiers-parquet-avec-open_dataset-plutôt-que-read_parquet" class="nav-link" data-scroll-target="#lire-des-fichiers-parquet-avec-open_dataset-plut%C3%B4t-que-read_parquet"><span class="header-section-number">19.4.2</span> Lire des fichiers Parquet avec <code>open_dataset()</code> plutôt que <code>read_parquet()</code></a></li>
  <li><a href="#utiliser-des-objets-arrow-table-plut%C3%B4t-que-des-data.frames" id="toc-utiliser-des-objets-arrow-table-plutôt-que-des-data.frames" class="nav-link" data-scroll-target="#utiliser-des-objets-arrow-table-plut%C3%B4t-que-des-data.frames"><span class="header-section-number">19.4.3</span> Utiliser des objets <code>Arrow Table</code> plutôt que des <code>data.frames</code></a></li>
  <li><a href="#surveiller-la-consommation-de-ram-de-r" id="toc-surveiller-la-consommation-de-ram-de-r" class="nav-link" data-scroll-target="#surveiller-la-consommation-de-ram-de-r"><span class="header-section-number">19.4.4</span> Surveiller la consommation de RAM de <code>R</code></a></li>
  </ul>
</li>
  <li>
<a href="#notions-avanc%C3%A9es" id="toc-notions-avancées" class="nav-link" data-scroll-target="#notions-avanc%C3%A9es"><span class="header-section-number">19.5</span> Notions avancées</a>
  <ul class="collapse">
<li><a href="#sec-limites-arrow" id="toc-sec-limites-arrow" class="nav-link" data-scroll-target="#sec-limites-arrow"><span class="header-section-number">19.5.1</span> Connaître les limites d’<code>arrow</code></a></li>
  <li><a href="#surmonter-le-probl%C3%A8me-des-fonctions-non-support%C3%A9es-par-acero" id="toc-surmonter-le-problème-des-fonctions-non-supportées-par-acero" class="nav-link" data-scroll-target="#surmonter-le-probl%C3%A8me-des-fonctions-non-support%C3%A9es-par-acero"><span class="header-section-number">19.5.2</span> Surmonter le problème des fonctions non supportées par <code>acero</code></a></li>
  </ul>
</li>
  <li><a href="#sec-template-arrow" id="toc-sec-template-arrow" class="nav-link" data-scroll-target="#sec-template-arrow"><span class="header-section-number">19.6</span> Un exemple de traitement de données avec <code>arrow</code></a></li>
  <li><a href="#RessourcesArrow" id="toc-RessourcesArrow" class="nav-link" data-scroll-target="#RessourcesArrow"><span class="header-section-number">19.7</span> Pour en savoir plus</a></li>
  </ul><div class="toc-actions"><ul><li><a href="https://github.com/InseeFrLab/utilitR/edit/master/03_Fiches_thematiques/Fiche_arrow.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/InseeFrLab/utilitR/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../03_Fiches_thematiques/Fiche_tidyverse.html">Choisir son paradigme d’analyse des données avec R</a></li><li class="breadcrumb-item"><a href="../03_Fiches_thematiques/Fiche_arrow.html"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Manipuler des données avec <code>arrow</code></span></a></li></ol></nav><div class="quarto-title">
<h1 class="title"><span id="arrow" class="quarto-section-identifier"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Manipuler des données avec <code>arrow</code></span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header><section id="tâches-concernées-et-recommandations" class="level2" data-number="19.1"><h2 data-number="19.1" class="anchored" data-anchor-id="tâches-concernées-et-recommandations">
<span class="header-section-number">19.1</span> Tâches concernées et recommandations</h2>
<p>L’utilisateur souhaite manipuler des données structurées sous forme de <code>data.frame</code> par le biais de l’écosystème <code>Arrow</code> (sélectionner des variables, sélectionner des observations, créer des variables, joindre des tables).</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tâches concernées et recommandations
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><p>Pour des tables de données de taille petite et moyenne (inférieure à 1 Go ou moins d’un million d’observations), il est recommandé d’utiliser les <em>packages</em> <code>tibble</code>, <code>dplyr</code> et <code>tidyr</code> qui sont présentés dans la fiche <a href="Fiche_tidyverse.html">Manipuler des données avec le <code>tidyverse</code></a>;</p></li>
<li><p>Pour des tables de données de grande taille (plus de 1 Go en CSV, plus de 200 Mo en Parquet, ou plus d’un million d’observations), il est recommandé d’utiliser soit les <em>packages</em> <code>arrow</code> (qui fait l’objet de la présente fiche) et <code>#duckdb</code> (voir la fiche <a href="Fiche_duckdb.html">Manipuler des données avec <code>arrow</code></a>), soit le <em>package</em> <code>data.table</code> qui fait l’objet de la fiche <a href="Fiche_datatable.html">Manipuler des données avec <code>data.table</code></a>.</p></li>
<li><p>Il est essentiel de travailler avec la dernière version d’<code>arrow</code>, de <code>duckdb</code> et de <code>R</code> car les <em>packages</em> <code>arrow</code> et <code>duckdb</code> sont en cours de développement. Par ailleurs, les recommandations d’<code>utilitR</code> peuvent évoluer en fonction du développement de ces <em>packages</em>.</p></li>
<li><p>Si les données traitées sont très volumineuses (plus de 5 Go en CSV, plus de 1 Go en Parquet ou plus de 5 millions d’observations), il est essentiel de manipuler uniquement des objets <code>Arrow Table</code>, plutôt que des <code>tibbles</code>. Cela implique notamment d’utiliser la fonction <code><a href="https://dplyr.tidyverse.org/reference/compute.html">compute()</a></code> plutôt que <code><a href="https://dplyr.tidyverse.org/reference/compute.html">collect()</a></code> dans les traitements intermédiaires.</p></li>
<li><p>Pour les personnes qui découvrent <code>arrow</code>, il est recommandé de partir de l’exemple de script de la <a href="#sec-template-arrow" class="quarto-xref"><span>Section 19.6</span></a> pour se familiariser avec l’usage <code>d'arrow</code>.</p></li>
</ul>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Apprendre à utiliser <code>arrow</code> n’est pas difficile, car la syntaxe utilisée est quasiment identique à celle du <code>tidyverse</code>. Toutefois, une bonne compréhension du fonctionnement de <code>R</code> et de <code>arrow</code> est nécessaire pour bien utiliser <code>arrow</code> sur des données volumineuses. Voici quelques conseils pour bien démarrer:</p>
<ul>
<li>Il est indispensable de lire les fiches <a href="Fiche_import_fichiers_parquet.html">Importer des fichiers Parquet</a> et <a href="Fiche_tidyverse.html">Manipuler des données avec le <code>tidyverse</code></a> avant de lire la présente fiche.</li>
<li>Il est complètement normal de rencontrer des erreurs difficiles à comprendre lorsqu’on commence à utiliser <code>arrow</code>, il ne faut donc pas se décourager.</li>
<li>Il ne faut pas hésiter à demander de l’aide à des collègues, ou à poser des questions sur les salons Tchap adaptés (le salon Langage <code>R</code> par exemple).</li>
</ul>
</div>
</div>
</section><section id="présentation-du-package-arrow-et-du-projet-associé" class="level2" data-number="19.2"><h2 data-number="19.2" class="anchored" data-anchor-id="présentation-du-package-arrow-et-du-projet-associé">
<span class="header-section-number">19.2</span> Présentation du package <code>arrow</code> et du projet associé</h2>
<section id="sec-presentation" class="level3" data-number="19.2.1"><h3 data-number="19.2.1" class="anchored" data-anchor-id="sec-presentation">
<span class="header-section-number">19.2.1</span> Qu’est-ce qu’<code>arrow</code>?</h3>
<p><a href="https://arrow.apache.org/">Apache <code>Arrow</code></a> est un projet <em>open-source</em> qui propose deux choses:</p>
<ul>
<li>une représentation standardisée des données tabulaires en mémoire vive appelée <em>Apache Arrow Columnar Format</em>, qui est à la fois efficace (les traitements sont rapides), interopérable (différents langages de programmation peuvent accéder aux mêmes données, sans conversion des données dans un autre format) et indépendante du langage de programmation utilisé.</li>
<li>une implémentation de ce standard en <code>C++</code>, qui prend la forme d’une librairie <code>C++</code> nommée <code>libarrow</code>. Il existe d’autres implémentations dans d’autres langages; l’implémentation en <code>Rust</code> est par exemple utilisée par le projet <a href="https://pola.rs/"><code>Polars</code></a>, une librairie alternative à <code>dplyr</code> (<code>R</code>) ou <code>Pandas</code> (<code>Python</code>) pour le traitement de données.</li>
</ul>
<p>Un point important à retenir est donc que <strong><code>arrow</code> n’est pas un outil spécifique à <code>R</code></strong>, et il faut bien distinguer le projet <code>arrow</code> (et la librairie C++ <code>libarrow</code>) du <em>package</em> <code>R</code> <code>arrow</code>. Ce <em>package</em> propose simplement une interface qui permet d’utiliser la librairie <code>libarrow</code> avec <code>R</code>, et il existe d’autres interfaces pour se servir de <code>libarrow</code> avec d’autres langages: en Python, en Java, en Javascript, en Julia, etc.</p>
</section><section id="spécificités-de-arrow" class="level3" data-number="19.2.2"><h3 data-number="19.2.2" class="anchored" data-anchor-id="spécificités-de-arrow">
<span class="header-section-number">19.2.2</span> Spécificités de <code>arrow</code>
</h3>
<p>Le projet <code>arrow</code> présente cinq spécificités:</p>
<ul>
<li>
<strong>Représentation des données en mémoire</strong> : <code>arrow</code> organise les données en colonnes plutôt qu’en lignes (on parle de <em>columnar format</em>). Concrètement, cela veut dire que dans la RAM toutes les valeurs de la première colonne sont stockées de façon contiguë, puis les valeurs de la deuxième colonne, etc. Cette structuration des données rend les traitements très efficaces: si l’on veut par exemple calculer la moyenne d’une variable, il est possible d’accéder directement au bloc de mémoire vive qui contient l’intégralité de cette colonne (indépendamment des autres colonnes de la table de données), d’où un traitement très rapide.</li>
</ul>
<details><summary>
Illustration de ce principe
</summary><div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="https://raw.githubusercontent.com/InseeFrLab/ssphub/news-janvier/infolettre/infolettre_17/parquet.png" class="img-fluid figure-img"></p>
<figcaption>Illustration de ce principe du stockage orienté colonnes (droite) par rapport au csv</figcaption></figure>
</div>
</details><ul>
<li><p><strong>Utilisation avec Parquet</strong>: <code>arrow</code> est souvent utilisé pour manipuler des données stockées en format Parquet. Parquet est un format de stockage orienté colonne conçu pour être très rapide en lecture (voir la fiche <a href="Fiche_import_fichiers_parquet.html">Importer des fichiers Parquet</a> pour plus de détails). <code>arrow</code> est optimisé pour travailler sur des fichiers Parquet, notamment lorsqu’ils contiennent des données très volumineuses.</p></li>
<li><p><strong>Traitement de données volumineuses</strong>: <code>arrow</code> est conçu pour traiter des données sans avoir besoin de les charger complètement dans la mémoire vive. Cela signifie qu’<code>arrow</code> est capable de traiter des données plus volumineuses que la mémoire vive (RAM) dont on dispose. C’est un avantage majeur en comparaison aux autres approches possibles en <code>R</code> (<code>data.table</code> et <code>dplyr</code> par exemple).</p></li>
<li><p><strong>Interopérabilité</strong>: <code>arrow</code> est conçu pour être interopérable entre plusieurs langages de programmation tels que <code>R</code>, Python, Java, C++, etc. Cela signifie que les données peuvent être échangées entre ces langages sans avoir besoin de convertir les données, d’où des gains importants de temps et de performance.</p></li>
<li><p><strong><em>Lazy Evaluation</em></strong>: <code>arrow</code> prend en charge la <em>lazy evaluation</em> (évaluation différée) dans certains contextes. Cela signifie que les traitements ne sont effectivement exécutés que lorsqu’ils sont nécessaires, ce qui peut améliorer les performances en évitant le calcul de résultats intermédiaires non utilisés. La <a href="Fiche_duckdb.html#sec-lazy" class="quarto-xref"><span>Section 20.5.2</span></a> présente en détail cette notion.</p></li>
</ul></section><section id="a-quoi-sert-le-package-arrow" class="level3" data-number="19.2.3"><h3 data-number="19.2.3" class="anchored" data-anchor-id="a-quoi-sert-le-package-arrow">
<span class="header-section-number">19.2.3</span> A quoi sert le <em>package</em> <code>arrow</code>?</h3>
<p>Du point de vue d’un statisticien utilisant <code>R</code>, le <em>package</em> <code>arrow</code> permet de faire trois choses:</p>
<ul>
<li>Importer des données (exemples: fichiers CSV, fichiers Parquet, stockage S3) et les organiser en mémoire vive dans un objet <code>Arrow Table</code>;</li>
<li>Manipuler des données organisées dans un <code>Arrow Table</code> avec la syntaxe <code>dplyr</code>, ou avec le langage SQL (grâce à <code>duckdb</code>);</li>
<li>Écrire des données en format Parquet.</li>
</ul></section><section id="quels-sont-les-avantages-darrow" class="level3" data-number="19.2.4"><h3 data-number="19.2.4" class="anchored" data-anchor-id="quels-sont-les-avantages-darrow">
<span class="header-section-number">19.2.4</span> Quels sont les avantages d’<code>arrow</code>?</h3>
<p>En pratique, le <em>package</em> <code>arrow</code> présente trois avantages:</p>
<ul>
<li>
<strong>Performances élevées</strong>: <code>arrow</code> est très efficace et très rapide pour la manipulation de données tabulaires (nettement plus performant que <code>dplyr</code> par exemple);</li>
<li>
<strong>Usage réduit des ressources</strong>: <code>arrow</code> est conçu pour ne charger en mémoire que le minimum de données. Cela permet de réduire considérablement les besoins en mémoire, même lorsque les données sont volumineuses;</li>
<li>
<strong>Facilité d’apprentissage</strong> grâce aux approches <code>dplyr</code> et SQL: <code>arrow</code> peut être utilisé avec les verbes de <code>dplyr</code> (<code>select</code>, <code>mutate</code>, etc.) et/ou avec le langage SQL grâce à <code>duckdb</code>. Par conséquent, il n’est pas nécessaire d’apprendre une nouvelle syntaxe pour utiliser <code>arrow</code>, on peut s’appuyer sur la ou les approches que l’on maîtrise déjà. En revanche, il est à noter que le <em>package</em> <code>data.table</code> n’est pas directement compatible avec <code>arrow</code> (il faut convertir les objets <code>Arrow Table</code> en <code>data.table</code>, opération longue lorsque les données sont volumineuses).</li>
</ul></section></section><section id="que-faut-il-savoir-pour-utiliser-arrow" class="level2" data-number="19.3"><h2 data-number="19.3" class="anchored" data-anchor-id="que-faut-il-savoir-pour-utiliser-arrow">
<span class="header-section-number">19.3</span> Que faut-il savoir pour utiliser <code>arrow</code>?</h2>
<p>Le <em>package</em> <code>arrow</code> présente quatre caractéristiques importantes:</p>
<ul>
<li>une structure de données spécifique: le <code>Arrow Table</code>;</li>
<li>une utilisation via la syntaxe <code>dplyr</code>;</li>
<li>un moteur d’exécution spécifique: <code>acero</code>;</li>
<li>un mode de fonctionnement particulier: l’évaluation différée.</li>
</ul>
<section id="charger-et-paramétrer-le-package-arrow" class="level3" data-number="19.3.1"><h3 data-number="19.3.1" class="anchored" data-anchor-id="charger-et-paramétrer-le-package-arrow">
<span class="header-section-number">19.3.1</span> Charger et paramétrer le <em>package</em> <code>arrow</code>
</h3>
<p>Pour utiliser <code>arrow</code>, il faut commencer par charger le <em>package</em>. Comme <code>arrow</code> s’utilise presque toujours avec <code>dplyr</code> en pratique, il est préférable de prendre l’habitude de charger les deux <em>packages</em> ensemble. Par ailleurs, il est utile de définir systématiquement deux réglages qui sont importants pour les performances d’<code>arrow</code>: autoriser <code>arrow</code> à utiliser plusieurs processeurs en parallèle, et définir le nombre de processeurs qu’<code>arrow</code> peut utiliser.</p>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/apache/arrow/">arrow</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Autoriser arrow à utiliser plusieurs processeurs en parallèle</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span><span class="op">(</span>arrow.use_threads <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co"># Définir le nombre de processeurs qu'arrow peut utiliser</span></span>
<span><span class="fu">arrow</span><span class="fu">::</span><span class="fu"><a href="https://arrow.apache.org/docs/r/reference/cpu_count.html">set_cpu_count</a></span><span class="op">(</span><span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html">detectCores</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html">%/%</a></span> <span class="fl">4</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="le-data.frame-version-arrow-le-arrow-table" class="level3" data-number="19.3.2"><h3 data-number="19.3.2" class="anchored" data-anchor-id="le-data.frame-version-arrow-le-arrow-table">
<span class="header-section-number">19.3.2</span> Le <code>data.frame</code> version <code>arrow</code>: le <code>Arrow Table</code>
</h3>
<p><strong>Le <em>package</em> <code>arrow</code> structure les données non pas dans un <code>data.frame</code> classique, mais dans un objet spécifique à <code>arrow</code>: le <code>Arrow Table</code>.</strong> Dans un objet <code>Arrow Table</code>, les données sont organisées en colonnes plutôt qu’en lignes, conformément aux spécifications d’<code>arrow</code> (voir la <a href="@sec-presentation">présentation d’<code>arrow</code></a>). Pour convertir un <code>data.frame</code> ou un <code>tibble</code> en <code>Arrow Table</code>, il suffit d’utiliser la fonction <code><a href="https://arrow.apache.org/docs/r/reference/as_arrow_table.html">as_arrow_table()</a></code>.</p>
<p>Par rapport à un <code>data.frame</code> standard ou à un <code>tibble</code>, le <code>Arrow Table</code> se distingue immédiatement sur trois points. Pour illustrer ces différences, on utilise la base permanente des équipements 2018 (table <code>bpe_ens_2018</code>), transformée en <code>tibble</code> d’une part, et en <code>Arrow Table</code> d’autre part.</p>
<div class="cell">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Charger les données et les convertir en tibble</span></span>
<span><span class="va">bpe_ens_2018_tbl</span>   <span class="op">&lt;-</span> <span class="fu">doremifasolData</span><span class="fu">::</span><span class="va"><a href="https://InseeFrLab.github.io/DoReMIFaSolData/reference/bpe_ens_2018.html">bpe_ens_2018</a></span> <span class="op">|&gt;</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Charger les données et les convertir en Arrow Table</span></span>
<span><span class="va">bpe_ens_2018_arrow</span> <span class="op">&lt;-</span> <span class="fu">doremifasolData</span><span class="fu">::</span><span class="va"><a href="https://InseeFrLab.github.io/DoReMIFaSolData/reference/bpe_ens_2018.html">bpe_ens_2018</a></span> <span class="op">|&gt;</span> <span class="fu"><a href="https://arrow.apache.org/docs/r/reference/as_arrow_table.html">as_arrow_table</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Première différence: alors que les <code>data.frames</code> et les <code>tibbles</code> apparaissent dans la rubrique <code>Data</code> de l’environnement <code>RStudio</code> (cadre rouge dans la capture d’écran), les objets <code>Arrow Table</code> apparaissent dans la rubrique <code>Values</code> (cadre blanc).</p>
<p><img src="../pics/arrow/diff_environnement.png" class="img-fluid"></p>
<p>Deuxième différence: alors que l’affichage dans la console d’un <code>data.frame</code> ou <code>tibble</code> permet de visualiser les premières lignes, la même opération sur un <code>Arrow Table</code> affiche uniquement des métadonnées (nombre de lignes et de colonnes, nom et type des colonnes).</p>
<div class="cell">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Affichage d'un tibble</span></span>
<span><span class="va">bpe_ens_2018_tbl</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1,035,564 × 7
   REG   DEP   DEPCOM DCIRIS    AN TYPEQU NB_EQUIP
   &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;  &lt;chr&gt;  &lt;dbl&gt; &lt;chr&gt;     &lt;dbl&gt;
 1 84    01    01001  01001   2018 A401          2
 2 84    01    01001  01001   2018 A404          4
 3 84    01    01001  01001   2018 A504          1
 4 84    01    01001  01001   2018 A507          1
 5 84    01    01001  01001   2018 B203          1
 6 84    01    01001  01001   2018 C104          1
 7 84    01    01001  01001   2018 D233          1
 8 84    01    01001  01001   2018 F102          1
 9 84    01    01001  01001   2018 F111          1
10 84    01    01001  01001   2018 F113          1
# ℹ 1,035,554 more rows</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Affichage d'un Arrow Table</span></span>
<span><span class="va">bpe_ens_2018_arrow</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Table
1035564 rows x 7 columns
$REG &lt;string&gt;
$DEP &lt;string&gt;
$DEPCOM &lt;string&gt;
$DCIRIS &lt;string&gt;
$AN &lt;double&gt;
$TYPEQU &lt;string&gt;
$NB_EQUIP &lt;double&gt;

See $metadata for additional Schema metadata</code></pre>
</div>
</div>
<p>Troisième différence: alors qu’il est possible d’afficher le contenu d’un <code>data.frame</code> ou d’un <code>tibble</code> en cliquant sur son nom dans la rubrique <code>Data</code> de l’environnement ou en utilisant la fonction <code><a href="https://rdrr.io/r/utils/View.html">View()</a></code>, il n’est pas possible d’afficher directement le contenu d’un <code>Arrow Table</code>. Pour afficher le contenu d’un <code>Arrow Table</code>, il faut d’abord convertir le <code>Arrow Table</code> en <code>tibble</code> avec la fonction <code><a href="https://dplyr.tidyverse.org/reference/compute.html">collect()</a></code>.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>Il arrive fréquemment que l’on souhaite jeter un coup d’oeil au contenu d’un <code>Arrow Table</code>. Toutefois, convertir directement un <code>Arrow Table</code> très volumineux en <code>tibble</code> peut poser de sérieux problèmes: temps de conversion, consommation importante de RAM, voire plantage de <code>R</code> si le <code>Arrow Table</code> est vraiment très gros. <strong>Il est donc fortement conseillé de prendre un petit extrait du <code>Arrow Table</code> concerné et de convertir uniquement cet extrait en <code>tibble</code>.</strong></p>
<div class="cell">
<details class="code-fold"><summary>Exemple de code qui visualise un échantillon d’une table Arrow</summary><div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Extraire les 1000 premières lignes du Arrow Table et les convertir en tibble</span></span>
<span><span class="va">extrait_bpe</span> <span class="op">&lt;-</span> <span class="va">bpe_ens_2018_arrow</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice_head</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html">collect</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/View.html">View</a></span><span class="op">(</span><span class="va">extrait_bpe</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</section><section id="manipuler-des-arrow-table-avec-la-syntaxe-dplyr" class="level3" data-number="19.3.3"><h3 data-number="19.3.3" class="anchored" data-anchor-id="manipuler-des-arrow-table-avec-la-syntaxe-dplyr">
<span class="header-section-number">19.3.3</span> Manipuler des <code>Arrow Table</code> avec la syntaxe <code>dplyr</code>
</h3>
<p>Le <em>package</em> <code>R</code> <code>arrow</code> a été écrit de façon à ce qu’un <code>Arrow Table</code> puisse être manipulé avec les fonctions de <code>dplyr</code> (<code>select</code>, <code>filter</code>, <code>mutate</code>, <code>left_join</code>, etc.), <em>comme si</em> cette table était un <code>data.frame</code> ou un <code>tibble</code> standard.</p>
<p>Il est également possible d’utiliser sur un <code>Arrow Table</code> un certain nombre de fonctions des <em>packages</em> du <code>tidyverse</code> (comme <code>stringr</code> et <code>lubridate</code>). Cela s’avère très commode en pratique, car lorsqu’on sait utiliser <code>dplyr</code> et le <code>tidyverse</code>, on peut commencer à utiliser <code>arrow</code> sans avoir à apprendre une nouvelle syntaxe de manipulation de données. Il y a néanmoins des subtilités à connaître, détaillées dans la suite de cette fiche.</p>
<p>Dans l’exemple suivant, on calcule le nombre d’équipements par région, à partir d’un <code>tibble</code> et à partir d’un <code>Arrow table</code>. La seule différence apparente entre les deux traitement est la présence de la fonction <code><a href="https://dplyr.tidyverse.org/reference/compute.html">collect()</a></code> à la fin des instructions; cette fonction indique que l’on souhaite que le résultat du traitement soit stocké sous la forme d’un <code>tibble</code>. La raison d’être de ce <code><a href="https://dplyr.tidyverse.org/reference/compute.html">collect()</a></code> est expliquée plus loin, dans le paragraphe sur l’évaluation différée.</p>
<div class="columns">
<div class="column" style="width:49%;">
<p><strong>Manipulation d’un <code>tibble</code></strong></p>
<div class="cell">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">bpe_ens_2018_tbl</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">REG</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span></span>
<span>    NB_EQUIP_TOT <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">NB_EQUIP</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div><div class="column" style="width:2%;">
<!-- empty column to create gap -->
</div><div class="column" style="width:49%;">
<p><strong>Manipulation d’un <code>Arrow Table</code></strong></p>
<div class="cell">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">bpe_ens_2018_arrow</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">REG</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span></span>
<span>    NB_EQUIP_TOT <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">NB_EQUIP</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html">collect</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</section><section id="le-moteur-dexécution-darrow-acero" class="level3" data-number="19.3.4"><h3 data-number="19.3.4" class="anchored" data-anchor-id="le-moteur-dexécution-darrow-acero">
<span class="header-section-number">19.3.4</span> Le moteur d’exécution d’<code>arrow</code>: <code>acero</code>
</h3>
<p>Il y a une différence fondamentale entre manipuler un <code>data.frame</code> ou un <code>tibble</code> et manipuler un <code>Arrow Table</code>. Pour bien la comprendre, il faut d’abord comprendre la <strong>distinction entre syntaxe de manipulation des données et moteur d’exécution</strong>:</p>
<ul>
<li>La syntaxe de manipulation des données sert à décrire les manipulations de données qu’on veut faire (calculer des moyennes, faire des jointures…), indépendamment de la façon dont ces calculs sont effectivement réalisés;</li>
<li>le moteur d’exécution fait référence à la façon dont les opérations sur les données sont effectivement réalisées en mémoire, indépendamment de la façon dont elles ont été décrites par l’utilisateur.</li>
</ul>
<p><strong>La grande différence entre manipuler un <code>tibble</code> et manipuler un <code>Arrow Table</code> tient au moteur d’exécution</strong>: si on manipule un <code>tibble</code> avec la syntaxe de <code>dplyr</code>, alors c’est le moteur d’exécution de <code>dplyr</code> qui fait les calculs; si on manipule un <code>Arrow Table</code> avec la syntaxe de <code>dplyr</code>, alors c’est le moteur d’exécution d’<code>arrow</code> (nommé <code>acero</code>) qui fait les calculs. C’est justement parce que le moteur d’exécution d’<code>arrow</code> est beaucoup plus efficace que celui de <code>dplyr</code> qu’<code>arrow</code> est beaucoup plus rapide.</p>
<!-- __La grande différence entre `dplyr` et `arrow` tient au moteur d'exécution__: si on manipule un `tibble` avec la syntaxe de `dplyr`, alors c'est le moteur d'exécution de `dplyr` qui fait les calculs; si on manipule un `Arrow Table` avec la syntaxe de `dplyr`, alors les instructions sont automatiquement converties et envoyées au moteur d'exécution d'`arrow` (nommé `acero`), et c'est ce moteur qui fait les calculs. C'est justement parce que le moteur d'exécution d'`arrow` est beaucoup plus efficace que celui de `dplyr` qu'`arrow` est beaucoup plus rapide. __Comprendre cette différence de moteurs d'exécution est essentiel pour bien utiliser `arrow` et résoudre les problèmes qui se présentent lorsqu'on découvre cet outil__. -->
<p><strong>Cette différence de moteurs d’exécution a une conséquence technique importante</strong>: une fois que l’utilisateur a défini des instructions avec la syntaxe <code>dplyr</code>, il est nécessaire que celles-ci soient converties pour que le moteur <code>acero</code> (écrit en C++ et non en <code>R</code>) puisse les exécuter. De façon générale, <code>arrow</code> fait cette conversion de façon automatique et invisible, car le <em>package</em> <code>arrow</code> contient la traduction C++ de plusieurs centaines de fonctions du <code>tidyverse</code>. Par exemple, le <em>package</em> <code>arrow</code> contient la traduction C++ de la fonction <code><a href="https://dplyr.tidyverse.org/reference/filter.html">filter()</a></code> de <code>dplyr</code>, ce qui fait que les instructions <code><a href="https://dplyr.tidyverse.org/reference/filter.html">filter()</a></code> écrites en syntaxe <code>tidyverse</code> sont converties de façon automatique et invisible en des instructions C++ équivalentes. La liste des fonctions du <em>tidyverse</em> supportées par <code>acero</code> est disponible sur <a href="https://arrow.apache.org/docs/dev/r/reference/acero.html">cette page</a>. Il arrive toutefois qu’on veuille utiliser une fonction non supportée par <code>acero</code>. Cette situation est décrite dans le paragraphe “Comment utiliser une fonction non supportée par <code>acero</code>”.</p>
</section><section id="sec-lazy" class="level3" data-number="19.3.5"><h3 data-number="19.3.5" class="anchored" data-anchor-id="sec-lazy">
<span class="header-section-number">19.3.5</span> L’évaluation différée avec <code>arrow</code> (<em>lazy evaluation</em>)</h3>
<p><strong>Une caractéristique importante d’<code>arrow</code> est qu’il pratique l’évaluation différée (<em>lazy evaluation</em>): les calculs ne sont effectivement réalisés que lorsqu’ils sont nécessaires</strong>. En pratique, cela signifie qu’<code>arrow</code> se contente de mémoriser les instructions, sans faire aucun calcul tant que l’utilisateur ne le demande pas explicitement. Il existe deux fonctions pour déclencher l’évaluation d’un traitement <code>arrow</code>: <code><a href="https://dplyr.tidyverse.org/reference/compute.html">collect()</a></code> et <code><a href="https://dplyr.tidyverse.org/reference/compute.html">compute()</a></code>. Il n’y a qu’une seule différence entre <code><a href="https://dplyr.tidyverse.org/reference/compute.html">collect()</a></code> et <code><a href="https://dplyr.tidyverse.org/reference/compute.html">compute()</a></code>, mais elle est importante: <code><a href="https://dplyr.tidyverse.org/reference/compute.html">collect()</a></code> renvoie le résultat du traitement sous la forme d’un <code>tibble</code>, tandis que <code><a href="https://dplyr.tidyverse.org/reference/compute.html">compute()</a></code> le renvoie sous la forme d’un <code>Arrow Table</code>.</p>
<p><strong>L’évaluation différée permet d’améliorer les performances en évitant le calcul de résultats intermédiaires inutiles, et en optimisant les requêtes</strong> pour utiliser le minimum de données et le minimum de ressources. L’exemple suivant illustre l’intérêt de l’évaluation différée dans un cas simple.</p>
<div class="cell">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Étape 1: compter les équipements</span></span>
<span><span class="va">eq_dep</span> <span class="op">&lt;-</span> <span class="va">bpe_ens_2018_arrow</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">DEP</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span></span>
<span>    NB_EQUIP_TOT <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">NB_EQUIP</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Étape 2: filtrer sur le département</span></span>
<span><span class="va">resultats</span> <span class="op">&lt;-</span> <span class="va">eq_dep</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">DEP</span> <span class="op">==</span> <span class="st">"59"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html">collect</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Dans cet exemple, on procède à un traitement en deux temps: on compte les équipements par département, puis on filtre sur le département. Il est important de souligner que la première étape ne réalise aucun calcul par elle-même, car elle ne comprend ni <code><a href="https://dplyr.tidyverse.org/reference/compute.html">collect()</a></code> ni <code><a href="https://dplyr.tidyverse.org/reference/compute.html">compute()</a></code>. L’objet <code>equipements_par_departement</code> n’est pas une table et ne contient pas de données, il contient simplement une requête (<em>query</em>) décrivant les opérations à mener sur la table <code>bpe_ens_2018_arrow</code>.</p>
<p>On pourrait penser que, lorsqu’on exécute l’ensemble de ce traitement, <code>arrow</code> se contente d’exécuter les instructions les unes après les autres: compter les équipements par département, puis conserver uniquement le département 59. Mais en réalité <code>arrow</code> fait beaucoup mieux que cela: <strong><code>arrow</code> analyse la requête avant de l’exécuter, et optimise le traitement pour minimiser le travail</strong>. Dans le cas présent, <code>arrow</code> repère que la requête ne porte en fait que sur le département 59, et commence donc par filtrer les données sur le département avant de compter les équipements, de façon à ne conserver que le minimum de données nécessaires et à ne réaliser que le minimum de calculs. Ce type d’optimisation s’avère très utile quand les données à traiter sont très volumineuses.</p>
</section></section><section id="comment-bien-utiliser-arrow" class="level2" data-number="19.4"><h2 data-number="19.4" class="anchored" data-anchor-id="comment-bien-utiliser-arrow">
<span class="header-section-number">19.4</span> Comment bien utiliser <code>arrow</code>?</h2>
<p>Au premier abord, on peut avoir l’impression qu’<code>arrow</code> s’utilise exactement comme <code>dplyr</code> (c’est d’ailleurs fait exprès!). Il y a toutefois quelques différences qui peuvent avoir un impact considérable sur les performances des traitements. Cette partie détaille quatre recommandations à suivre pour bien utiliser <code>arrow</code>:</p>
<ul>
<li>Utiliser correctement l’évaluation différée;</li>
<li>Utiliser <code><a href="https://dplyr.tidyverse.org/reference/compute.html">compute()</a></code> plutôt que <code><a href="https://dplyr.tidyverse.org/reference/compute.html">collect()</a></code>;</li>
<li>Utiliser <code><a href="https://arrow.apache.org/docs/r/reference/open_dataset.html">open_dataset()</a></code> plutôt que <code><a href="https://arrow.apache.org/docs/r/reference/read_parquet.html">read_parquet()</a></code>;</li>
<li>Surveiller la consommation de RAM de <code>R</code>.</li>
</ul>
<section id="savoir-bien-utiliser-lévaluation-différée" class="level3" data-number="19.4.1"><h3 data-number="19.4.1" class="anchored" data-anchor-id="savoir-bien-utiliser-lévaluation-différée">
<span class="header-section-number">19.4.1</span> Savoir bien utiliser l’évaluation différée</h3>
<p>La <a href="Fiche_duckdb.html#sec-lazy" class="quarto-xref"><span>Section 20.5.2</span></a> a présenté la notion d’évaluation différée et son intérêt pour optimiser les performances. Toutefois, l’évaluation différée n’est pas toujours facile à utiliser, et présente des limites qu’il faut bien comprendre. Cette section décrit plus en détail le fonctionnement de l’évaluation différée et ses limites. Pour illustrer ce fonctionnement, on commence par exporter la base permanente des équipements sous la forme d’un dataset Arrow partitionné. La fiche <a href="Fiche_import_fichiers_parquet.html">Importer des fichiers Parquet</a> décrit en détail ce qu’est un fichier Parquet partitionné et comment le manipuler.</p>
<div class="cell">
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Sauvegarder la BPE 2018 sous la forme d'un dataset Arrow partitionné</span></span>
<span><span class="fu"><a href="https://arrow.apache.org/docs/r/reference/write_dataset.html">write_dataset</a></span><span class="op">(</span></span>
<span>  <span class="va">bpe_ens_2018_arrow</span>,</span>
<span>  <span class="st">"bpe2018/"</span>,</span>
<span>  partitioning <span class="op">=</span> <span class="st">"REG"</span>,</span>
<span>  hive_style <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="comment-fonctionne-lévaluation-différée" class="level4" data-number="19.4.1.1"><h4 data-number="19.4.1.1" class="anchored" data-anchor-id="comment-fonctionne-lévaluation-différée">
<span class="header-section-number">19.4.1.1</span> Comment fonctionne l’évaluation différée?</h4>
<p>Ce paragraphe s’adresse aux lecteurs qui souhaitent comprendre plus en détail le fonctionnement de l’évaluation différée. Les lecteurs pressés peuvent passer directement au paragraphe suivant, sur les limites de l’évaluation différée.</p>
<p>Le traitement suivant est un exemple simple d’utilisation de l’évaluation différée. Ce traitement comprend trois étapes: se connecter aux données avec <code><a href="https://arrow.apache.org/docs/r/reference/open_dataset.html">open_dataset()</a></code>, puis calculer le nombre d’équipements par département, et enfin sélectionner le département 59.</p>
<div class="cell">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Étape 1: se connecter au fichier Paruet Partitionné</span></span>
<span><span class="va">ds_bpe2018</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://arrow.apache.org/docs/r/reference/open_dataset.html">open_dataset</a></span><span class="op">(</span></span>
<span>  <span class="st">"bpe2018/"</span>,</span>
<span>  partitioning <span class="op">=</span> <span class="fu"><a href="https://arrow.apache.org/docs/r/reference/schema.html">schema</a></span><span class="op">(</span><span class="st">"REG"</span> <span class="op">=</span> <span class="fu"><a href="https://arrow.apache.org/docs/r/reference/data-type.html">utf8</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  hive_style <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Étape 2: compter les équipements</span></span>
<span><span class="va">eq_dep</span> <span class="op">&lt;-</span> <span class="va">ds_bpe2018</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">DEP</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span></span>
<span>    NB_EQUIP_TOT <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">NB_EQUIP</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Étape 3: filtrer sur le département</span></span>
<span><span class="va">resultats</span> <span class="op">&lt;-</span> <span class="va">eq_dep</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">DEP</span> <span class="op">==</span> <span class="st">"59"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Voici quelques commentaires pour comprendre ce traitement:</p>
<ul>
<li>Le code ci-dessus n’effectue aucun calcul, car il ne comprend ni <code><a href="https://dplyr.tidyverse.org/reference/compute.html">collect()</a></code> ni <code><a href="https://dplyr.tidyverse.org/reference/compute.html">compute()</a></code>. Il faut exécuter <code>resultats |&gt; collect()</code> ou <code>resultats |&gt; compute()</code> pour que les calculs soient effectivement réalisés.</li>
<li>Les objets <code>ds_bpe2018</code>, <code>eq_dep</code> et <code>resultats</code> ne sont pas des tables <code>R</code> standards contenant des données: ce sont des requêtes (de classe <code>arrow_dplyr_query</code>), qui décrivent des opérations à mener sur des données. C’est justement en utilisant <code><a href="https://dplyr.tidyverse.org/reference/compute.html">collect()</a></code> ou <code><a href="https://dplyr.tidyverse.org/reference/compute.html">compute()</a></code> qu’on demande à <code>arrow</code> d’exécuter ces requêtes avec le moteur <code>acero</code>.</li>
<li>Il est possible d’afficher le contenu des requêtes avec la fonction <code><a href="https://arrow.apache.org/docs/r/reference/show_exec_plan.html">show_exec_plan()</a></code>.
<ul>
<li>
<p>La première requête est très courte: elle ne contient que la description des données contenues dans le fichier Parquet partitionné.</p>
<div class="cell">
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Imprimer la première requête</span></span>
<span><span class="fu"><a href="https://arrow.apache.org/docs/r/reference/show_exec_plan.html">show_exec_plan</a></span><span class="op">(</span><span class="va">ds_bpe2018</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>ExecPlan with 3 nodes:
2:SinkNode{}
  1:ProjectNode{projection=[DEP, DEPCOM, DCIRIS, AN, TYPEQU, NB_EQUIP, REG]}
    0:SourceNode{}</code></pre>
</div>
</div>
</li>
<li>
<p>La deuxième requête est un peu plus longue, et si on regarde en détail, on constate deux choses. Premièrement, elle contient la première requête, mais elle n’a conservé que les variables utilisées dans le traitement (<code>NB_EQUIP</code> et <code>DEP</code>). C’est un exemple d’optimisation faite par <code>arrow</code>: le moteur <code>acero</code> a compris automatiquement qu’il suffisait de charger seulement deux variables pour réaliser le traitement. Deuxièmement, on retrouve tous les éléments du traitement (notamment le <code>group_by</code> et la somme), mais le traitement décrit en syntaxe <code>tidyverse</code> a été traduit automatiquement en fonctions internes d’<code>arrow</code> (la fonction <code>sum</code> est par exemple remplacée par <code>hash_sum</code>).</p>
<div class="cell">
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Imprimer la deuxième requête, qui contient la première</span></span>
<span><span class="fu"><a href="https://arrow.apache.org/docs/r/reference/show_exec_plan.html">show_exec_plan</a></span><span class="op">(</span><span class="va">eq_dep</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>ExecPlan with 4 nodes:
3:SinkNode{}
  2:GroupByNode{keys=["DEP"], aggregates=[
    hash_sum(NB_EQUIP_TOT, {skip_nulls=false, min_count=0}),
  ]}
    1:ProjectNode{projection=["NB_EQUIP_TOT": NB_EQUIP, DEP]}
      0:SourceNode{}</code></pre>
</div>
</div>
</li>
<li>
<p>Enfin, la troisième requête est encore plus longue, et contient les deux premières. Autrement dit, elle contient l’intégralité du traitement, donc on réalise l’intégralité du traitement lorsqu’on exécute cette requête avec <code>resultats |&gt; collect()</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Imprimer la troisième requête, qui contient les deux premières</span></span>
<span><span class="fu"><a href="https://arrow.apache.org/docs/r/reference/show_exec_plan.html">show_exec_plan</a></span><span class="op">(</span><span class="va">resultats</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>ExecPlan with 5 nodes:
4:SinkNode{}
  3:FilterNode{filter=(DEP == "59")}
    2:GroupByNode{keys=["DEP"], aggregates=[
        hash_sum(NB_EQUIP_TOT, {skip_nulls=false, min_count=0}),
    ]}
      1:ProjectNode{projection=["NB_EQUIP_TOT": NB_EQUIP, DEP]}
        0:SourceNode{}</code></pre>
</div>
</div>
</li>
</ul>
</li>
</ul></section><section id="quelles-sont-les-limites-de-lévaluation-différée" class="level4" data-number="19.4.1.2"><h4 data-number="19.4.1.2" class="anchored" data-anchor-id="quelles-sont-les-limites-de-lévaluation-différée">
<span class="header-section-number">19.4.1.2</span> Quelles sont les limites de l’évaluation différée?</h4>
<p>L’évaluation différée optimise les performances en minimisant la quantité de données chargées en RAM et la quantité de calculs effectivement réalisés. Avec cette vision en tête, on pourrait penser que la meilleure façon d’utiliser <code>arrow</code> est d’écrire un traitement entier en mode <em>lazy</em> (autrement dit, sans aucun <code><a href="https://dplyr.tidyverse.org/reference/compute.html">compute()</a></code> ni aucun <code><a href="https://dplyr.tidyverse.org/reference/compute.html">collect()</a></code> dans les étapes intermédiaires), et faire un unique <code><a href="https://dplyr.tidyverse.org/reference/compute.html">compute()</a></code> ou <code><a href="https://dplyr.tidyverse.org/reference/compute.html">collect()</a></code> tout à la fin du traitement, pour que toutes les opérations soient optimisées en une seule étape. Un traitement idéal ressemblerait alors à ceci:</p>
<div class="cell">
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Se connecter aux données</span></span>
<span><span class="va">data1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://arrow.apache.org/docs/r/reference/open_dataset.html">open_dataset</a></span><span class="op">(</span><span class="st">"data1.parquet"</span><span class="op">)</span></span>
<span><span class="va">data2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://arrow.apache.org/docs/r/reference/open_dataset.html">open_dataset</a></span><span class="op">(</span><span class="st">"data2.parquet"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Une première étape de traitement</span></span>
<span><span class="va">table_intermediaire1</span> <span class="op">&lt;-</span> <span class="va">data1</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="va">...</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Une deuxième étape de traitement</span></span>
<span><span class="va">table_intermediaire2</span> <span class="op">&lt;-</span> <span class="va">data2</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="va">...</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Et encore beaucoup d'autres étapes de traitement</span></span>
<span><span class="co"># avec beaucoup d'instructions...</span></span>
<span></span>
<span><span class="co"># La dernière étape du traitement</span></span>
<span><span class="va">resultats</span> <span class="op">&lt;-</span> <span class="va">table_intermediaire8</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span></span>
<span>    <span class="va">table_intermediaire9</span>, </span>
<span>    by <span class="op">=</span> <span class="st">"identifiant"</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html">compute</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  </span>
<span><span class="fu"><a href="https://arrow.apache.org/docs/r/reference/write_parquet.html">write_parquet</a></span><span class="op">(</span><span class="va">resultats</span>, <span class="st">"resultats.parquet"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>La réalité n’est malheureusement pas si simple, car <strong>l’évaluation différée a des limites</strong>. En effet, au moment de produire le résultat final de l’exemple précédent, la fonction <code><a href="https://dplyr.tidyverse.org/reference/compute.html">compute()</a></code> donne l’instruction au moteur <code>acero</code> d’analyser puis d’exécuter <em>l’intégralité du traitement en une seule fois</em> (le paragraphe précédent donne un exemple détaillé). Or, le moteur <code>acero</code> est certes puissant, mais il a ses limites et ne peut pas exécuter en une seule fois des traitements vraiment trop complexes. Par exemple, <code>acero</code> rencontre des difficultés lorsqu’on enchaîne de multiples jointures de tables volumineuses.</p>
<p><strong>Ces limites de l’évaluation différée peuvent provoquer des bugs violents</strong>. Lorsque le moteur <code>acero</code> échoue à exécuter une requête trop complexe, les conséquences sont brutales: <code>R</code> n’imprime aucun message d’erreur, la session <code>R</code> plante et il faut simplement redémarrer <code>R</code> et tout recommencer. Il est donc nécessaire de bien structurer le traitement pour profiter des avantages de l’évaluation différée sans en toucher les limites.</p>
</section><section id="décomposer-le-traitement-en-étapes-cohérentes-puis-le-tester" class="level4" data-number="19.4.1.3"><h4 data-number="19.4.1.3" class="anchored" data-anchor-id="décomposer-le-traitement-en-étapes-cohérentes-puis-le-tester">
<span class="header-section-number">19.4.1.3</span> Décomposer le traitement en étapes cohérentes, puis le tester</h4>
<p><strong>La solution évidente pour ne pas toucher les limites de l’évaluation différée consiste à décomposer le traitement en étapes</strong>, et à exécuter chaque étape séparément, en mettant un <code><a href="https://dplyr.tidyverse.org/reference/compute.html">compute()</a></code>. De cette façon, <code>acero</code> va réaliser séquentiellement plusieurs traitements un peu complexes, plutôt qu’échouer à réaliser un seul traitement très complexe en une seule fois.</p>
<p><strong>La vraie difficulté consiste à savoir quelle est la bonne longueur de ces étapes intermédiaires</strong>: s’il faut éviter de faire de très longues étapes (sinon l’évaluation différée plante), il faut également éviter d’exécuter une à une les étapes du traitement (sinon on perd les avantages de l’évaluation différée). Il n’y a pas de solution miracle, et seule la pratique permet de déterminer ce qui est raisonnable. Voici toutefois quelques conseils de bon sens:</p>
<ul>
<li>
<strong>Un point de départ raisonnable peut consister à définir des étapes de traitement qui ne dépassent pas 30 ou 40 lignes de code</strong>. Une étape de traitement de 200 lignes aura toutes les chances de poser des problèmes, d’autant qu’elle ne sera probablement pas très lisible.</li>
<li>
<strong>Il est préférable que le séquencement des étapes soit cohérent avec l’objet du traitement.</strong> Par exemple, si l’ensemble du traitement consiste à retraiter séparément deux tables, puis à les joindre, on peut imaginer trois étapes qui s’achèvent chacune par un <code><a href="https://dplyr.tidyverse.org/reference/compute.html">compute()</a></code>: le retraitement de la première table, le retraitement de la seconde table, et la jointure.</li>
<li>
<strong>Plus les données sont volumineuses, plus il faut être prudent avant de définir de longues étapes de traitement</strong>.</li>
<li>
<strong>Plus les opérations unitaires sont complexes, plus les étapes doivent être courtes.</strong> Par exemple, si les opérations sont des <code><a href="https://dplyr.tidyverse.org/reference/filter.html">filter()</a></code> et des <code><a href="https://dplyr.tidyverse.org/reference/select.html">select()</a></code>, il est possible d’en enchaîner un certain nombre en une seule étape de traitement sans aucun problème, car ces opérations sont simples. Inversement, une étape de traitement ne doit pas comprendre plus de trois ou quatre jointures (car les jointures sont des opérations complexes), en particulier si les tables sont volumineuses.</li>
</ul></section></section><section id="lire-des-fichiers-parquet-avec-open_dataset-plutôt-que-read_parquet" class="level3" data-number="19.4.2"><h3 data-number="19.4.2" class="anchored" data-anchor-id="lire-des-fichiers-parquet-avec-open_dataset-plutôt-que-read_parquet">
<span class="header-section-number">19.4.2</span> Lire des fichiers Parquet avec <code>open_dataset()</code> plutôt que <code>read_parquet()</code>
</h3>
<p><strong>Il est recommandé d’utiliser systématiquement la fonction <code><a href="https://arrow.apache.org/docs/r/reference/open_dataset.html">open_dataset()</a></code> plutôt que la fonction <code><a href="https://arrow.apache.org/docs/r/reference/read_parquet.html">read_parquet()</a></code> pour accéder à des données stockées en format Parquet.</strong> En effet, la fonction <code><a href="https://arrow.apache.org/docs/r/reference/open_dataset.html">open_dataset()</a></code> présente deux avantages:</p>
<ul>
<li>
<strong>Consommation mémoire inférieure</strong>: la fonction <code><a href="https://arrow.apache.org/docs/r/reference/open_dataset.html">open_dataset()</a></code> crée une connexion au fichier Parquet, mais elle n’importe pas les données contenues dans le fichier tant que l’utilisateur ne le demande pas avec <code><a href="https://dplyr.tidyverse.org/reference/compute.html">compute()</a></code> ou <code><a href="https://dplyr.tidyverse.org/reference/compute.html">collect()</a></code>, et elle est optimisée pour importer uniquement les données nécessaires au traitement. Inversement, la fonction <code><a href="https://arrow.apache.org/docs/r/reference/read_parquet.html">read_parquet()</a></code> importe immédiatement dans <code>R</code> toutes les données du fichier Parquet, y compris des données qui ne servent pas à la suite du traitement.</li>
<li>
<strong>Usage plus général</strong>: la fonction <code><a href="https://arrow.apache.org/docs/r/reference/open_dataset.html">open_dataset()</a></code> peut se connecter à un fichier Parquet unique, mais aussi à des fichiers Parquet partitionnés, tandis que <code><a href="https://arrow.apache.org/docs/r/reference/read_parquet.html">read_parquet()</a></code> ne peut pas lire ces derniers.</li>
</ul></section><section id="utiliser-des-objets-arrow-table-plutôt-que-des-data.frames" class="level3" data-number="19.4.3"><h3 data-number="19.4.3" class="anchored" data-anchor-id="utiliser-des-objets-arrow-table-plutôt-que-des-data.frames">
<span class="header-section-number">19.4.3</span> Utiliser des objets <code>Arrow Table</code> plutôt que des <code>data.frames</code>
</h3>
<p><strong>Lorsqu’on manipule des données volumineuses, il est essentiel de manipuler uniquement des objets <code>Arrow Table</code>, plutôt que des <code>data.frames</code> (ou des <code>tibbles</code>)</strong>. Cela implique deux recommandations:</p>
<ul>
<li><p><strong>Importer les données directement dans des <code>Arrow Table</code>, ou à défaut convertir en <code>Arrow Table</code> avec la fonction <code><a href="https://arrow.apache.org/docs/r/reference/as_arrow_table.html">as_arrow_table()</a></code>.</strong> Par exemple, lorsqu’on importe un fichier Parquet avec la fonction <code><a href="https://arrow.apache.org/docs/r/reference/read_parquet.html">read_parquet()</a></code> ou un fichier csv avec la fonction <code><a href="https://arrow.apache.org/docs/r/reference/read_delim_arrow.html">read_csv_arrow()</a></code>, il est recommandé d’utiliser l’option <code>as_data_frame = FALSE</code> pour que les données soient importées sous forme de <code>Arrow Table</code>.</p></li>
<li>
<p><strong>Utiliser systématiquement <code><a href="https://dplyr.tidyverse.org/reference/compute.html">compute()</a></code> plutôt que <code><a href="https://dplyr.tidyverse.org/reference/compute.html">collect()</a></code> dans les étapes de calcul intermédiaires.</strong> Cette recommandation est particulièrement importante.</p>
<p>L’exemple suivant explique pourquoi il est préférable d’utiliser <code><a href="https://dplyr.tidyverse.org/reference/compute.html">compute()</a></code> dans les étapes intermédiaires:</p>
</li>
</ul>
<div class="columns">
<div class="column" style="width:49%;">
<p><strong>Situation à éviter</strong></p>
<p>La première étape de traitement est déclenchée par <code><a href="https://dplyr.tidyverse.org/reference/compute.html">collect()</a></code>, la table intermédiaire <code>res_etape1</code> est donc un <code>tibble</code>. C’est le moteur d’exécution de <code>dplyr</code> qui est utilisé pour manipuler <code>res_etape1</code> lors de la seconde étape, ce qui dégrade fortement les performances sur données volumineuses.</p>
<div class="cell">
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Etape 1</span></span>
<span><span class="va">res_etape1</span> <span class="op">&lt;-</span> <span class="va">bpe_ens_2018_tbl</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">DEP</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span></span>
<span>    NB_EQUIP_TOT <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">NB_EQUIP</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html">collect</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Etape 2</span></span>
<span><span class="va">res_final</span> <span class="op">&lt;-</span> <span class="va">res_etape1</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">DEP</span> <span class="op">==</span> <span class="st">"59"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html">collect</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Sauvegarder les résultats</span></span>
<span><span class="fu"><a href="https://arrow.apache.org/docs/r/reference/write_parquet.html">write_parquet</a></span><span class="op">(</span><span class="va">res_final</span>, <span class="st">"resultats.parquet"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div><div class="column" style="width:2%;">
<!-- empty column to create gap -->
</div><div class="column" style="width:49%;">
<p><strong>Usage recommandé</strong></p>
<p>La première étape de traitement est déclenchée par <code><a href="https://dplyr.tidyverse.org/reference/compute.html">compute()</a></code>, la table intermédiaire <code>res_etape1</code> est donc un <code>Arrow Table</code>. C’est le moteur d’exécution <code>acero</code> qui est utilisé pour manipuler <code>res_etape1</code> lors de la seconde étape, ce qui assure de bonnes performances notamment sur données volumineuses.</p>
<div class="cell">
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Etape 1</span></span>
<span><span class="va">res_etape1</span> <span class="op">&lt;-</span> <span class="va">bpe_ens_2018_tbl</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">DEP</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span></span>
<span>    NB_EQUIP_TOT <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">NB_EQUIP</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html">compute</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Etape 2</span></span>
<span><span class="va">res_final</span> <span class="op">&lt;-</span> <span class="va">res_etape1</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">DEP</span> <span class="op">==</span> <span class="st">"59"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html">compute</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Sauvegarder les résultats</span></span>
<span><span class="fu"><a href="https://arrow.apache.org/docs/r/reference/write_parquet.html">write_parquet</a></span><span class="op">(</span><span class="va">res_final</span>, <span class="st">"resultats.parquet"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>Si vous ne savez plus si une table de données est un <code>Arrow Table</code> ou un <code>tibble</code>, il suffit d’exécuter <code>class(le_nom_de_ma_table)</code>. Si la table est un <code>Arrow Table</code>, vous obtiendrez ceci: <code>"Table"        "ArrowTabular" "ArrowObject"  "R6"</code>. Si elle est un <code>tibble</code>, vous obtiendrez <code>"tbl_df"     "tbl"        "data.frame"</code>.</p>
</div>
</div>
</section><section id="surveiller-la-consommation-de-ram-de-r" class="level3" data-number="19.4.4"><h3 data-number="19.4.4" class="anchored" data-anchor-id="surveiller-la-consommation-de-ram-de-r">
<span class="header-section-number">19.4.4</span> Surveiller la consommation de RAM de <code>R</code>
</h3>
<p>Comme expliqué plus haut, les <code>Arrow Table</code> ne sont pas des objets <code>R</code> standards, mais des objets C++ qui peuvent être manipulés avec <code>R</code> via <code>arrow</code>. En pratique, cela signifie que <code>R</code> n’a qu’un contrôle partiel sur la RAM occupé par <code>arrow</code>, et ne parvient pas toujours à libérer la RAM qu’<code>arrow</code> a utilisée temporairement pour réaliser un traitement. En particulier, <strong>la fonction <code><a href="https://rdrr.io/r/base/gc.html">gc()</a></code> ne permet pas de libérer la RAM qu’<code>arrow</code> a utilisée temporairement</strong>. Cette imperfection de la gestion de la RAM implique deux choses:</p>
<ul>
<li>Si on travaille sur des données volumineuses, <strong>il est important de surveiller fréquemment sa consommation de RAM pour s’assurer qu’elle n’est pas excessive</strong> (cf.&nbsp;fiche <a href="../01_R_Insee/Fiche_utiliser_ressources.html">Superviser sa session <code>R</code></a>) ;</li>
<li>Si la consommation de RAM devient très élevée, <strong>la seule solution semble être de redémarrer la session <code>R</code></strong>. En pratique, redémarrer la session <code>R</code> ne fait pas perdre plus de quelques minutes, car grâce à <code>arrow</code> et Parquet le chargement des données est très rapide.</li>
</ul></section></section><section id="notions-avancées" class="level2" data-number="19.5"><h2 data-number="19.5" class="anchored" data-anchor-id="notions-avancées">
<span class="header-section-number">19.5</span> Notions avancées</h2>
<section id="sec-limites-arrow" class="level3" data-number="19.5.1"><h3 data-number="19.5.1" class="anchored" data-anchor-id="sec-limites-arrow">
<span class="header-section-number">19.5.1</span> Connaître les limites d’<code>arrow</code>
</h3>
<p>Le projet <code>arrow</code> est relativement récent et en développement actif. Il n’est donc pas surprenant qu’il y ait parfois des bugs, et que certaines fonctions standards de <code>R</code> ne soient pas encore disponibles en <code>arrow</code>. Il est important de connaître les quelques limites d’<code>arrow</code> pour savoir comment les contourner. Voici quatre limites d’<code>arrow</code> à la date de rédaction de cette fiche (janvier 2024):</p>
<ul>
<li><p>les <strong>jointures de tables volumineuses</strong>: <code>arrow</code> ne parvient pas à joindre des tables de données très volumineuses; il est préférable d’utiliser <code>duckdb</code> pour ce type d’opération;</p></li>
<li><p>les <strong>réorganisations de données</strong> (<em>wide-to-long</em> et <em>long-to-wide</em>): il n’existe pas à ce jour dans <code>arrow</code> de fonctions pour réorganiser une table de données (comme <code>pivot_wider</code> et <code>pivot_longer</code> du <em>package</em> <code>tidyr</code>).</p></li>
<li>
<p>les <strong>fonctions fenêtre</strong> (<em>window functions</em>): <code>arrow</code> ne permet pas d’ajouter directement à une table des informations issues d’une agrégation par groupe de la même table. Par exemple, <code>arrow</code> ne peut pas ajouter directement à la base permanente des équipements une colonne égale au nombre total d’équipements du département:</p>
<div class="cell">
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Arrow ne peut pas exécuter ceci</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="va">bpe_ens_2018_arrow</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">DEP</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    NB_EQUIP_TOTAL_DEP  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">NB_EQUIP</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html">compute</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</li>
<li>
<p>les <strong>empilements de tables</strong>: il est facile d’empiler plusieurs <code>tibbles</code> avec <code>dplyr</code> grâce à la fonction <code><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows()</a></code>: <code>bind_rows(table1, table2, table3, table4)</code>. En revanche, il n’existe pas à ce jour de fonction similaire dans <code>arrow</code>. Les fonctions <code>union</code> et <code>union_all</code> permettent d’empiler seulement deux <code>Arrow Table</code>, donc pour empiler plusieurs <code>Arrow Tables</code> il faut appeler plusieurs fois ces fonctions. Par ailleurs, les deux <code>Arrow Table</code> doivent être parfaitement compatibles pour être empilés (il faut le même nombre de colonnes avec le même nom et le même type, ce qui n’est pas toujours le cas en pratique).</p>
<div class="cell">
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Comment empiler de multiples Arrow Tables</span></span>
<span><span class="va">resultats</span> <span class="op">&lt;-</span> <span class="va">table1</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/setops.html">union</a></span><span class="op">(</span><span class="va">table2</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/setops.html">union</a></span><span class="op">(</span><span class="va">table3</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/setops.html">union</a></span><span class="op">(</span><span class="va">table4</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html">compute</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</li>
</ul></section><section id="surmonter-le-problème-des-fonctions-non-supportées-par-acero" class="level3" data-number="19.5.2"><h3 data-number="19.5.2" class="anchored" data-anchor-id="surmonter-le-problème-des-fonctions-non-supportées-par-acero">
<span class="header-section-number">19.5.2</span> Surmonter le problème des fonctions non supportées par <code>acero</code>
</h3>
<p><strong>Lorsqu’on manipule des données avec <code>arrow</code>, il arrive fréquemment qu’on écrive un traitement que le moteur d’exécution <code>acero</code> n’arrive pas à exécuter.</strong> En ce cas, <code>R</code> renonce à manipuler les données sous forme de <code>Arrow Table</code> avec le moteur <code>acero</code>, convertit les données en <code>tibble</code> et poursuit le traitement avec le moteur d’exécution de <code>dplyr</code> (comme un traitement <code>dplyr</code> standard). <code>R</code> signale systématiquement le recours à cette solution de repli par un message d’erreur qui se termine par <code>pulling data into R</code>.</p>
<p>Le recours à cette solution de repli a pour conséquence de dégrader fortement les performances (car le moteur de <code>dplyr</code> est moins efficace qu’<code>acero</code>). <strong>Il est donc préférable d’essayer de réécrire la partie du traitement qui pose problème avec des fonctions supportées par <code>acero</code>.</strong> Cela est particulièrement recommandé si les données manipulées sont volumineuses ou si le traitement concerné doit être exécuté fréquemment.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>Il arrive qu’il soit impossible de trouver une solution entièrement supportée par <code>acero</code>, ou que la solution soit vraiment trop complexe à écrire. Ce n’est pas une catastrophe: en dernier recours, on peut tout à fait convertir temporairement les données en <code>tibble</code> (avec <code><a href="https://dplyr.tidyverse.org/reference/compute.html">collect()</a></code>) et exécuter le traitement qui pose problème avec <code>dplyr</code>. Le traitement sera simplement plus lent (voire beaucoup plus lent). En revanche, il est important de reconvertir ensuite les données en <code>Arrow Table</code> le plus vite possible, en utilisant la fonction <code><a href="https://arrow.apache.org/docs/r/reference/as_arrow_table.html">as_arrow_table()</a></code>.</p>
</div>
</div>
<section id="une-solution-simple-existe-t-elle" class="level4" data-number="19.5.2.1"><h4 data-number="19.5.2.1" class="anchored" data-anchor-id="une-solution-simple-existe-t-elle">
<span class="header-section-number">19.5.2.1</span> Une solution simple existe-t-elle?</h4>
<p>Dans la plupart des cas, il est possible de trouver une solution simple pour écrire un traitement que le moteur <code>acero</code> peut exécuter. Voici quelques pistes:</p>
<ul>
<li>Vérifier qu’on utilise la dernière version d’<code>arrow</code> et mettre à jour le <em>package</em> si ce n’est pas le cas;</li>
<li>Étudier en détail le message d’erreur renvoyé par <code>R</code> pour bien comprendre d’où vient le problème;</li>
<li>Regarder la <a href="https://arrow.apache.org/docs/dev/r/reference/acero.html">liste des fonctions du <em>tidyverse</em> supportées par <code>acero</code></a> pour voir s’il est possible d’utiliser une fonction supportée par <code>acero</code>;</li>
<li>Faire des tests pour pour voir si une réécriture mineure du traitement peut régler le problème.</li>
</ul>
<p>L’exemple qui suit montre que la solution peut être très simple, même lorsque l’erreur semble complexe. Dans cet exemple, on veut calculer le nombre de boulangeries (<code>TYPEQU == "B203"</code>) et de poissonneries (<code>TYPEQU == "B206"</code>) dans chaque département, en stockant les résultats dans un <code>Arrow Table</code> (avec <code><a href="https://dplyr.tidyverse.org/reference/compute.html">compute()</a></code>). Malheureusement, <code>acero</code> ne parvient pas à réaliser ce traitement, et <code>R</code> est contraint de convertir les données en <code>tibble</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">resultats</span> <span class="op">&lt;-</span> <span class="va">bpe_ens_2018_arrow</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">DEP</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span></span>
<span>    nb_boulangeries  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">NB_EQUIP</span> <span class="op">*</span> <span class="op">(</span><span class="va">TYPEQU</span> <span class="op">==</span> <span class="st">"B203"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    nb_poissonneries <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">NB_EQUIP</span> <span class="op">*</span> <span class="op">(</span><span class="va">TYPEQU</span> <span class="op">==</span> <span class="st">"B206"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html">compute</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Le message d’erreur renvoyé par <code>R</code> est la suivante: <code>! NotImplemented: Function 'multiply_checked' has no kernel matching input types (double, bool); pulling data into R</code>. En lisant attentivement le message d’erreur et en le rapprochant du traitement, on finit par comprendre que l’erreur vient de l’opération <code>sum(NB_EQUIP * (TYPEQU == "B203"))</code>: <code>arrow</code> ne parvient pas à faire la multiplication entre <code>NB_EQUIP</code> (un nombre réel) et <code>(TYPEQU == "B203")</code> (un booléen). La solution est très simple: il suffit de convertir <code>(TYPEQU == "B203")</code> en nombre entier avec la fonction <code><a href="https://rdrr.io/r/base/integer.html">as.integer()</a></code> qui est supportée par <code>acero</code>. Le code suivant peut alors être entièrement exécuté par <code>acero</code>:</p>
<div class="cell">
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">resultats</span> <span class="op">&lt;-</span> <span class="va">bpe_ens_2018_arrow</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">DEP</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span></span>
<span>    nb_boulangeries  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">NB_EQUIP</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="va">TYPEQU</span> <span class="op">==</span> <span class="st">"B203"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    nb_poissonneries <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">NB_EQUIP</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="va">TYPEQU</span> <span class="op">==</span> <span class="st">"B206"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html">compute</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="passer-par-duckdb" class="level4" data-number="19.5.2.2"><h4 data-number="19.5.2.2" class="anchored" data-anchor-id="passer-par-duckdb">
<span class="header-section-number">19.5.2.2</span> Passer par <code>duckdb</code>
</h4>
<p>Il arrive qu’il ne soit pas possible de résoudre le problème en réécrivant légèrement le traitement. <strong>Une autre solution peut consister à passer par <code>duckdb</code>, qui permet de manipuler directement des objets <code>Arrow Table</code> de façon simple et transparente.</strong> Dans l’exemple suivant, on veut ajouter à la base permanente des équipements une colonne égale au nombre total d’équipements du département. Cette opération ne peut pas être exécutée par <code>arrow</code> (voir le paragraphe <a href="#sec-limites-arrow" class="quarto-xref"><span>Section 19.5.1</span></a>), contrairement à <code>duckdb</code>. Voici comment faire avec <code>duckdb</code>:</p>
<div class="cell">
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://duckdb.org/">duckdb</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="va">bpe_ens_2018_arrow</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://arrow.apache.org/docs/r/reference/to_duckdb.html">to_duckdb</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">DEP</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    NB_EQUIP_TOTAL_DEP  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">NB_EQUIP</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://arrow.apache.org/docs/r/reference/to_arrow.html">to_arrow</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html">compute</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Cet exemple appelle trois commentaires:</p>
<ul>
<li>La fonction <code><a href="https://arrow.apache.org/docs/r/reference/to_duckdb.html">to_duckdb()</a></code> sert à ce que <code>duckdb</code> puisse accéder à l’objet <code>Arrow Table</code>;</li>
<li>Symétriquement, la fonction <code><a href="https://arrow.apache.org/docs/r/reference/to_arrow.html">to_arrow()</a></code> sert à remettre les données dans un objet <code>Arrow Table</code>;</li>
<li>Les instructions figurant entre ces deux étapes (le <code><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by()</a></code> puis le <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code>) sont exécutées par le moteur d’exécution de <code>duckdb</code>, de façon complètement transparente pour l’utilisateur.</li>
</ul></section><section id="définir-soi-même-des-fonctions-arrow-utilisation-avancée" class="level4" data-number="19.5.2.3"><h4 data-number="19.5.2.3" class="anchored" data-anchor-id="définir-soi-même-des-fonctions-arrow-utilisation-avancée">
<span class="header-section-number">19.5.2.3</span> Définir soi-même des fonctions <code>arrow</code> (utilisation avancée)</h4>
<p>Si les pistes mentionnées précédemment ne fournissent pas de solution simple, il est possible d’aller plus loin et d’écrire ses propres fonctions <code>arrow</code>. Cette approche permet de faire beaucoup plus de choses mais elle nécessite de bien comprendre le fonctionnement d’<code>arrow</code> et les fonctions internes de la librairie <code>libarrow</code>. Il s’agit d’une utilisation avancée d’<code>arrow</code> qui dépasse le cadre de la documentation <code>utilitR</code>. Les lecteurs intéressés pourront consulter les deux ressources suivantes:</p>
<ul>
<li>
<a href="https://blog.djnavarro.net/posts/2022-01-18_binding-arrow-to-r/">un post de blog qui décrit en détail les liens entre <code>libarrow</code> et <code>R</code></a> (en anglais);</li>
<li>la partie du <a href="https://arrow.apache.org/cookbook/r/manipulating-data---tables.html#use-arrow-functions-in-dplyr-verbs-in-arrow"><code>Apache Arrow R Cookbook</code></a> qui porte sur les <code>Arrow functions</code>.</li>
</ul></section></section></section><section id="sec-template-arrow" class="level2" data-number="19.6"><h2 data-number="19.6" class="anchored" data-anchor-id="sec-template-arrow">
<span class="header-section-number">19.6</span> Un exemple de traitement de données avec <code>arrow</code>
</h2>
<p>Le code ci-dessous propose un exemple de traitement de données avec <code>arrow</code> qui suit les recommandations et conseils de la présente fiche. Vous pouvez le copier-coller et vous en inspirer pour construire vos propres traitements!</p>
<div class="cell">
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/apache/arrow/">arrow</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Autoriser arrow à utiliser plusieurs processeurs en parallèle</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span><span class="op">(</span>arrow.use_threads <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co"># Définir le nombre de processeurs qu'arrow peut utiliser - ici on prend la partie entière du nombre de processeurs disponibles divisé par 4</span></span>
<span><span class="fu">arrow</span><span class="fu">::</span><span class="fu"><a href="https://arrow.apache.org/docs/r/reference/cpu_count.html">set_cpu_count</a></span><span class="op">(</span><span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html">detectCores</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html">%/%</a></span> <span class="fl">4</span><span class="op">)</span></span>
<span></span>
<span><span class="co">##################</span></span>
<span><span class="co">### Se connecter aux données</span></span>
<span><span class="co">### Conseil: utiliser open_dataset() plutôt que read_parquet()</span></span>
<span><span class="co">##################</span></span>
<span></span>
<span><span class="co"># Cas 1: se connecter à un unique fichier Parquet</span></span>
<span><span class="va">dataset1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://arrow.apache.org/docs/r/reference/open_dataset.html">open_dataset</a></span><span class="op">(</span><span class="st">"mon/beau/dossier/dataset1.parquet"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Cas 2: se connecter à un fichier Parquet partitionné par la variable DEP</span></span>
<span><span class="va">dataset2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://arrow.apache.org/docs/r/reference/open_dataset.html">open_dataset</a></span><span class="op">(</span></span>
<span>  <span class="st">"mon/beau/dossier/dataset2/"</span>,</span>
<span>  partitioning <span class="op">=</span> <span class="fu"><a href="https://arrow.apache.org/docs/r/reference/schema.html">schema</a></span><span class="op">(</span></span>
<span>    DEP <span class="op">=</span> <span class="fu"><a href="https://arrow.apache.org/docs/r/reference/data-type.html">utf8</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co">##################</span></span>
<span><span class="co">### Faire les traitements</span></span>
<span><span class="co">### Conseils: </span></span>
<span><span class="co">### - Faire des étapes de traitement de 30-40 lignes, suivies d'un compute()</span></span>
<span><span class="co">### - Ne pas utiliser collect() dans les calculs intermédiaires sur des données volumineuses</span></span>
<span><span class="co">### - Faire attention à suivre la consommation de RAM</span></span>
<span><span class="co">##################</span></span>
<span></span>
<span><span class="co"># Une première étape de traitement portant sur le dataset1</span></span>
<span><span class="va">table_intermediaire1</span> <span class="op">&lt;-</span> <span class="va">dataset1</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html">compute</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Une première étape de traitement portant sur le dataset2</span></span>
<span><span class="va">table_intermediaire2</span> <span class="op">&lt;-</span> <span class="va">dataset2</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html">compute</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Et encore beaucoup d'autres étapes de traitement</span></span>
<span><span class="co"># avec beaucoup d'instructions...</span></span>
<span></span>
<span><span class="co"># La dernière étape du traitement</span></span>
<span><span class="va">resultat_final</span> <span class="op">&lt;-</span> <span class="va">table_intermediaire8</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span></span>
<span>    <span class="va">table_intermediaire9</span>, </span>
<span>    by <span class="op">=</span> <span class="st">"identifiant"</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html">compute</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co">##################</span></span>
<span><span class="co">### Visualiser un extrait d'une table intermédiaire</span></span>
<span><span class="co">### Vous pouvez utiliser collect() sur un extrait des données</span></span>
<span><span class="co">##################</span></span>
<span></span>
<span><span class="va">extrait_table2</span> <span class="op">&lt;-</span> <span class="va">table_intermediaire2</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice_head</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html">collect</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/View.html">View</a></span><span class="op">(</span><span class="va">extrait_table2</span><span class="op">)</span></span>
<span></span>
<span><span class="co">##################</span></span>
<span><span class="co">### Visualiser les résultats finaux sous forme de tibble</span></span>
<span><span class="co">### Vous pouvez utiliser collect() sur de petites données</span></span>
<span><span class="co">##################</span></span>
<span></span>
<span><span class="va">resultat_final_tbl</span> <span class="op">&lt;-</span> <span class="va">resultat_final</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html">collect</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co">##################</span></span>
<span><span class="co">### Exporter les résultats</span></span>
<span><span class="co">### Conseil: partitionner les fichiers Parquet si les données sont volumineuses</span></span>
<span><span class="co">##################</span></span>
<span></span>
<span><span class="co"># Cas 1: exporter les résultats sous la forme d'un unique fichier Parquet</span></span>
<span><span class="fu"><a href="https://arrow.apache.org/docs/r/reference/write_parquet.html">write_parquet</a></span><span class="op">(</span><span class="va">resultat_final</span>, <span class="st">"mon/dossier/de/sortie/resultat_final.parquet"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Cas 2: exporter les résultats sous la forme d'un fichier Parquet par les variables DEP et annee</span></span>
<span><span class="fu"><a href="https://arrow.apache.org/docs/r/reference/write_dataset.html">write_dataset</a></span><span class="op">(</span></span>
<span>  <span class="va">resultat_final</span>, </span>
<span>  <span class="st">"mon/dossier/de/sortie/resultat_final/"</span>,</span>
<span>  format<span class="op">=</span> <span class="st">"parquet"</span>,</span>
<span>  hive_style <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  partitioning <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"DEP"</span>, <span class="st">"annee"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="RessourcesArrow" class="level2" data-number="19.7"><h2 data-number="19.7" class="anchored" data-anchor-id="RessourcesArrow">
<span class="header-section-number">19.7</span> Pour en savoir plus</h2>
<ul>
<li>la documentation officielle du <em>package</em> <a href="https://arrow.apache.org/docs/dev/r/index.html"><code>arrow</code></a> (en anglais);</li>
<li>
<a href="https://blog.djnavarro.net/posts/2022-01-18_binding-arrow-to-r/">un post de blog qui décrit en détail les liens entre <code>libarrow</code> et <code>R</code></a> (en anglais);</li>
<li>la <a href="https://arrow.apache.org/docs/dev/r/reference/acero.html">liste</a> des fonctions du <em>tidyverse</em> supportées par <code>acero</code>.</li>
</ul>


</section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="../03_Fiches_thematiques/Fiche_datatable.html" class="pagination-link  aria-label=" des="" donn="" avec="">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Manipuler des données avec <code>data.table</code></span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../03_Fiches_thematiques/Fiche_duckdb.html" class="pagination-link" aria-label="<span class='chapter-number'>20</span>&nbsp; <span class='chapter-title'>Manipuler des données avec `duckdb`</span>">
        <span class="nav-page-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Manipuler des données avec <code>duckdb</code></span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-left">
<p>This book was built with <a href="https://quarto.org/">Quarto</a>.</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    <div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/InseeFrLab/utilitR/edit/master/03_Fiches_thematiques/Fiche_arrow.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/InseeFrLab/utilitR/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div>
    <div class="nav-footer-right">
<li>
<a href="https://github.com/InseeFrLab/utilitR.git" target="blank">Code source</a>
</li>
</div>
  </div>
</footer>


</body></html>