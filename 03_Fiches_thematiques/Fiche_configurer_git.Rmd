# Configurer `Git` sur son poste de travail {#git-config}

## Tâches concernées et recommandations

L'utilisateur souhaite versionner son projet depuis son poste de travail en ayant recours pour cela à un dépôt distant, disponible sur un espace type `Gitlab` ou `Github`. 

L'utilisation du logiciel `Git` en local, qui relève plutôt de l'usage quotidien du logiciel, est reportée dans une fiche dédiée ([Utiliser Git avec RStudio](#git)). 

::: recommandation
* Pour interagir avec un dépôt `Git` distant, l'utilisateur a le choix
entre deux protocoles de connexion, `SSH` ou `HTTPS`: 
* Le
protocole `SSH` est déconseillé en faveur du protocole `HTTPS` (qui ne requiert
que de configurer un mot de passe sur le dépôt distant) ;
* Plutôt qu'utiliser un mot de passe pour s'authentifier en `HTTPS`, il est
recommandé de s'authentifier avec des jetons personnels d'accès
(*personnel access tokens*).
:::

## Les différentes forges utilisables

Une `r with_def("forges")` est un espace informatique en ligne qui accueille des dépôts distants. Un dépôt distant (_remote repository_ en anglais) est un dossier que vous pouvez utiliser pour stocker vos codes (et leur historique), et pour partager des codes avec vos collègues ou stocker vos codes personnels.

Une forge prend généralement forme d'un site internet. Il existe deux forges principales :

* Github (accessible sur le Web, à l'adresse <https://github.com>), qui appartient à une entreprise privée ;
* Gitlab qui se décline sous différentes formes :
    + une version publique, disponible sur <https://gitlab.com>, qui propose les fonctionnalités principales de versionnage du code mais également des fonctionnalités supplémentaires (discussions, mise à disposition de machines (*runners*) pour tester des scripts...) ;
    + des versions internes, qui reprennent la majorité des fonctionnalités de la version publique mais proposent des machines (appelées *runners*) internes. Celles-ci ne sont pas forcément ouvertes sur internet.   

Les forges proposent des fonctionnalités précieuses pour gérer un projet impliquant du code ou de la documentation. La formation
[Travail collaboratif avec R](https://linogaliana.gitlab.io/collaboratif/git.html) décrit ces fonctionnalités de manière plus détaillée.

::: specificite
Une forge interne `Gitlab` est disponible sous AUS. Son adresse, ainsi que des éléments complémentaires à cette fiche, sont disponibles dans la documentation AUS (`Y:/Documentation/AUSV3/`).
:::

::: remarque
Une instance `Gitlab` est disponible sur le SSP Cloud [https://git.lab.sspcloud.fr/] avec laquelle peut interagir un service `RStudio` [lien vers fiche quand elle sera là], et vous pouvez l'utiliser si vous le souhaitez. Toutefois, le SSP Cloud est une plateforme connetée à Internet et a donc accès aux dépôts hébergés sur <https://gitlab.com> ou <https://github.com>. Il est donc conseillé d'utiliser ces deux `r with_def("forges")` plutôt que <https://git.lab.sspcloud.fr/> dont la pérennité n'est pas assurée à long terme.
:::


La suite de cette fiche décrit l'utilisation d'un dépôt distant sur une forge de type
`Gitlab`. Néanmoins, la procédure pour configurer l'interaction avec un
dépôt distant situé sur `Github` est très similaire, ce qui est illustré
dans la fiche [Utiliser Git avec RStudio](#git).

## Installer Git sur son poste de travail {#git-install}

Pour intéragir avec un dépôt distant sur `Gitlab` ou `Github`, il est nécessaire
d'utiliser un outil de contrôle de version. Le plus utilisé est le logiciel `Git`.

Avant d'essayer d'installer `Git`, le premier réflexe est de vérifier
qu'il n'est pas déjà disponible... 
Sur un serveur partagé comme AUS, ou sur une architecture comme le SSP-cloud,
il n'est pas nécessaire d'installer `Git` puisque celui-ci est déjà disponible
et configuré.

Si `Git` n'est pas disponible, pour l'installer, il suffit
d'installer le logiciel récupéré sur le
[site web officiel](http://git-scm.com/download/win). Une fois le logiciel
installé, il est possible de le retrouver dans le menu Démarrer, rubrique Git.
L'utilisateur y trouvera plusieurs outils, dont un outil de ligne
de commande (`Git Bash`) et une interface (`Git GUI`). 

## Interaction avec un dépôt distant : principe

[METTRE UN JOLI SCHEMA A PARTIR DE COLLABORATIF QUAND IL SERA PRET]

`Git` est un système décentralisé de contrôle de version: les fichiers sont
modifiés sur les postes de travail et sont mis, à un moment voulu, en 
conformité avec la version collective disponible sur le dépôt distant. 

Il est ainsi nécessaire d'avoir une identité pour reconnaître l'auteur d'une 
modification à un moment donné. Pour que `Gitlab` reconnaisse un utilisateur
suggérant des modifications, il est nécessaire de s'authentifier 
(un dépôt, même public, ne peut pas être modifié par n'importe qui). 
L'authentification consiste ainsi à fournir un élément que seul vous et 
la forge sont censés connaître: un mot de passe, une clé compliquée, un jeton d'accès...

Plus précisément, il existe deux modalités pour faire connaître son identité à `Gitlab`:

* une authentification HTTPS ([décrite ici](git-connexion-https)): l'authentification se fait grâce au login et au mot de passe à chaque
interaction avec le dépôt. Les jetons d'accès sont à privilégier: ils permettent de s'authentifier, sont révocables et ne bénéficient pas des super-pouvoirs qu'octroie un mot de passe comme changer le nom d'un dépôt voire le supprimer. Plus d'éléments sont disponibles [ici](https://happygitwithr.com/credential-caching.html#get-a-pat)
* une authentification SSH: l'authentification se fait par une clé cryptée disponible sur le poste de travail et que `Github` ou `Gitlab` connaît. Une fois configurée, cette méthode ne nécessite plus de faire connaître son identité: l'empreinte digitale que constitue la clé suffit à reconnaître un utilisateur. 

::: remarque
Ne jamais stocker un token, et encore moins son mot de passe, dans un projet. Un token peut être stocké dans un système de gestion de mot de passe comme [Keepass](https://keepass.fr/)
:::

La méthode SSH peut être laborieuse à mettre en place même si elle donne un 
confort supplémentaire (ne pas avoir à taper login et mot de passe à chaque interaction). Cependant, la méthode HTTPS est préférable car

* elle n'implique pas de configuration ;
* elle n'est pas bloquée par des pare-feux, contrairement à la méthode SSH. Par exemple, il est impossible sur un poste Insee d'interagir avec un dépôt sur <https://gitlab.com> ou <https://github.com> en SSH ;
* il est possible de conserver en mémoire ses identifiants un certain temps (grâce au `git credentials helper`) pour ne pas taper à chaque fois ses identifiants.


## Configurer l'accès à dépôt distant en `HTTPS` {#git-connexion-https}

::: specificite

Le `Gitlab` interne de l'Insee ne permet pas ce mode d'authentification. 
Il convient d'utiliser l'[authentification SSH](#git-connexion-ssh)

:::

### Démarche générale

Pour interagir avec un dépôt distant en utilisant le protocole `HTTPS`, il suffit de configurer le mot de passe dans `Gitlab`, en allant dans `Preferences > Password`, comme indiqué dans la capture d'écran ci-dessous :

```{r, echo = FALSE, out.width = '100%'}
utilitr::include_image("./pics/config_git/password_conf.png", compression = FALSE)
```

Une fois le mot de passe configuré, il ne reste plus
qu'à `r with_def("cloner")` le dépôt distant sur lequel on veut travailler,
par exemple depuis `RStudio`, suivant le protocole décrit dans la fiche [Utiliser Git avec RStudio](#git), en ayant pris soin de sélectionner l'URL correspondant
au protocole `HTTPS`, comme ci-dessous :

```{r, echo = FALSE, out.width = '100%'}
utilitr::include_image("./pics/config_git/clone_https.png", compression = FALSE)
```

Au moment du clônage, l'utilisateur est invité à entrer son identifiant
(celui de son profil Gitlab avec lequel il accède au dépôt distant), ainsi que
son mot de passe (celui qu'il aura donc spécifié dans son compte Gitlab).

::: conseil
Selon le niveau de visibilité fixé par le propriétaire du dépôt distant, il est possible qu'il ne soit pas nécessaire de s'identifier au moment du clônage (c'est le cas pour les dépôts publics). En revanche, si le niveau de visibilité du dépôt est plus élevé (niveau privé), il se peut qu'il soit impossible à l'utilisateur de clôner le dépôt ; dans ce cas, il ne lui sera pas non plus possible de visualiser ce dernier dans Gitlab. Il faut alors contacter le propriétaire du dépôt pour lui en demander l'accès.
:::

### Définir un jeton d'accès

#### Sur Gitlab

Dans `Gitlab`, en haut à droite de la page, cliquer sur `Edit profile`

```{r, echo = FALSE, out.width = '100%'}
utilitr::include_image("./pics/config_git/config_pat_gitlab1.png", compression = FALSE)
```

Dans le bandeau à gauche, cliquer sur `Access Tokens`:

```{r, echo = FALSE, out.width = '50%'}
utilitr::include_image("./pics/config_git/config_pat_gitlab2.png", compression = FALSE)
```

Choisir un nom (par exemple `PAT_GITLAB`, mais ce n'est pas un nom obligatoire) et
des droits associés. Les droits `read_repository` et `write_repository`
permettent d'effectuer les routines décrites dans la fiche 
[Utilisation Git avec RStudio](#git).


```{r, echo = FALSE, out.width = '100%'}
utilitr::include_image("./pics/config_git/config_pat_gitlab3.png", compression = FALSE)
```

Après avoir validé, le jeton s'affiche afin de la récupérer et le stocker dans
un endroit sécurisé (par exemple un gestionnaire de mot de passes). Attention,
ce sera la seule fois qu'il sera visible.


```{r, echo = FALSE, out.width = '100%'}
utilitr::include_image("./pics/config_git/config_pat_gitlab4.png", compression = FALSE)
```

Plus bas sur la page, il est possible de voir l'ensemble des jetons utilisés, 
la date de dernière utilisation. C'est aussi ici que peut être supprimé le 
jeton en cas de doute sur sa confidentialité. 

```{r, echo = FALSE, out.width = '100%'}
utilitr::include_image("./pics/config_git/config_pat_gitlab5.png", compression = FALSE)
```

Sur `Github`, la démarche est identique. La
[documentation officielle](https://docs.github.com/en/github/authenticating-to-github/creating-a-personal-access-token)
présente les captures d'écran pour illustrer la démarche. Il faut choisir le 
niveau `repo` pour avoir les droits mentionnés précédemment. 


### Garder en mémoire (*cache*) ses identifiants

Le système `HTTPS` implique, en principe, de rappeler login et
password (ou token) à chaque authentification. Cependant, `Git` propose
un outil pour mettre en mémoire temporaire (*cache*) des informations
d'authentification. Il convient de passer par la ligne de commande. 

Après avoir ouvert une invite de commande `Git Bash`
([explications ici](#terminal-git)), taper

~~~~shell
# windows
git config --global credential.helper wincred

# mac et linux
git config --global credential.helper 
~~~~


pour stocker pendant quinze minutes les informations de connexion.

En cas d'erreur
de frappe dans le mot de passe ou le jeton, il est possible de vider la mémoire
de la manière suivante:

~~~~shell
git config --global --unset credential.helper
~~~~


## Configurer l'accès à dépôt distant en `SSH` {#git-connexion-ssh}

Pour interagir avec un dépôt distant en utilisant le protocole `SSH`,
il faut créer une clé SSH, plus exactement une paire de chaînes de caractères,
qui va permettre une authentification automatique auprès du dépôt distant.
La version publique de la paire de clés est connue du dépôt distant ; la
version privée reste quant à elle la propriété seule et unique de
l'utilisateur. C'est l'association par un logiciel de cryptographie
de ces deux versions qui permet l'authentification de l'utilisateur.
::: specificite
L'authentification SSH ne fonctionne pas dans le Gitlab du SSP Cloud. Seule l'authentification en `HTTPS` est possible.
:::

::: specificite
La documentation d'AUS propose un tutoriel détaillé sur La configuration de la clé SSH. Vous pouvez le trouver ici : `Y:/Documentation/AUSV3/Git_Utiliser Git sous AUSv3.pdf`.
:::

### Générer une clé SSH

Un utilisateur peut générer autant de clés SSH que bon lui semble, selon qu'il utilise plusieurs systèmes par exemple.

Pour générer une clé SSH, le plus simple est d'utiliser `Git Bash`. Après avoir
ouvert une invite de commande, taper :

```{r, echo = FALSE, out.width = '100%'}
utilitr::include_image("./pics/config_git/ssh_keygen.png", compression = FALSE)
```

La clé est générée sur le chemin spécifié et sera constituée de deux fichiers texte :
- un fichier en `.pub`, qui fournit la partie publique de la clé, et qui a vocation à être diffusée (donc c'est ce fichier qu'on chargera sur Gitlab pour permettre l'authentification) ;
- un fichier `.ppk` (comme Private Key) qui est la partie privée de la clé, et qui ne doit en aucun cas être diffusée.

La version privée de la clé doit être localisée dans un dossier caché que
Git va automatiquement utiliser
(en général un dossier `.ssh` localisé sur un dossier personnel).

### Ajout de la clé SSH sous Gitlab

Pour copier la partie publique de la clé sous Gitlab, il faut aller dans
la partie `Settings` de l'espace personnel sous Gitlab, puis sélectionner
*"SSH Keys"* sur le bandeau latéral gauche. On se trouve face à une fenêtre
de texte comme ceci :

```{r, echo = FALSE, out.width = '100%'}
utilitr::include_image("./pics/config_git/ssh_key_record.png", compression = FALSE)
```

dans laquelle on doit copier-coller le texte que l'on trouve dans le
fichier `.pub` de la clé SSH (en prenant soin d'éliminer l'éventuel texte
en fin du type *"imported-openssh-key"*).

Gitlab est désormais configuré, et il est alors possible de faire
dialoguer Git et Gitlab en suivant, par exemple, les routines proposées dans
la fiche [Utiliser R avec RStudio](#git).

## Références

* [formation Travail collaboratif avec `R`](https://linogaliana.gitlab.io/collaboratif/git.html) ;
* [*Happy Git with R*](https://happygitwithr.com/).
