# Utiliser R à l'Insee

[^1]: l'impossibilité pour une autre personne de reproduire vos travaux.

## Tâches concernées et recommandations

Cette fiche décrit la manière dont on peut personnaliser R, pour l'adapter à ses besoins spécifiques.

::: {.recommandation data-latex=""}

La personnalisation de son environnement de travail est possible via deux fichiers principaux :

* `.Renviron` : un ensemble de variables d'environnement ;
* `.Rprofile ` : ce fichier contient du code R, lancé à l'ouverture de la session.

Personnaliser son environnement  peut conduire à des effets indésirables, et notamment de la non-reproductibilité[^1]. Cela permet toutefois de gérer proprement certains paramètres personnels que l'on ne veut pas partager, comme les clés d'API, ou le proxy.

Ne personnalisez pas R, sauf dans des cas très précis, et bien accompagnés.

:::

## Comprendre le lancement de R ?

R a été conçu, dès le début, pour permettre une très grande flexibilité d'utilisation. Cette flexibilité engendre toutefois une complexité dans ses procédures d'initialisation. 

La documentation sur le lancement de R montre d'ailleurs toute la complexité de la chose :
```{r, eval = FALSE}
help("Startup")
```

Néanmoins, et pour simplifier grandement, la procédure se déroule en trois temps :

1. R cherche des fichiers de type *environment*. Ces fichiers permettent notamment d'indiquer des chemins spécifiques où se trouvent les autres fichiers, ou certaines caractéristiques comme le proxy.
2. R cherche des fichiers de type *profile*. Ces fichiers contiennent du code R qui se lance automatiquement. Ils permettent par exemple d'indiquer des packages supplémentaires à charger, de personnaliser le message d'accueil de R, ou de sauvegarder automatiquement les informations de la session lorsqu'on la quitte.
3. R prépare la session, avec les informations récupérées précédemment, mais également d'autres, comme par exemple les données qu'il aurait pu conserver dans un .Rdata, puis il charge les packages de base, avant par exemple de charger l'historique des commandes (s'il existe).

Sans complexifier outre mesure, sachez que les deux premiers temps se décomposent eux-mêmes en deux sous-temps : il est possible de définir des fichiers *environment* ou *profile* plus génériques que d'autres (c'est le `Renviron.site` ou `Rprofile.site`).


### .Renviron

Le fichier d'environnement `.Renviron` sert à définir des... variables d'environnement ! Ces variables sont utiles à des applications externes, pour bien collaborer avec R. Ces variables d'environnement peuvent également modifier la manière dont R réalise certains calculs. Encore une fois, il ne faut pas faire n'importe quoi ! 

Par exemple, un `.Renviron` fictif pourrait ressembler à: 

```{r, eval=FALSE}
MON_API_INSEE=MaCleSecreteVraiementTresSecrete
_R_CHECK_LENGTH_1_LOGIC2_=verbose
_R_CHECK_LENGTH_1_CONDITION_=true
http_proxy="voici-un-proxy:port"
```

Comme vous pouvez le constater, un tel fichier n'est pas constitué de code R, mais de paires **nom=valeur**. Chaque paire définit une variable d'environnement qui sera exploitée par R pour interagir avec d'autres logiciels, ou directement pour lui.

Plusieurs remarques sont ici nécessaires :

* certaines informations sensibles peuvent être présentes dans un fichier `.Renviron`, et notamment des mots de passe ou des clés secretes d'API (`MaCleSecreteVraiementTresSecrete` dans l'exemple précédent). Si vous travaillez de manière collaborative (cf Fiche XXX), il est **impératif d'exclure le fichier .Renviron de vos *commit* ! Si une information sensible a été dévoilée, même pendant un temps très court, il est impératif de les modifier immédiatement** ;
* certaines variables d'environnement modifient la manière dont R fonctionne ! C'est le cas de `_R_CHECK_LENGTH_1_CONDITION_`  et `_R_CHECK_LENGTH_1_LOGIC2_`;
* **un fichier `.Renviron` doit se terminer par une ligne vide**

Par exemple, sans avoir modifié notre `.Renviron`, que renvoie le code suivant ?

```{r, eval=TRUE}
vecteurboolean <- c(TRUE, FALSE, NULL)
resultat <- 0
if (vecteurboolean) {
    resultat <- 2+2
} else {
  resultat <- 2
}
print(resultat)
```
Bien que non souhaitable, le comportement de R consiste à ne prendre en compte que le premier élément d'un vecteur de booléeans lorsqu'il teste une condition 

Et, en modifiant le `.Renviron`, le même code renvoit désormais autre chose !
```{r, eval=TRUE,error=TRUE,out.width=180}
Sys.setenv("_R_CHECK_LENGTH_1_CONDITION_" = "TRUE") #Cette ligne sert à modifier 
                                                    #directement l'environnement en cours de session
vecteurboolean <- c(TRUE, FALSE, NULL)
resultat <- 0
if (vecteurboolean) {
    resultat <- 2+2
} else {
  resultat <- 2
}
Sys.setenv("_R_CHECK_LENGTH_1_CONDITION_" = "") #Cette ligne sert à réinitialiser
                                                #la condition à sa valeur par défault
print(resultat)

```

Vous comprenez mieux les raisons pour lesquels modifier l'environnement peut conduire à des résultats non reproductibles ! 


::: {.conseil data-latex=""}
Pour modifier son `.Renviron`, le plus simple est probablement d'utiliser le package *usethis* via la commande `usethis::edit_r_environ()`.  Si on travaille dans un projet, on peut préférer modifier le fichier `.Renviron`lié à ce projet via `usethis::edit_r_environ(scop="project")`.
Cette commande va automatiquement ouvrir le fichier `.Renviron` exploité dans la version de R.  
Il suffit ensuite de modifier le fichier, de le sauvegarder, et de relancer R (via Ctrl+Shift+F10) pour prendre en compte ces modifications !
:::


### .Rprofile

Le fichier `.RProfile` contient du code R qui sera lancé par R après les fichiers `.Renviron`. Typiquement, on peut utiliser ce fichier pour :

* modifier le miroir par défault du CRAN
* modifier le message d'accueil
* personnaliser l'affichage de R


::: {.conseil data-latex=""}
Pour modifier son `.Rprofile`, le plus simple est probablement d'utiliser le package *usethis* via la commande `usethis::edit_r_profile()`. Comme précédemment, l'option `scope` permet de définir s'il s'agit du fichier relatif au projet, ou à l'utilisateur.
Cette commande va automatiquement ouvrir le fichier `.Rprofile` exploité dans la version de R.  
Il suffit ensuite de modifier le fichier, de le sauvegarder, et de relancer R (via Ctrl+Shift+F10) pour prendre en compte ces modifications !
:::

Un fichier `.Rprofile` ressemblera typiquement à quelque chose comme :

```{r, eval=FALSE}
options(repos = c(CRAN = "https://cran.rstudio.org"))
options(prompt="R> ", digits=4)
options(continue= "+++ ")
if (interactive()) {
  options(width = 120)
}

.First <- function(){
  cat("\n Allez, hop hop hop, au travail !\n\n")
}
.Last <- function(){
  cat("\n Je m'en vais comme un prince...\n\n")
}

```
Ce fichier permet de :

* définir un miroir par défault pour le CRAN
* modifier l'affichage de l'invite de commande (le ">" de début de ligne devient "R> ")
* modiifer l'affichage des nombres décimaux 
* modifier l'affichage de la console lorsqu'une partie du code reste à écrire (le "+ " en début de ligne devient "+++ ")
* dans le cadre d'un appel à la console, la largeur des impressions est fixée à 120.
* les fonctions `.First` et `.Last` permettent d'effectuer des opérations spécifiques au lancement et à la fermeture de la session R.

Attention, comme précédemment, **un fichier `.Rprofile` doit se terminer par une ligne vierge.** Pour voir certaines options aisément modifiables, la fonction `options()` affiche les valeurs actuellement chargées.


## Quelques bonnes pratiques

Ne personnalisez pas R, sauf dans des cas très précis :

* pour masquer des informations qui ont vocation à être masquées, comme des clés d'API dans le fichier `.Renviron`.
* pour modifier des paramètres qui n'ont pas vocation à être bien configurés dans R, comme le proxy.
* pour changer des éléments qui n'ont aucun impact sur les calculs, mais peuvent vous faciliter la vie, comme l'augmentation de la taille de l'historique, le repos, le message d'accueil, etc.

Il est ainsi fortement déconseillé de réaliser les choses suivantes dans le `.Rprofile`:

* charger des packages `
* définir des alias de fonctions
* modifier le comportement par défault, comme par exemple `options(stringAsFactors=FALSE)`

En effet, toute personne sans ce fichier de configuration ne sera pas en mesure de reproduire vos travaux !


## Pour en savoir plus

La trés grande majorité de la documentation sur cette exploitation de R avancée est en Anglais : 

* [Using .Rprofile and .Renviron, by Nicholas Tierney](https://github.com/numbats/resources/blob/b2fdc170277ecebea9a6358d7d222b55a206d70e/rprofile-renviron.Rmd) ;
* [Rstats What they forgot to teach you - chapter 7, by Jennifer Bryan \& Jim Hester](https://rstats.wtf/r-startup.html) ;
* [Managing R with .Rprofile, .Renviron, Rprofile.site, Renviron.site, rsession.conf, and repos.conf by Alex Gold](https://support.rstudio.com/hc/en-us/articles/360047157094-Managing-R-with-Rprofile-Renviron-Rprofile-site-Renviron-site-rsession-conf-and-repos-conf) ;
* [Efficient R Programing - chapter 2.5, by Colin Gillespie \& Robin Lovelace](https://csgillespie.github.io/efficientR/set-up.html#r-startup) ;
*[R for Enterprise: Understanding R’s Startup, by Sean Lopp (RStudio)]https://rviews.rstudio.com/2017/04/19/r-for-enterprise-understanding-r-s-startup/.
