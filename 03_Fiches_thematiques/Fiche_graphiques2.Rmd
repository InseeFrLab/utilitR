# Faire des graphiques avec `ggplot2`

## Tâches concernées et recommandations

L'utilisateur souhaite réaliser des graphiques avec `R` (nuages de points, histogrammes, densité...).


::: {.recommandation data-latex=""}

* Il est recommandé d'utiliser le *package* `ggplot2` qui permet de réaliser et de personnaliser un grand nombre de représentations graphiques;
* Il est conseillé aux utilisateurs débutants d'utiliser l'*add-in* `esquisse` pour se familiariser avec `ggplot2`.
:::


## Plan temporaire de la fiche

Source1: https://juba.github.io/tidyverse/08-ggplot2.html
Source2: https://mtes-mct.github.io/parcours-r/m5/package-ggplot2.html

### Introduction aux graphiques en `R` (éventuellement sous la forme d'une petite fiche détachable)

#### L'add-in esquisse

Reprendre le 8.9 de source1.

#### Eventuellement: `ggformula`

## Les concepts clefs de `ggplot2`

L'objectif du *package* `ggplot2` est de fournir une approche unique pour produire quasiment toute représentation graphique de données. Cette fiche est une introduction succincte à `ggplot2`. Pour des formations plus détaillées, se référer à {#ggplot2Ressources}.

```{r, message = F}
library(ggplot2)
```

### Introduction

**La fonction essentielle de `ggplot2` est `ggplot()`.** Il faut définir quatre éléments pour construire un graphique avec `ggplot()`: 

- la **table de donnée** ;
- le ***mapping*** : on définit dans l'_aesthetic_ (ou `aes`) le lien entre les variables des données et ce que l'on veut représenter sue le graphique (quelle variable sur l'axe `x`, sur l'axe `y`, quelle variable pour définir une graduation de couleurs...) ;
- la **forme géométrique ou _geometry_ ** : on définit sous quelle représentation graphique on représente les paramètres précédents. Sous `ggplot`, ces fonctions sont de la forme `geom_XX()`;
- les **paramètres** : on définit les autres paramètres qui dépendent de constantes (par exemple : je veux que toutes mes lignes soient rouges ou de taille 2 pixels).

**La construction d'un graphique repose sur le principe de couches successives.** Les différentes couches graphiques se superposent et s'enchaînent grâce à l'**opérateur `+`**, comme un pipe. Il est possible d'aller à la ligne dans une instruction `ggplot()`, il suffit que l'opérateur `+` figure à la fin de la ligne.

L'écriture type d'un graphique est donc: 

```{r, echo=T, eval=F}
ggplot(data = <DATA>) + 
  <FORME_GEO>(mapping = aes(<MAPPINGS>), ...=<PARAMS>)
```

### Le *mapping* et l'utilisation d'`aes()` {#mapping}

Le *mapping* désigne le lien logique entre les variables et les éléments visuels représentés sur le graphique. Un *mapping*, désigne dans `ggplot2` le lien logique entre un **attribut graphique** de la `geometry` (position, couleur, taille...) et **une variable** du tableau de données. On déclare le *mapping* grâce à la fonction `aes()` (pour _aesthetic_), qui sert donc à identifier les variables que l'on souhaite représenter sur le graphique. 

**Les arguments fondamentaux de `aes()` sont les variables représentées sur l'axe des abscisses et l'axe des ordonnées (`x` et `y`).** Par exemple, on écrit `aes(x = Petal.Width, y = Petal.Length)` si l'on souhaite représenter la longueur des pétales (sur l'axe `y`) en fonction de la largeur des pétales (sur l'axe `x`).

```{r}
iris <- iris
ggplot(data = iris) + 
  geom_point(aes(x = Petal.Width, y = Petal.Length))
```

Par ailleurs, la fonction `aes()` admet d'autres arguments qui permettent de modifier l'apparence  des attributs graphiques selon une troisième variable du jeu de données.

Attribut   |Description
-----------------|------------------------------------
**`color`**| Couleur des lignes ou des points
**`shape`**| Forme des points
**`size`**| Taille des points
**`alpha`**| Transparence des points
**`fill`**| Couleur des surfaces
**`linetype`**| Type de ligne (continue, pointillée, ...)


Dans l'exemple qui suit, on représente la longueur des pétales (sur l'axe `y`) en fonction de la largeur des pétales (sur l'axe `x`), en colorant les points en fonction de l'espèce de fleurs (`color = Species`).

```{r}
ggplot(data = iris) + 
  geom_point(aes(x = Petal.Width, y = Petal.Length, color = Species))
```

Il est également possible d'utiliser ces mêmes arguments pour modifier un attribut graphique sans le lier à une variable. En ce cas, on définit l'attribut **à l'extérieur de l'_aesthetic_** (donc à l'extérieur de `aes()`). Voici l'exemple précédent, modifié pour que tous les points soient (rouge), et non en fonction d'une variable. L'argument `color` est donc à l'extérieur de `aes()`.

```{r}
ggplot(data = iris) + 
  geom_point(aes(x = Petal.Width, y = Petal.Length), color = "red")
```

::: {.remarque data-latex=""}
La notion de *mapping* et la définition des attributs graphiques à l'intérieur et à l'extérieur d'`aes()` sont une des principales difficultés de `ggplot2`. Il est normal de tâtonner lorsqu'on commence à les utiliser. Pour s'y retrouver, il suffit de suivre la règle suivante. **Si on établit un lien entre les valeurs d’une variable et un attribut graphique, on définit un _mapping_, et on le définit dans `aes()`. Sinon, on modifie l’attribut de la même manière pour tous les points, et on le définit en-dehors de la fonction `aes()`.**
:::

### Les formes géométriques

La forme géométrique ou _geometry_ désigne le type de représentation graphique utilisée (nuage de points, histogrammes...). Pour spécifier le type de représentation que l'on souhaite, il faut utiliser les fonctions de la forme **`geom_[XXX]`**. Le tableau ci-dessous présente quelques représentations graphiques classiques.

_geometry_         | Description              | Arguments 
-------------------|--------------------------|------------------------------------
`geom_point()`     |	Nuage de points 	      | `x`, `y`, `shape`, `fill`, `size`
`geom_line()`	     | Ligne                    | `x`, `y`, `linetype`
`geom_bar()`       |	Diagramme en barres 	  | `x`, `fill`, `linetype`, `weight`
`geom_histogram()` |	Histogramme 	          | `x`, `fill`, `linetype`, `weight`
`geom_boxplot()`	 | Boîte à moustaches 	    | `x`, `y`, `fill`, `weight`
`geom_density()`	 | Courbe de densité        |	`x`, `y`, `fill`, `color`, `linetype`

Voici deux exemples d'utilisation.

A COMPLETER

::: {.remarque data-latex=""}
Il existe un grand nombre de formes géométriques dans `ggplot2`. Par ailleurs, de très nombreux *packages* proposent encore d'autres formes géométriques pour réaliser des représentations graphiques particulières (cartes avec `ggmap`, arbres généalogiques avec `ggtree` et `ggenealogy`, résultats d'élections avec `ggparliament`...).
:::


### Combiner plusieurs formes géométriques

On peut représenter plusieurs *geometries* simultanément sur un même graphique, il suffit de les ajouter les unes aux autres avec l’opérateur `+`. Voici un exemple:

```{r}
ggplot(iris) + 
  geom_point(aes(x = Petal.Width, y = Petal.Length), alpha = 0.2) + 
  geom_smooth(aes(x = Petal.Width, y = Petal.Length), method = "lm")
```

::: {.conseil data-latex=""}
Lorsqu'on utilise plusieurs fois le même _mapping_ dans plusieurs *geometries*, il est possible de déclarer le _mapping_ dans l’appel à `ggplot()` plutôt que de le répéter chaque *geometry*. Le _mapping_ sera alors valables pour toutes les *geometries* du graphique (sauf si redéfinissent explicitement le *mapping*). Le code suivant produit exactement le même graphique que l'exemple précédent:

```{r}
ggplot(iris, aes(x = Petal.Width, y = Petal.Length)) + 
  geom_point(alpha = 0.2) + 
  geom_smooth(method = "lm")
```
:::


### Créer un graphique par modalité d'une variable

La fonction `facet_wrap()` permet de représenter des données *en facettes*, c'est à dire décomposées par une variable de croisement.

```{r, eval=TRUE}
ggplot2::ggplot(data = diamonds) +
	geom_point(mapping = aes(x = carat, y = price)) +
	facet_wrap(~cut)
```


## Comment personnaliser un graphique

Il est possible de personnaliser un graphique `ggplot2` de deux façons:

- en modifiant les options une à une (titres du graphique et des axes, graduation des axe...);
- en utilisant un `theme` prédéfini ou en le définissant soi-même.

### Les options des graphiques

#### Titre et libellé des axes

Chaque nouvel élément graphique est à rajouter sous forme de layer. Ici, nous utilisons la fonction **labs** qui permet de définir les titres de tous les éléments possibles de l'aesthétic, ainsi que le titre général du graphique (*title*), le sous-titre (*subtitle*) et le bas de page (*caption*). À noter qu'il existe plusieurs autres façons de spécifier ces élèments par des couches spécifiques: `ggtitle`, `xlab`, `ylab`,...

```{r}
ggplot(iris) +
  geom_point(aes(x = Petal.Width, y = Petal.Length, color = Species)) +
  labs(title="Longueur des pétales en fonction de la largeur des pétales",
       x="Largeur des pétales ",
       y="Longueur des pétales ",
       caption="Source : iris")
```

#### Utilisation des _scales_

Les fonctions _scales_ dans `ggplot2` permettent de modifier la manière dont un attribut graphique va être relié aux valeurs d’une variable, et dont la légende correspondante va être affichée. Par exemple, pour l’attribut `color`, on pourra définir la palette de couleur utilisée. Pour `size`, les tailles minimales et maximales. Pour modifier une _scale_ existante, on ajoute un nouvel élément à notre objet ggplot2 avec l’opérateur `+`. Cet élément prend la forme `scale_<attribut>_<paramétrage>`. Les attributs sont listés dans le tableau de la section  \@ref(mapping) (`size`, `color`, `fill`...). Les paramétrages sont listés dans le tableau suivant:

yy|description
-----------------|--------------------------
continuous|gérer les variables continues
discrete|gérer les variables discrètes
date|gérer une variable au format date
reverse|inverser l'axe
log|convertir l'échelle d'une variable continue en échelle logarithmique
log10|convertir l'échelle d'une variable continue en échelle logarithmique décimale
viridis|utiliser une palette de couleur viridis
brewer|utiliser une palette de couleur brewer (variable discrète)
distiller|utiliser une palette de couleur brewer (variable continue)
gradient|utiliser un gradient de 2 couleurs
gradient2|utiliser un gradient divergent de 3 couleurs

Par exemple on peut utiliser les fonctions `scale_x_log10()` et `scale_y_log10()` pour définir des échelles logarithmiques.

```{r}
ggplot(iris) + 
  geom_point(aes(x = Petal.Width, y = Petal.Length)) +
  scale_x_log10() +
  scale_y_log10()
```

#### Modifier la légende


### Utiliser un thème

## Exporter un graphique

La fonction `ggsave()` de `ggplot2` permet d'exporter des graphiques au format image. Les formats suivants sont supportés : eps, ps, tex (pictex), pdf, jpeg, tiff, png, bmp, svg et wmf. Les options `width` et `height` contrôlent la taille du graphique. Voici un exemple:

```{r, eval = FALSE}
p <- ggplot(iris) +
  geom_point(aes(x = Petal.Width, y = Petal.Length, color = Species)) +
  labs(title="Longueur des pétales en fonction de la largeur des pétales",
       x="Largeur des pétales ",
       y="Longueur des pétales ",
       caption="Source : iris")
ggsave("dossier/export/graphiques/graphique_iris.pdf", p, width=12, height = 5)
```


### Sources (ne pas oublier de nommer les auteurs)

Source1: https://juba.github.io/tidyverse/08-ggplot2.html
Source2: https://mtes-mct.github.io/parcours-r/m5/package-ggplot2.html









## Quelques détails sur comment réaliser la tâche avec les outils recommandés

::: {.conseil data-latex=""}
**Conseil**

Cette boîte colorée sert à donner un conseil. Son usage n'est évidemment pas obligatoire.

:::

::: {.remarque data-latex=""}
**Remarque**

Cette boîte colorée sert à faire une remarque. Son usage n'est évidemment pas obligatoire.

:::

### Réaliser la tâche, cas 1

Lorsqu'on est débutant, il faut utiliser la fonction `super_fonction()` du *package* `super_package`.

La fonction `super_fonction()` fonctionne comme ceci par défaut: blabla.

La fonction `super_fonction()` propose beaucoup d'options:

* `option1`: blabla;
* `option2`: blabla;
* `option3`: blabla.

Voici un premier exemple de code (le plus simple possible, en utilisant des données facilement disponibles sur le site de l'Insee):

```{r, eval = FALSE}
library(super_package)
output <- super_fonction(arguments)
```

Ne pas oublier d'expliquer ce qu'on obtient comme output.

Voici un second exemple de code, avec des options un peu plus avancées:

```{r, eval = FALSE}
output <- super_fonction(arguments et options)
```


### Réaliser la tâche, cas 2

Lorsqu'on est plus avancé, on peut utiliser la fonction `hyper_fonction()` du *package* `hyper_package`.

* Comportement par défaut;
* Principales options;
* Exemples de code.

## Quelques bonnes pratiques

Quelques conseils généraux sur la façon de s'y prendre.

* Faut-il préprocesser les données avant de réaliser la tâche;
* Comment minimiser les temps de calculs/la charge en RAM.

## Sources

Cette fiche reprend et adapte des éléments issus des source suivantes:

- [Partie `ggplot2`](https://juba.github.io/tidyverse/08-ggplot2.html) de l'introduction à `R` et au `tidyverse`;
- [Partie `ggplot2`](https://mtes-mct.github.io/parcours-r/m5/package-ggplot2.html) de la formation à `R` du Ministère de la Transition écologique et solidaire.

## Références {#ggplot2Ressources}

* [La documentation officielle](http://ggplot2.tidyverse.org/index.html) (en anglais) de `ggplot2` est très complète et accessible en ligne.
* Une "antisèche" (en anglais) résumant en deux pages l'ensemble des fonctions et arguments et disponible soit directement depuis RStudio (menu *Help > Cheatsheets > Data visualization with ggplot2*) ou [en ligne](https://www.rstudio.com/resources/cheatsheets/).
* Les parties [Data visualisation](http://r4ds.had.co.nz/data-visualisation.html) et [Graphics for communication](http://r4ds.had.co.nz/graphics-for-communication.html) de l'ouvrage en ligne *R for data science*, de Hadley Wickham, sont une très bonne introduction à `ggplot2`.
* Plusieurs ouvrages, toujours en anglais, abordent en détail l'utilisation de `ggplot2`:
    - [ggplot2: Elegant Graphics for Data Analysis](http://www.amazon.fr/ggplot2-Elegant-Graphics-Data-Analysis/dp/0387981403/) de Hadley Wickham;
    - [R Graphics Cookbook](http://www.amazon.fr/R-Graphics-Cookbook-Winston-Chang/dp/1449316956) de Winston Chang. Le [site associé](https://r-graphics.org/) à ce dernier ouvrage comporte aussi pas mal d'exemples et d'informations intéressantes.

Enfin, si `ggplot2` présente déjà un très grand nombre de fonctionnalités, il existe aussi un système d'extensions permettant d'ajouter des `geom`, des thèmes, etc. Le site [ggplot2 extensions](http://www.ggplot2-exts.org/) est une très bonne ressource pour les parcourir et les découvrir, notamment grâce à sa [galerie](http://www.ggplot2-exts.org/gallery/).
