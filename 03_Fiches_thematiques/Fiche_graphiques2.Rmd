# Faire des graphiques avec `ggplot2`

## Tâches concernées et recommandations

L'utilisateur souhaite réaliser des graphiques avec `R` (nuages de points, histogrammes, densité...).


::: {.recommandation data-latex=""}

* Il est recommandé d'utiliser le *package* `ggplot2` qui permet de réaliser et de personnaliser un grand nombre de représentations graphiques;
* Il est conseillé aux utilisateurs débutants d'utiliser l'*add-in* `esquisse` pour se familiariser avec `ggplot2`.
:::


## Plan temporaire de la fiche

Source1: https://juba.github.io/tidyverse/08-ggplot2.html
Source2: https://mtes-mct.github.io/parcours-r/m5/package-ggplot2.html

### Introduction aux graphiques en `R` (éventuellement sous la forme d'une petite fiche détachable)

#### L'add-in esquisse

Reprendre le 8.9 de source1.

#### Eventuellement: `ggformula`

## Début de la fiche `ggplot2`

L'objectif du *package* `ggplot2` est de fournir une approche unique pour produire quasiment toute représentation graphique de données. Cette fiche est une introduction à `ggplot2`. Pour des formations plus détaillées, se référer à {#ggplot2Ressources}.

```{r, message = F}
library(ggplot2)
```


### Les concepts clefs

**La fonction essentielle de `ggplot2` est `ggplot()`.** Il faut définir quatre éléments pour construire un graphique avec `ggplot()`: 

- la **table de donnée** ;
- le ***mapping*** : on définit dans l'_aesthetic_ (ou `aes`) le ***mapping***, c'est à dire ce que l'on veut représenter qui **dépend des variables** (quelle variable sur l'axe `x`, sur l'axe `y`, quelle variable pour définir une graduation de couleurs...) ;
- la **forme géométrique ou _geometry_ ** : on définit sous quelle représentation graphique on représente les paramètres précédents. Sous `ggplot`, ces fonctions sont de la forme `geom_XX()`;
- les **paramètres** : on définit les autres paramètres qui dépendent de constantes (par exemple : je veux que toutes mes lignes soient rouges ou de taille 2 pixels).

**La construction d'un graphique repose sur le principe de couches successives.** Les différentes couches graphiques se superposent et s'enchaînent grâce à l'**opérateur `+`**, comme un pipe. Il est possible d'aller à la ligne dans une instruction `ggplot()`, il suffit que l'opérateur `+` figure à la fin de la ligne.

L'écriture type d'un graphique est donc: 

```{r, echo=T, eval=F}
ggplot(data = <DATA>) + 
  <FORME_GEO>(mapping = aes(<MAPPINGS>), ...=<PARAMS>)
```

### Le *mapping* et l'utilisation d'`aes()`

Le *mapping* désigne le lien logique entre les variables et les éléments visuels représentés sur le graphique. Un *mapping*, désigne dans `ggplot2` le lien logique entre un **attribut graphique** de la `geometry` (position, couleur, taille...) et **une variable** du tableau de données. On déclare le *mapping* grâce à la fonction `aes()` (pour _aesthetic_), qui sert donc à identifier les variables que l'on souhaite représenter sur le graphique. 

**Les arguments fondamentaux de `aes()` sont les variables représentées sur l'axe des abscisses et l'axe des ordonnées (`x` et `y`).** Par exemple, on écrit `aes(x = Petal.Width, y = Petal.Length)` si l'on souhaite représenter la longueur des pétales (sur l'axe `y`) en fonction de la largeur des pétales (sur l'axe `x`).

```{r}
iris <- iris
ggplot(data = iris) + 
  geom_point(aes(x = Petal.Width, y = Petal.Length))
```

Par ailleurs, la fonction `aes()` admet d'autres arguments qui permettent de modifier l'apparence  des attributs graphiques selon une troisième variable du jeu de données.

* **`colour`** : la couleur;
* **`shape`** : la forme;
* **`size`** : la taille;
* **`alpha`** : la transparence;
* **`fill`** : le remplissage.

Dans l'exemple qui suit, on représente la longueur des pétales (sur l'axe `y`) en fonction de la largeur des pétales (sur l'axe `x`), en colorant les points en fonction de l'espèce de fleurs (`color = Species`).

```{r}
ggplot(data = iris) + 
  geom_point(aes(x = Petal.Width, y = Petal.Length, color = Species))
```

Il est également possible d'utiliser ces mêmes arguments pour modifier un attribut graphique sans le lier à une variable. En ce cas, on définit l'attribut **à l'extérieur de l'_aesthetic_** (donc à l'extérieur de `aes()`). Voici l'exemple précédent, modifié pour que tous les points soient (rouge), et non en fonction d'une variable. L'argument `color` est donc à l'extérieur de `aes()`.

```{r}
ggplot(data = iris) + 
  geom_point(aes(x = Petal.Width, y = Petal.Length), color = "red")
```

::: {.remarque data-latex=""}
La notion de *mapping* et la double utilisation des paramètres visuels dans et à l'extérieur d'`aes()` sont une des principales difficultés de `ggplot2`. Il est normal de tâtonner lorsqu'on commence à les utiliser. Pour s'y retrouver, il suffit de suivre la règle suivante. **Si on établit un lien entre les valeurs d’une variable et un attribut graphique, on définit un _mapping_, et on le déclare dans `aes()`. Sinon, on modifie l’attribut de la même manière pour tous les points, et on le définit en-dehors de la fonction `aes()`.**
:::


### Les formes géométriques

La forme géométrique ou _geometry_ désigne le type de représentation graphique utilisée (nuage de points, histogrammes...). Pour spécifier le type de représentation que l'on souhaite, il faut utiliser les fonctions de la forme **`geom_[XXX]`**. Le tableau ci-dessous présente quelques représentations graphiques classiques.

_geometry_         | Description              | Arguments 
-------------------|--------------------------|------------------------------------
`geom_point()`     |	Nuage de points 	      | `x`, `y`, `shape`, `fill`, `size`
`geom_line()`	     | Ligne                    | `x`, `y`, `linetype`
`geom_bar()`       |	Diagramme en barres 	  | `x`, `fill`, `linetype`, `weight`
`geom_histogram()` |	Histogramme 	          | `x`, `fill`, `linetype`, `weight`
`geom_boxplot()`	 | Boîte à moustaches 	    | `x`, `y`, `fill`, `weight`
`geom_density()`	 | Courbe de densité        |	`x`, `y`, `fill`, `color`, `linetype`

Voici deux exemples d'utilisation.

A COMPLETER

::: {.remarque data-latex=""}
Il existe un grand nombre de formes géométriques dans `ggplot2`. Par ailleurs, de nombreux *packages* proposent encore d'autres formes géométriques pour réaliser des représentations graphiques particulières (cartes avec `ggmap`, arbres généalogiques avec `ggtree` et `ggenealogy`, résultats d'élections avec `ggparliament`...).
:::

### Les options des graphiques

Titre, légendes, axes, scales, xlim/ylim.

Reprendre le 7 et le 9 de source2.

### Exporter un graphique

Reprendre le 12 de source2.

### Sources (ne pas oublier de nommer les auteurs)

Source1: https://juba.github.io/tidyverse/08-ggplot2.html
Source2: https://mtes-mct.github.io/parcours-r/m5/package-ggplot2.html









## Quelques détails sur comment réaliser la tâche avec les outils recommandés

::: {.conseil data-latex=""}
**Conseil**

Cette boîte colorée sert à donner un conseil. Son usage n'est évidemment pas obligatoire.

:::

::: {.remarque data-latex=""}
**Remarque**

Cette boîte colorée sert à faire une remarque. Son usage n'est évidemment pas obligatoire.

:::

### Réaliser la tâche, cas 1

Lorsqu'on est débutant, il faut utiliser la fonction `super_fonction()` du *package* `super_package`.

La fonction `super_fonction()` fonctionne comme ceci par défaut: blabla.

La fonction `super_fonction()` propose beaucoup d'options:

* `option1`: blabla;
* `option2`: blabla;
* `option3`: blabla.

Voici un premier exemple de code (le plus simple possible, en utilisant des données facilement disponibles sur le site de l'Insee):

```{r, eval = FALSE}
library(super_package)
output <- super_fonction(arguments)
```

Ne pas oublier d'expliquer ce qu'on obtient comme output.

Voici un second exemple de code, avec des options un peu plus avancées:

```{r, eval = FALSE}
output <- super_fonction(arguments et options)
```


### Réaliser la tâche, cas 2

Lorsqu'on est plus avancé, on peut utiliser la fonction `hyper_fonction()` du *package* `hyper_package`.

* Comportement par défaut;
* Principales options;
* Exemples de code.

## Quelques bonnes pratiques

Quelques conseils généraux sur la façon de s'y prendre.

* Faut-il préprocesser les données avant de réaliser la tâche;
* Comment minimiser les temps de calculs/la charge en RAM.

## Sources

Cette fiche reprend et adapte des éléments issus des source suivantes:

- [Partie `ggplot2`](https://juba.github.io/tidyverse/08-ggplot2.html) de l'introduction à `R` et au `tidyverse`;
- [Partie `ggplot2`](https://mtes-mct.github.io/parcours-r/m5/package-ggplot2.html) de la formation à `R` du Ministère de la Transition écologique et solidaire.


## Références


* [La documentation officielle](http://ggplot2.tidyverse.org/index.html) (en anglais) de `ggplot2` est très complète et accessible en ligne.
* Une "antisèche" (en anglais) résumant en deux pages l'ensemble des fonctions et arguments et disponible soit directement depuis RStudio (menu *Help > Cheatsheets > Data visualization with ggplot2*) ou [en ligne](https://www.rstudio.com/resources/cheatsheets/).
* Les parties [Data visualisation](http://r4ds.had.co.nz/data-visualisation.html) et [Graphics for communication](http://r4ds.had.co.nz/graphics-for-communication.html) de l'ouvrage en ligne *R for data science*, de Hadley Wickham, sont une très bonne introduction à `ggplot2`.
* Plusieurs ouvrages, toujours en anglais, abordent en détail l'utilisation de `ggplot2`:
    - [ggplot2: Elegant Graphics for Data Analysis](http://www.amazon.fr/ggplot2-Elegant-Graphics-Data-Analysis/dp/0387981403/) de Hadley Wickham;
    - [R Graphics Cookbook](http://www.amazon.fr/R-Graphics-Cookbook-Winston-Chang/dp/1449316956) de Winston Chang. Le [site associé](https://r-graphics.org/) à ce dernier ouvrage comporte aussi pas mal d'exemples et d'informations intéressantes.

Enfin, si `ggplot2` présente déjà un très grand nombre de fonctionnalités, il existe aussi un système d'extensions permettant d'ajouter des `geom`, des thèmes, etc. Le site [ggplot2 extensions](http://www.ggplot2-exts.org/) est une très bonne ressource pour les parcourir et les découvrir, notamment grâce à sa [galerie](http://www.ggplot2-exts.org/gallery/).
