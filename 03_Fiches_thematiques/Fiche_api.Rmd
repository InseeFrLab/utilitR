# Travailler avec des API

<!-- ## Tâches concernées et recommandations -->

<!-- Quelques détails sur la tâche dont il s'agit -->

<!-- ::: {.recommandation data-latex=""} -->

<!-- Dire en 4-5 lignes comment il est recommandé de procéder: -->

<!-- * le ou les *package*(*s*) dont l'usage est recommandé; si on recommande plusieurs *packages*, expliquer comment choisir lequel (en fonction de la taille des données, du format...) -->
<!-- * les *packages* dont l'usage est déconseillé;  -->
<!-- * les autres points de méthode essentiels. -->

<!-- ::: -->

## Rappels des notions essentielles sur les API

### Qu'est-ce qu'une API ?

Une *Application Programming Interface* (ou **API**) est une interface applicative de programmation qui permet d'utiliser une application existante pour restituer des données. Il s'agit d'une façade clairement délimitée par laquelle un logiciel offre des services à d'autres logiciels (ou utilisateurs). L'objectif est de fournir une porte d'accès à une fonctionnalité en cachant les détails de la mise en œuvre. 

Ce terme peut faire peur, mais il s'agit en fait simplement d'une façon de restituer des données. Plutôt que d'attaquer directement des bases de données, qui sont volumineuses et complexes, des outils ont été développés pour faire le travail intermédiaire et restituer la donnée sous forme de service.

À l'Insee comme ailleurs, la connexion entre les bases de données pour les nouveaux projets tend à se réaliser via des API, afin de limiter le nombre de personnes ayant accès aux bases, mais aussi pour faciliter les accès avec des services sur-mesures pour les utilisateurs.

### Mise à disposition des API

Les API peuvent utiliser une interface utilisateur.  

Les API Insee mise à disposition sur le [catalogue des API](https://api.insee.fr/catalogue/) en proposent. Cette interface, permet :

- de s'inscrire aux différents services ;
- de visualiser les différentes requêtes proposées par les services ;
- de lancer l'API depuis cette plateforme ;
- de documenter les API.

Cependant, l'utilisation de cette interface ne sera pas utile très longtemps, car l'utilisateur va vite se rendre compte qu'une API s'utilise via un logiciel de traitement pour automatiser un processus ou réaliser du chargement de masse.


Pour d'autres API, mises à disposition par la [BDM au format SDMX](https://www.insee.fr/fr/information/2862759), ce point d'entré n'existe pas. De la documentation est mise à disposition pour permettre à l'utilisateur de comprendre l'utilisation du service. L'utilisateur devra ensuite utiliser l'API directement via son url par un navigateur internet ou un logiciel adapté (R, java, python...).

Les API sont proposées avec plusieurs degrés de liberté pour l'utilisateur :

- soit en libre accès (l'utilisation n'est ici pas contrôlée et l'utilisateur peut utiliser le service comme bon lui semble) ;
- soit via la génération d'un compte et d'un jeton qui permet de sécuriser son utilisation et limiter le nombre de requêtes.

### Requête d'une API

Comme pour l'utilisation d'une fonction ou d'une macro SAS, l'appel d'une API s'effectue via des paramètres. 
Chaque service se présente sous la forme d'une url. Cette url est à compléter avec les différents paramètres de la requête.

Prenons l'exemple de l'API Sirene, l'url a utiliser pour avoir des informations sur un siren est : https://api.insee.fr/entreprises/sirene/V3/siren/{siren} (modifier {siren} en renseignant le numéro du siren).

Chaque service proposé par l'API aura sa propre url avec ses propres paramètres.

Enfin, le résultat envoyé par une API est majoritairement au format JSON ou XML. Cependant certains services peuvent proposer du csv.  
Le résultat n'est pas toujours facile à récupérer. Pour faciliter les utilisations des API, des packages ont été créés pour simplifier l'utilisation. Malheureusement ce n'est pas le cas pour tous les services d'API. Dans ce cas, il va falloir que l'utilisateur retravaille le résultat pour obtenir des données lisibles.

## Package permettant une utilisation simple des API

Nous allons voir ici quelques packages permettant de traiter l'information d'une API facilement :

### [apinsee](https://github.com/InseeFrLab/apinsee)

Ce package est très utile pour l'utilisation des API mises à diposition sur le catalogue des API. En effet, pour ces API, un jeton ayant une durée de vie limitée doit être régulièrement généré. Ce package va automatiser la création d'un jeton. Ainsi il n'y a plus besoin de naviguer entre le programme et le catalogue des API.

```{r, eval = FALSE}
# Dans un premier temps il faut modifier son .Renviron, en utilisant la commande usethis::edit_r_environ("user").
# Ces deux lignes doivent être ajoutées : 
# Dans un premier temps il faut modifier son .Renviron, en utilisant la commande :
usethis::edit_r_environ("user")
# Ces deux lignes doivent être ajoutées. Ces informations se trouvent dans la partie clé et jeton d'accès du portail des API : 
INSEE_APP_KEY=xxxxxxxxxxxxxxxxxx    # clef du consommateur
INSEE_APP_SECRET=yyyyyyyyyyyyyyyyyy # secret du consommateur

# Vous pouvez donc simplement exécuter la fonction :
token <- apinsee::insee_auth()

# Ce token peut ensuite être utilisé comme valeur du paramètre token de la fonction httr::config() :

library(httr)
set_config(config(token = token))

# Dès lors, vous pouvez accéder aux API de l’Insee auxquelles votre application a souscrit.

```

### [insee](https://hadrilec.github.io/insee/)

Ce package permet de télécharger les données et leurs métadonnées diffusées sur le service SDMX de la Base de données Macroéconomique de l'Insee (BDM). Cette API étant ouverte, son accès ne demande pas d'identification, ni de jeton. Il est uniquement nécessaire de déterminer les données souhaitées soit via une liste idbank, soit via une liste de dataset. 
Voici quelques utilisations possibles de ce package :



```{r, eval = FALSE}
# Obtenir la liste des tables présentes dans la BDM , les dataset, ou la liste des séries proposées, les idbank :
liste_table <- get_dataset_list()
liste_indicateur <- get_idbank_list()

# Importer les données à partir de leur idbank ou importer un dataset à partir de leur identifiant:
table_bp <- get_insee_dataset("BALANCE-PAIEMENTS")
indicateur_001694056 <- get_insee_idbank("001694056")
# Il est possible de rajouter des filtres à ces fonctions afin de limiter le nombre de données importées (filtre sur la période, sur la date de mise à jour, sur les filtres).

```


### [inseeLocalData](https://github.com/InseeFrLab/inseeLocalData)

Ce package permet de télécharger les données localisées à la commune, diffusées sur insee.fr dans la rubrique ‘chiffres détaillés’, sous forme de cubes prédéfinis. Cette API est hébergée sur le catalogue des API de l'Insee. Une authentification par un jeton est donc nécessaire.
Le package comporte une fonction unique qui permet d’importer les données présentes dans l’API Données Locales dans une liste contenant 4 objets :
- les données statistiques ;
- les modalités de chaque variable ;
- l’information sur la zone demandée ;
- l’information sur la source et le jeu de données demandé.

Voici une utilisation possibles de ce package :

```{r, eval = FALSE}
# Exemple d'utilisation du package pour importer le nombre d'entreprise et d'établissement en 2017 (en géographie au 01/01/2017) selon l'activité en 5 catégorie et une indicatrice indiquant s'il s'agit d'une entreprise individuelle ou non pour la commune de Nantes:

croisement <- "NA5_B-ENTR_INDIVIDUELLE"
jeu_donnees <- "GEO2017REE2017"
nivgeo <- "COM"
codgeo <- "44109"
modalite <- "all.all"

donneesAPI <- get_dataset(jeton, jeu_donnees, croisement, modalite, nivgeo, codgeo)

donnees <- donneesAPI$donnees # pour accéder aux données
liste_code <- donneesAPI$liste_code # pour accéder aux nomenclatures
info_zone <- donneesAPI$info_zone # pour accéder aux données géographiques
source <- donneesAPI$source # pour accéder à la source

```

### [OECD](https://cran.r-project.org/web/packages/OECD/index.html)

::: {.remarque data-latex=""}

Ce package utilise la library(rsmdx), qui n'est pas compatible avec direct access. Il ne fonctionne pas en télétravail.

:::

Ce package permet de télécharger les données mises à disposition sur le site de l'[OCDE](https://stats.oecd.org/index.aspx?lang=fr). Cette API étant ouverte,son accès ne demande pas d'identification, ni de jeton. Il est uniquement nécessaire de déterminer les données souhaitées. 

Voici quelques utilisations possibles de ce package :

```{r, eval = FALSE}
# Obtenir la liste des tables présentes sur le site :
dsets <- get_datasets()

# Voir les métadonnées d'une table, via l'ouverture d'une page web (ici la table DUR_D) :
browse_metadata("DUR_D")

# Importer une table de données (ici la table DUR_D) :
data <- get_dataset("DUR_D")
```
