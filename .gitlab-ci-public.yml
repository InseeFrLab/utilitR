services:
  - docker:dind
  
variables:
  BASE_IMAGE: rocker/geospatial:3.6.1
  DOCKER_HOST: tcp://docker:2375
  DOCKER_DRIVER: overlay2
  BUILD_IMAGE: $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG

build_image:
  stage: .pre
  image: gitlab/dind
  script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - if [[ $CI_COMMIT_REF_SLUG == "master" ]]; then export BUILD_BASE_IMAGE=$BASE_IMAGE; else docker pull $BUILD_IMAGE && export BUILD_BASE_IMAGE=$BUILD_IMAGE || export BUILD_BASE_IMAGE=$CI_REGISTRY_IMAGE:master; fi
    - docker build --build-arg BASE_IMAGE=$BUILD_BASE_IMAGE -t $BUILD_IMAGE .
    - docker push $BUILD_IMAGE

buildbookdown:
  image: $BUILD_IMAGE
  script:
    - Rscript -e "bookdown::render_book('index.Rmd', output_format = 'all', output_dir = '_public')"
  artifacts:
    paths:
      - _public

pages:
  stage: deploy
  script:
    - mv _public public
  artifacts:
    paths:
      - public
  only:
    - master
