# Utiliser `Rstudio` sur l'environnement SSP Cloud

Le nom de la fiche décrit la tâche qu'on veut réaliser en quelques mots.

## Tâches concernées et recommandations

Quelques détails sur la tâche dont il s'agit

::: {.recommandation data-latex=""}

Dire en 4-5 lignes comment il est recommandé de procéder:

* le ou les *package*(*s*) dont l'usage est recommandé; si on recommande plusieurs *packages*, expliquer comment choisir lequel (en fonction de la taille des données, du format...)
* les *packages* dont l'usage est déconseillé; 
* les autres points de méthode essentiels.
:::

## Présentation succincte du SSP Cloud

**Le SSP Cloud est une plate-forme informatique hébergée à l'Insee et ouverte à tous les agents de la statistique publique.** Elle permet aux statisticiens d'utiliser un grand nombre de logiciels de _data science_ (`R`, Python, PostgreSQL, Jupyter, Tensorflow...) dans un environnement informatique ergonomique et performant. Il faut donc noter que le SSP Cloud n'est donc pas spécifiquement conçu pour utiliser `R`.

**Le SSP Cloud est une plate-forme sur laquelle vous pouvez mener des expérimentations qui seraient difficiles à réaliser dans AUS**, soit parce qu'AUS ne propose pas le logiciel dont vous avez besoin, soit parce que votre traitement demande des ressources informatiques particulièrement importantes.

En revanche, **le SSP Cloud n'est pas une infrastructure de production, et n'offre donc pas les mêmes garanties de service qu'AUS**. De plus, le traitement de données confidentielles sur le SSP Cloud n'est pas autorisé.


## Comment créer un service Rstudio sur le SSP Cloud

### 1. Création d'un compte SSP Cloud

Il est nécessaire de disposer d'un compte personnel **SSP Cloud** pour en utiliser les services. Si vous n'avez pas de compte sur le **SSP Cloud**, vous pouvez vous en créer un en [cliquant sur ce lien (https://datalab.sspcloud.fr/accueil)](https://datalab.sspcloud.fr/accueil) puis suivre les indications. Deux points sont importants à noter:

- vous devez avoir une adresse mail en `insee.fr`  ou en `gouv.fr`;
- **votre nom d'utilisateur ne doit contenir ni caractères accentués, ni caractère spécial, ni signe de ponctuation**. Ce point est essentiel, car votre compte ne fonctionnera pas si votre nom d'utilisateur comprend l'un de ces caractères. Le plus simple est que votre nom d'utilisateur respecte le format `prenomnom`. Par exemple, si vous vous appelez Jérôme-Gérard L'Hâltère, votre nom d'utilisateur pourra être `jeromegerardlhaltere`.

### 2. Créer un service RStudio

Voici comment procéder pour créer un service RStudio:

- [Cliquer sur **"Consulter le catalogue"**](https://datalab.sspcloud.fr/my-lab/catalogue)  

![](./pics/SSPCloud/99_SSPCloud_0.png){width=75%}

- La fenêtre suivante s'affiche. Elle ne contient pour le moment qu'un seul dossier nommé `datascience`. Cliquer sur le petit dossier, en bas à droite.

![](./pics/SSPCloud/99_SSPCloud_2.png){width=75%}

- Vous accédez alors à la liste des services. En faisant défiler la page, vous trouverez facilement la fiche Rstudio (voir l'image suivante). VOus pouvez alors cliquer sur l'image ![](./pics/SSPCloud/99_SSPCloud_3_Plus.png){width="40"} de la fiche RStudio.

![](./pics/SSPCloud/99_SSPCloud_1.png){width=75%}


- Dans la page qui s'affiche, vous pouvez définir les options de votre service Rstudio (voir la section [Définir les options d'un service Rstudio]). Vous pouvez lancer le service en cliquant sur **Créer votre service**.

![](./pics/SSPCloud/99_SSPCloud_3.png){width=75%}

### 3. Se connecter à un service Rstudio

Une fois que votre service `RStudio` est créé, il faut vous connecter à ce service. Pour ce faire, il faut vous identifier avec un nom d'utilisateur et un _password_. Pour récupérer votre _password_, le plus simple est de cliquer sur la clé bleue (voir image suivante) : vous copiez ainsi votre mot de passe.


![](./pics/SSPCloud/99_SSPCloud_4bis.png){width=75%}

Vous pouvez ensuite vous connecter au service en cliquant sur l'icône ![](./pics/SSPCloud/Se_connecter_service.png){width="40"} (voir image précédente). Les identifiants sont :  

- `Username` : `rstudio`;
- `Password` : le _password_ copié précédemment (il suffit de faire `Ctrl + V`).

![](./pics/SSPCloud/99_SSPCloud_5bis.png){width=75%}

L'interface habituelle de RStudio s'affiche alors dans la fenêtre.

![](./pics/SSPCloud/99_SSPCloud_6.png){width=75%}

## Définir les options d'un service Rstudio

Lors de la création de votre service Rstudio, vous pouvez définir les options du service en naviguant dans les différents onglets de l'interface du SSP Cloud (cadre rouge). 

![](./pics/SSPCloud/99_SSPCloud_4bis.png){width=75%}

Les principales options sont les suivantes:

- L'**option `mem`** (dans l'onglet `service`) définit la quantité maximale de mémoire vive (mesurée en Mo) que votre service Rstudio peut utiliser. **Cette option est particulièrement importante** et vous devez choisir soigneusement sa valeur: si vos traitements requièrent plus de mémoire que la valeur de `mem`, la seule solution consiste à lancer un autre service Rstudio avec une valeur de `mem` plus élevée. Il est conseillé d'utiliser 10000 comme valeur par défaut.
- L'**option `cpu`** (dans l'onglet `service`) définit le nombre minimal de processeurs alloués à votre service Rstudio. Contrairement à l'option `mem`, il ne s'agit pas d'un maximum, une valeur basse ne risque donc pas de bloquer vos traitements. Il est conseillé d'utiliser 2 comme valeur par défaut.
- L'**option `custom name`** (dans l'onglet `Onyxia`) permet de définir le nom de votre service. Cette option n'a aucun impact sur le fonctionnement de votre service, mais peut vous aider à vous y retrouver si vous avez plusieurs services Rstudio en parallèle.
- L'**option `Enable IP protection`** (dans l'onglet `Networking`) est une option de sécurité informatique très contraignante, qui est activée par défaut. Il est conseillé de la désactiver, en particulier si vous souhaitez utiliser votre service Rstudio pendant plusieurs jours.


## Utiliser des données stockées sur le système de stockage S3

### Pourquoi utiliser S3 sur le SSP Cloud?

Le SSP Cloud propose des environnements (comme les services Rstudio, Jupyter, etc. [LIEN VERS PARTIE PERTINENTE]) pour exécuter des programmes informatiques. Ces environnements sont **temporaires par définition** (quelques heures ou quelques jours), et ne sont donc pas destinés à stocker des données ou des programmes infomatiques. Cela a pour conséquence que les programmes informatiques et les données doivent être stockés dans d'autres espaces:

* *stockage des codes*: il est nécessaire d'utiliser une plate-forme de développement pour stocker des programmes informatiques, tel que [Gitlab](www.gitlab.com) ou [Github](www.github.com). L'usage du Gitlab interne de l'Insee est présenté dans la fiche [LIEN A FAIRE].
* *stockage des données*:  la plateforme SSP Cloud propose un système de stockage de données nommé S3. Depuis votre service Rstudio, vous pourrez facilement accéder à des données stockées sur S3 grâ au _package_ `aws.s3`.

::: {.remarque data-latex=""}
Voici deux règles à respecter pour faire un bon de ces deux espaces de stockage: 

* Les plate-formes telles que Gitlab ou Github ne doivent **jamais** être utilisées pour stocker des données.
* Le système de stockage S3 ne doit pas **jamais** être utilisé pour stocker des données confidentielles.
:::

### Qu'est-ce que le système de stockage S3?

Le système S3 (*Simple Storage System*) est un système de stockage développé par Amazon et qui est maintenant devenu une référence. Il s'agit d'une architecture à la fois sécurisée (données cryptées, accès restreints) et performante.

Le concept central du système S3 est le *bucket*. Un *bucket* est un espace (privé ou partagé) où on peut stocker une arborescence de fichiers. Pour accéder aux fichiers figurant dans un *bucket* privé, il fournir des jetons d'accès (l'équivalent d'un mot de passe) reconnus par le serveur de stockage. On peut alors lire et écrire dans le *bucket*.

### Explorer son dépôt de fichiers

Il est possible d'utiliser l'interface du `SSP Cloud` pour explorer les fichiers présents dans S3 ainsi qu'ajouter ou télécharger manuellement des fichiers. Le raccourci pour accéder aux fichiers disponibles se trouve en bas à droite de la fenêtre du `SSP Cloud`:

![](./pics/SSPcloud/minio/onyxia_files.png){width=75%}

En cliquant dessus, on obtient la liste des *buckets* auxquels on a accès, 
par exemple ici le *bucket* `XXXX`:

![](./pics/SSPcloud/minio/onyxia_files2.png){width=75%}

Il est possible de naviguer dans l'arborescence depuis cette fenêtre afin,
par exemple, de récupérer un chemin qu'on va utiliser avec `R`

![](./pics/SSPcloud/minio/onyxia_files3.png){width=75%}




### Utiliser S3 avec un service Rstudio

Lorsqu'on crée un service Rstudio, des droits d'accès temporaires au système S3 sont automatiquement initialisés. Ces droits permettent de communiquer avec le serveur de stockage, mais leur usage est complexe. Heureusement, il existe le _package_ `aws.s3` simplifie beaucoup les interactions entre le service Rstudio et S3 en proposant des fonctions de lecture et d'écritures similaires à celles existantes pour lire ou écrire un fichier depuis un poste personnel.

#### Vérifier les droits d'accès à un *bucket*

Imaginons que le bucket auquel on désire accéder soit nommé `XXXX`. 
Pour lister l'ensemble des fichiers disponibles, il suffit d'effectuer la 
commande suivante

```{r, eval = FALSE}
aws.s3::get_bucket(XXXX, region = "")
```

~~~text
Bucket: XXXX

$Contents
Key:            data/test.csv 
LastModified:   2020-12-07T15:05:05.246Z 
ETag:           "95c2cdf3321744f998b234e546a5c736" 
Size (B):       367 
Owner:           
Storage class:  STANDARD 
~~~


#### Lire les fichiers d'un *bucket*

Les fichiers de données d'exemples
[disponibles sur le SSP-Cloud](https://datalab.sspcloud.fr/mes-fichiers/donnees-insee)
serviront à illustrer les fonctionalités de lecture de la librairie `aws.s3`.

Supposons qu'on désire, au sein de ce *bucket* `donnees-insee`, accéder aux données Filosofi
2014 qui sont stockées dans le chemin `/FILOSOFI/2014/FILOSOFI_COM.csv`. 

```{r, eval = FALSE}
df <- aws.s3::s3read_using(
  FUN = data.table::fread,
  object = "/FILOSOFI/2014/FILOSOFI_COM.csv",
  bucket = "donnees-insee",
  opts = list("region" = "")
)
```


#### Ecrire un fichier dans un *bucket*
Si les jetons d'accès à un bucket sont périmés, ou si le nom du bucket est mal
orthographié, `R` renverra l'erreur suivante

~~~r
Error in parse_aws_s3_response(r, Sig, verbose = verbose) : 
  Forbidden (HTTP 403).
~~~

Il est également possible de faire une requête pour chercher un fichier dans 
un dossier au sein de l'arborescence du bucket. Par exemple, dans le *bucket*
`donnees-insee` auquel tout utilisateur du SSP-Cloud a accès, on peut
lister les fichiers présents dans le dossier `ETAT_CIVIL`:


```{r, eval = FALSE}
aws.s3::get_bucket("donnees-insee", prefix = "ETAT_CIVIL", region = "")
```
~~~text
Bucket: donnees-insee 

$Contents
Key:            ETAT_CIVIL/2018/DECES_COM_0817.csv 
LastModified:   2020-10-06T20:58:14.674Z 
ETag:           "96227fed503493eb5f1aa6fb85af3622" 
Size (B):       1969776 
Owner:           
Storage class:  STANDARD 

$Contents
Key:            ETAT_CIVIL/2019/DECES_COM_0918.csv 
LastModified:   2020-10-06T20:58:15.817Z 
ETag:           "92ac1845874da27bb61e8f5173b3f312" 
Size (B):       1950859 
Owner:           
Storage class:  STANDARD 

$Contents
Key:            ETAT_CIVIL/2019/NAISSANCES_COM_0918.csv 
LastModified:   2020-10-06T21:18:52.326Z 
ETag:           "609e8b42abd5b82b0a7b9aadabe08b5c" 
Size (B):       1970893 
Owner:           
Storage class:  STANDARD 

$Contents
Key:            ETAT_CIVIL/2019/PRENOM_DEP.csv 
LastModified:   2020-10-06T21:19:33.886Z 
ETag:           "d550d74aed71db1862d74051a3795103-9" 
Size (B):       88760691 
Owner:           
Storage class:  STANDARD 

$Contents
Key:            ETAT_CIVIL/2019/PRENOM_NAT.csv 
LastModified:   2020-10-06T21:18:59.352Z 
ETag:           "fc429c25afa83b68b1564aa2b89caeef-2" 
Size (B):       13834168 
Owner:           
Storage class:  STANDARD 

$Contents
Key:            ETAT_CIVIL/2020/DECES_COM_1019.csv 
LastModified:   2020-10-06T20:58:16.467Z 
ETag:           "5cb9f547c306b64339419957b6d626ce" 
Size (B):       1079283 
Owner:           
Storage class:  STANDARD 

$Contents
Key:            ETAT_CIVIL/2020/NAISSANCES_COM_1019.csv 
LastModified:   2020-10-06T21:18:53.929Z 
ETag:           "8650985234abd361bf0eb83ebe7946e3" 
Size (B):       1097015 
Owner:           
Storage class:  STANDARD 
~~~

## Ecriture

```{r, eval = FALSE}
df <- data.frame(
  x = rnorm(10),
  y = rnorm(10)
)


aws.s3::s3write_using(
  df,
  FUN = data.table::fwrite,
  object = "data/test.csv",
  bucket = XXXXX,
  opts = list("region" = "")
)


df2 <- aws.s3::s3read_using(
  FUN = data.table::fread,
  object = "data/test.csv",
  bucket = XXXXX,
  opts = list("region" = "")
)
```


## Liens utiles

- Le salon Tchap [SSPCloud](https://www.tchap.gouv.fr/#/room/#SSPCloudXDpAw6v:agent.finances.tchap.gouv.fr)
- Le salon Tchap d'assistance aux utilisateurs des **Logiciels Statistiques et Libre Service** [Insee - Outils Stats V2](https://www.tchap.gouv.fr/#/room/#InseeOutilsStatsv2wtxSdth:agent.finances.tchap.gouv.fr)

