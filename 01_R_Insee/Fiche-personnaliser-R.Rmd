# Personnaliser la configuration de `R`



L'agent souhaite personnaliser sa configuration de `R` ou de Rstudio.



::: {.recommandation data-latex=""}
**La personnalisation de `R`, ou de `RStudio` doit être maniée avec précaution**, car personnaliser son environnement de travail, c'est prendre le risque de rendre moins reproductible ses travaux. Cette fiche vous explique ce que la personnalisation peut apporter, et ce pour quoi elle ne doit être utilisée.

**Il est recommandé de ne pas personnaliser la configuration de `R`**, sauf dans les cas suivants :

* **masquer des informations qui ne doivent pas figurer dans les programmes**, comme les clés d'API ;
* **modifier des paramètres dont les valeurs par défaut ne sont pas adaptées au travail avec `R` à l'Insee**, comme le _proxy_ ou les chemins vers des exécutables ;
* **changer des éléments qui n'ont aucun impact sur les résultats**, mais peuvent vous faciliter la vie, comme la taille de l'historique, le repos, le prompt, etc.

D'autres paramètres, notamment ceux de RStudio, sont aisément modifiables, mais parfois non automatisable (comme le changement d'apparence).
:::

## Comprendre le lancement de R ?

`R` a été conçu, dès le début, pour permettre une très grande flexibilité d'utilisation. Cette flexibilité engendre toutefois une complexité dans ses procédures d'initialisation.  [La documentation sur le lancement de `R`](https://cran.r-project.org/web/packages/startup/vignettes/startup-intro.html) montre d'ailleurs toute la complexité de la chose :

```{r, eval = FALSE}
help("Startup")
```

Néanmoins, et pour simplifier grandement, la procédure se déroule en trois temps :

1. R cherche des fichiers de type *environment*. Ces fichiers permettent notamment d'indiquer des chemins spécifiques où se trouvent d'autres fichiers, ou certaines caractéristiques comme le _proxy_.

2. `R` cherche des fichiers de type *profile*. Ces fichiers contiennent du code `R` qui se lance automatiquement au démarrage de `R`. Ils permettent par exemple d'indiquer des _packages_ supplémentaires à charger, de personnaliser le message d'accueil de `R`, ou de sauvegarder automatiquement les informations de la session lorsqu'on la quitte.
3. `R` prépare l'ouverture de la session avec `R`, avec les informations récupérées précédemment dans les fichiers *environment* et *profile*, et d'autres informations, comme par exemple les données qui ont pu être conservées dans un `.Rdata`. `R` charge les _packages_ de base, avant de charger l'historique des commandes (s'il en existe un). C'est lors de ce dernier temps que `R` peut charger les données et l'historique après s'être interrompu inopinément.

Il peut être nécessaire d'utiliser des configurations de `R` différentes, en fonction des projets sur lesquels vous travaillez. **Les fichiers *environment* et *profile* peuvent donc avoir besoin d'être différents selon les projets.** Pour ce faire, `R` priorise le chargement de ces fichiers dans l'ordre suivant :

1. Les fichiers présents dans le répertoire d'un `Rproject` sont prioritaires ;
2. A défaut, les fichiers présents dans le répertoire _Home_ (sous Windows, ce sera typiquement _Mes documents_) ;
3. A défaut, les fichiers présents dans le répertoire d'installation de `R`.

**Un point important est qu'une session `R` ne charge qu'un seul fichier *environment* et un seul fichier *profile*.** Ajouter un fichier *environment* dans un `Rproject` aura donc pour conséquence que l'éventuel fichier *environment* présent dans le répertoire _Home_ ne sera pas chargé par la session `R` lorsque vous travaillerez sur ce projet.

Enfin, il existe d'autres fichiers comme le `.Rhistory` qui contient l'historique des commandes, notamment celles réalisées à la console. Ce fichier peut également contenir des informations sensibles, il est donc rare de le partager, mais il est possible de le conserver. 


### .Renviron

Le fichier d'environnement `.Renviron` sert à définir des... variables d'environnement ! Ces variables sont utiles à l'interaction entre R et d'autres processus, ou uniquemnent à R. Ces variables d'environnement peuvent également modifier la manière dont R réalise certains calculs. Encore une fois, il ne faut pas faire n'importe quoi !

Par exemple, un `.Renviron` fictif pourrait ressembler à : 

```
MON_API_INSEE=MaCleSecreteVraimentTresSecrete
http_proxy=le_proxy
https_proxy=le_proxy
_R_CHECK_LENGTH_1_LOGIC2_=verbose
_R_CHECK_LENGTH_1_CONDITION_=true


```

Comme vous pouvez le constater, un tel fichier n'est pas constitué de code R, mais de paires **nom=valeur**. Chaque paire définit une variable d'environnement qui sera exploitée par R pour interagir avec d'autres logiciels, ou directement pour lui. Ce fichier fictif réalise les opérations suivantes :

* il définit sa clé d'API dans une variable MON_API_INSEE . Ultérieurement le code pourra faire appel à cette variable via `Sys.getenv("MON_API_INSEE")`. Ce faisant la clé confidentielle n'est pas directement visible dans le code, et ce dernier peut donc être librement partagé sans risque de sécurité. Comme le fichier `.Renviron` peut contenir des informations sensibles, il ne doit pas être partagé (notamment via Git !) ;
* il modifie les paramètres du proxy pour permettre à R de se connecter à Internet&nbsp;;
* il modifie des variables internes à R (`_R_CHECK_LENGTH_1_CONDITION_`  et `_R_CHECK_LENGTH_1_LOGIC2_`)&nbsp;;
* il **contient une ligne vide finale** : cette ligne vide est indispensable, ne l'oubliez jamais !


Pour modifier le fichier `.Renviron`, le plus simple est sans doute de procéder ainsi :

1. Tapez la commande `usethis::edit_r_environ()`, le fichier `.Renviron` de votre profil utilisateur s'ouvrira. Si vous travaillez dans un *RProject*, l'option `scope="project"` permet de définir des options spécifiques à votre projet.
2. Modifiez le fichier, sans oublier la ligne vide en fin de document. Sauvegardez le.
3. Relancez R, via *Session/Restart* ou *Ctrl+Shift+F10*

::: {.remarque data-latex=""}
La modification de variables internes à R est à utiliser avec précaution, car elle est susceptible de générer de la non-reproductibilité. Par exemple, R a un comportement assez étrange dans le cas suivant : 
```{r}
vecteurboolean <- c(TRUE, FALSE, NULL)
if (vecteurboolean) {
  cat("Je suis vrai ! \n")
} else {
  cat("Je suis faux ! \n")
}
```

Lorsqu'il teste un vecteur de booléen, R se contente de tester la première valeur, et met un simple avertissement. Toutefois, avec la modification de `.Renviron` de type `_R_CHECK_LENGTH_1_CONDITION_ = "TRUE"`, il est possible de modifier ce comportement et de générer une erreur (qui stoppera le code), si on fournit à R un vecteur au lieu de fournir un simple scalaire. Le code précédent... n'imprimera donc rien du tout et s’arrêtera avec une erreur chez vous ! Chez un autre utilisateur, il n'y aura pas d'erreur. Vous comprenez mieux les raisons pour lesquels modifier l'environnement peut conduire à des résultats non reproductibles ! 

:::

Il est toutefois possible de modifier les paramètres de son environnement ou en générer d'autres, une fois R chargé, via la commande `Sys.setenv()`. par exemple `Sys.setenv("MON_API_INSEE"="jamais")`. De même la fonction `Sys.getenv()` permet de lister certaines valeurs présentes dans l'environnement actuel. Toutefois, toutes les procédures d'initialisation de R se seront déjà déroulées alors avec les anciennes valeurs, définies par défault. Cette subtilité peut être importante !

::: {.remarque data-latex=""}
La navigation sur Internet depuis un poste de l'Insee, comme dans de nombreuses institutions, est contrôlée par un *proxy* (intermédiaire entre le *web* et un ordinateur) qu'il faut paramétrer pour accéder à Internet.

Pour ce faire, il est recommandé de récupérer l'adresse du proxy interne en réalisant la commande suivante :

```{r,eval=FALSE}
curl::ie_get_proxy_for_url()
```

Puis, vous pourrez mettre à jour votre `.Renviron` via les variables d'environnement `http_proxy`et `https_proxy`.
:::


### .Rprofile

Le fichier `.RProfile` contient du code R qui sera lancé par R après les fichiers `.Renviron`. Typiquement, on peut utiliser ce fichier pour :

* modifier le miroir par défault du CRAN
* modifier le message d'accueil
* personnaliser l'affichage de R

Un fichier `.Rprofile` pourrait typiquement ressembler à quelque chose comme :

```
options(repos = c(CRAN = "https://cran.rstudio.org"))
options(prompt="R> ", digits=4)
options(continue= "+++ ")
if (interactive()) {
options(width = 120)
}

.First <- function(){
cat("\n Allez, hop hop hop, au travail !\n\n")
}
.Last <- function(){
cat("\n Je m'en vais comme un prince...\n\n")
}


```
Ce fichier permet de :

* définir un miroir par défault pour le CRAN ;
* modifier l'affichage de l'invite de commande (le ">" de début de ligne devient "R> ") ;
* modifier l'affichage des nombres décimaux  ;
* modifier l'affichage de la console lorsqu'une partie du code reste à écrire (le "+ " en début de ligne devient "+++ ") ;
* dans le cadre d'un appel à la console, la largeur des impressions est fixée à 120 ;
* les fonctions `.First` et `.Last` permettent d'effectuer des opérations spécifiques au lancement et à la fermeture de la session R (ici imprimer du texte) ;
* Attention, comme précédemment, **un fichier `.Rprofile` doit se terminer par une ligne vierge.** 

Pour voir certaines options aisément modifiables, la fonction `options()` affiche les valeurs actuellement chargées, et il est possible de les modifier à la volée via `options(nom_de_l_option=valeur_de_l_option)`. Attention, la fonction `options()` n'est opérationnelle que sur la session de `R` actuellement active ! Si `R` redemarre, toutes les options modifiées à la volée ne sont plus prises en compte.

Un exemple plus réaliste de `.Rprofile` peut être trouvé [ici](https://github.com/InseeFrLab/utilitR/blob/master/.Rprofile) : c'est le fichier qui permet notamment de réaliser la documentation d'UtilitR. Notez notamment le message à l'ouveture du projet ! Avoir des fonctions n'est pas forcément interdit, tant que ces fonctions sont également partagées, comme c'est le cas dans ce projet !

::: {.conseil data-latex=""}

Il est ainsi fortement déconseillé de réaliser les choses suivantes dans le `.Rprofile`:

* charger des packages ;
* définir des alias de fonctions ;
* modifier le comportement par défault, comme par exemple `options(stringAsFactors=FALSE)` ;

En effet, toute personne sans ce fichier de configuration ne sera pas en mesure de reproduire vos travaux.

Si vous réalisez des opérations spécifiques dans votre `.Rprofile`, il est conseillé de :

* travailler dans le `.Rprofile` d'un projet, et non pas le `.Rprofile` général de votre profil d'utilisateur.
* partager le fichier `.Rprofile` du projet, après avoir vérifié qu'il ne contenait aucune information sensible.

:::

## Quelques bonnes pratiques

La personnalisation de R est une opération sensible qui ne doit pas interférer avec les obligations de reproductibilité des travaux statistiques. Il convient de réserver cette personnalisation à des modifications sans impact sur les calculs et à des informations ayant vocation à ne pas être diffusées : 

* pour des raisons de sécurité : pour séparer les informations sensibles (comme les identifiants d'API ou les paramètres de proxy) du code librement partagé ;
* pour des raisons d'infrastructure : pour modifier les chemins vers des executables, en raison des droits limités sur les machines.


Les autres opérations modifiant le comportement de base (comme `stringAsFactors=FALSE`) doivent être partagées et accessibles.

## Pour en savoir plus

L'immense majorité de la documentation sur cette exploitation de R avancée est en langue anglaise : 

* [Using .Rprofile and .Renviron, by Nicholas Tierney](https://github.com/numbats/resources/blob/b2fdc170277ecebea9a6358d7d222b55a206d70e/rprofile-renviron.Rmd) ;
* [Rstats What they forgot to teach you - chapter 7, by Jennifer Bryan \& Jim Hester](https://rstats.wtf/r-startup.html) ;
* [Managing R with .Rprofile, .Renviron, Rprofile.site, Renviron.site, rsession.conf, and repos.conf by Alex Gold](https://support.rstudio.com/hc/en-us/articles/360047157094-Managing-R-with-Rprofile-Renviron-Rprofile-site-Renviron-site-rsession-conf-and-repos-conf) ;
* [Efficient R Programing - chapter 2.5, by Colin Gillespie \& Robin Lovelace](https://csgillespie.github.io/efficientR/set-up.html#r-startup) ;
* [R for Enterprise: Understanding R’s Startup, by Sean Lopp (RStudio)](https://rviews.rstudio.com/2017/04/19/r-for-enterprise-understanding-r-s-startup/)
